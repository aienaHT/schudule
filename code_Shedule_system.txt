Структура папок:
SchduleSystem внутри:
папка _pycache_
папка startup
папка static

коды:

app.py
import os
import sys
from sqlalchemy import text, and_, or_, not_
from sqlalchemy.orm import joinedload
import random
from datetime import datetime, timedelta
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from flask import Flask, render_template, jsonify, request, session, send_from_directory
from config import Config
from models import db, User, Teacher, Subject, Group, Room, TeacherSubject, AppSettings, GroupSubject, ScheduleEntry, MainScheduleEntry, AutoFillLog, GroupPractice
from auth import init_auth, login_manager
from flask_login import login_required, current_user, login_user, logout_user
from werkzeug.security import generate_password_hash, check_password_hash
import json
from datetime import datetime


def create_app():
    app = Flask(__name__, static_folder='static', template_folder='pages')
    app.config.from_object(Config)
    app.secret_key = 'your-secret-key-change-in-production'
    
    # Инициализация расширений
    db.init_app(app)
    init_auth(app)
    
    # Создание таблиц
    with app.app_context():
        db.create_all()
        create_admin_user()
        populate_initial_data()
    
    # ========== РОУТЫ ДЛЯ HTML СТРАНИЦ ==========
    
    @app.route('/')
    def index():
        return send_from_directory('pages', 'index.html')
    
    @app.route('/admin')
    @login_required
    def admin():
        if current_user.role != 'admin':
            return jsonify({'error': 'Доступ запрещен'}), 403
        return send_from_directory('pages', 'admin.html')
    
    @app.route('/schedule')
    def schedule():
        return send_from_directory('pages', 'schedule.html')
    
    @app.route('/current_schedule')
    @login_required
    def current_schedule():
        if current_user.role != 'admin':
            return jsonify({'error': 'Доступ запрещен'}), 403
        return send_from_directory('pages', 'current_schedule.html')
    
    @app.route('/group_management')
    @login_required
    def group_management():
        if current_user.role != 'admin':
            return jsonify({'error': 'Доступ запрещен'}), 403
        return send_from_directory('pages', 'group_management.html')
    
    @app.route('/login')
    def login_page():
        return send_from_directory('pages', 'login.html')
    
    @app.route('/semester_management')
    @login_required
    def semester_management():
        if current_user.role != 'admin':
            return jsonify({'error': 'Доступ запрещен'}), 403
        return send_from_directory('pages', 'semester_management.html')
    
    @app.route('/statistics')
    @login_required
    def statistics_page():
        if current_user.role != 'admin':
            return jsonify({'error': 'Доступ запрещен'}), 403
        return send_from_directory('pages', 'statistics.html')
    
    @app.route('/teacher_load')
    @login_required
    def teacher_load_page():
        if current_user.role != 'admin':
            return jsonify({'error': 'Доступ запрещен'}), 403
        return send_from_directory('pages', 'teacher_load.html')
    
    # ========== API РОУТЫ ==========
    
    # Аутентификация
    @app.route('/api/login', methods=['POST'])
    def api_login():
        data = request.get_json()
        username = data.get('username')
        password = data.get('password')
        
        user = User.query.filter_by(username=username).first()
        if user and user.check_password(password):
            login_user(user)
            return jsonify({'success': True, 'message': 'Вход выполнен'})
        
        return jsonify({'success': False, 'message': 'Неверные данные'})
    
    @app.route('/api/logout', methods=['POST'])
    @login_required
    def api_logout():
        logout_user()
        return jsonify({'success': True, 'message': 'Выход выполнен'})
    
    @app.route('/api/user_info')
    def api_user_info():
        if current_user.is_authenticated:
            return jsonify({
                'authenticated': True,
                'username': current_user.username,
                'role': current_user.role
            })
        return jsonify({'authenticated': False})
    
    # Основные данные
    @app.route('/api/data/groups')
    def api_get_groups():
        groups = Group.query.order_by(Group.course, Group.name).all()
        return jsonify([{'id': g.id, 'name': g.name, 'course': g.course} for g in groups])
    
    @app.route('/api/data/teachers')
    def api_get_teachers():
        teachers = Teacher.query.order_by(Teacher.name).all()
        return jsonify([{'id': t.id, 'name': t.name} for t in teachers])
    
    @app.route('/api/data/subjects')
    def api_get_subjects():
        subjects = Subject.query.order_by(Subject.name).all()
        return jsonify([{'id': s.id, 'name': s.name} for s in subjects])
    
    @app.route('/api/data/rooms')
    def api_get_rooms():
        rooms = Room.query.order_by(Room.name).all()
        return jsonify([{'id': r.id, 'name': r.name} for r in rooms])
    
    # Добавление группы
    @app.route('/api/data/groups', methods=['POST'])
    @login_required
    def api_add_group():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            name = data.get('name')
            course = data.get('course', 1)
            
            if not name:
                return jsonify({'success': False, 'message': 'Название группы обязательно'})
            
            existing = Group.query.filter_by(name=name).first()
            if existing:
                return jsonify({'success': False, 'message': 'Группа с таким именем уже существует'})
            
            group = Group(name=name, course=course)
            db.session.add(group)
            db.session.commit()
            
            return jsonify({'success': True, 'message': 'Группа добавлена', 'id': group.id})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Удаление группы
    @app.route('/api/group/delete/<int:id>', methods=['DELETE'])
    @login_required
    def api_delete_group(id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            group = Group.query.get(id)
            if group:
                ScheduleEntry.query.filter_by(group_id=group.id).delete()
                MainScheduleEntry.query.filter_by(group_id=group.id).delete()
                GroupSubject.query.filter_by(group_id=group.id).delete()
                GroupPractice.query.filter_by(group_id=group.id).delete()
                
                db.session.delete(group)
                db.session.commit()
                return jsonify({'success': True, 'message': 'Группа удалена'})
            return jsonify({'success': False, 'message': 'Группа не найдена'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Настройки
    @app.route('/api/settings/current')
    def api_get_current_settings():
        week = AppSettings.query.filter_by(key='current_week').first()
        semester = AppSettings.query.filter_by(key='current_semester').first()
        
        return jsonify({
            'week': int(week.value) if week else 1,
            'semester': int(semester.value) if semester else 1
        })
    
    @app.route('/api/settings/set_week', methods=['POST'])
    @login_required
    def api_set_week():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        data = request.get_json()
        week = int(data.get('week', 1))
        
        setting = AppSettings.query.filter_by(key='current_week').first()
        if setting:
            setting.value = str(week)
        else:
            setting = AppSettings(key='current_week', value=str(week))
            db.session.add(setting)
        
        db.session.commit()
        return jsonify({'success': True, 'message': f'Установлена неделя {week}'})
    
    @app.route('/api/settings/set_semester', methods=['POST'])
    @login_required
    def api_set_semester():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        data = request.get_json()
        semester = int(data.get('semester', 1))
        
        setting = AppSettings.query.filter_by(key='current_semester').first()
        if setting:
            setting.value = str(semester)
        else:
            setting = AppSettings(key='current_semester', value=str(semester))
            db.session.add(setting)
        
        db.session.commit()
        return jsonify({'success': True, 'message': f'Установлен семестр {semester}'})
    
    # Текущее расписание
    @app.route('/api/schedule/current')
    def api_get_current_schedule():
        week = request.args.get('week', type=int, default=1)
        semester = request.args.get('semester', type=int, default=1)
        day = request.args.get('day', 'Понедельник')
        
        entries = ScheduleEntry.query.filter_by(
            day=day,
            week_number=week,
            semester=semester
        ).all()
        
        result = []
        for entry in entries:
            pair_num = get_pair_number_by_lesson(entry.day, entry.lesson_number)
            result.append({
                'id': entry.id,
                'group': entry.group.name,
                'subject': entry.subject.name,
                'teacher': entry.teacher.name,
                'room': entry.room.name,
                'day': entry.day,
                'lesson_number': entry.lesson_number,
                'pair': pair_num,
                'time': get_lesson_time(entry.day, entry.lesson_number),
                'is_changed': entry.is_changed
            })
        
        return jsonify(result)
    
    @app.route('/api/schedule/main')
    def api_get_main_schedule():
        semester = request.args.get('semester', type=int, default=1)
        day = request.args.get('day', 'Понедельник')
        week_parity = request.args.get('week_parity', 'both')
        
        query = MainScheduleEntry.query.filter_by(
            day=day,
            semester=semester
        )
        
        if week_parity != 'both':
            query = query.filter(
                (MainScheduleEntry.week_parity == week_parity) |
                (MainScheduleEntry.week_parity == 'both')
            )
        
        entries = query.all()
        
        result = []
        for entry in entries:
            pair_num = get_pair_number_by_lesson(entry.day, entry.lesson_number)
            result.append({
                'id': entry.id,
                'group': entry.group.name,
                'subject': entry.subject.name,
                'teacher': entry.teacher.name,
                'room': entry.room.name,
                'day': entry.day,
                'lesson_number': entry.lesson_number,
                'pair': pair_num,
                'time': get_lesson_time(entry.day, entry.lesson_number),
                'week_parity': entry.week_parity
            })
        
        return jsonify(result)
    
    @app.route('/api/schedule/add', methods=['POST'])
    @login_required
    def api_add_schedule():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            is_main = data.get('is_main', False)
            
            group = Group.query.filter_by(name=data['group']).first()
            subject = Subject.query.filter_by(name=data['subject']).first()
            teacher = Teacher.query.filter_by(name=data['teacher']).first()
            room = Room.query.filter_by(name=data['room']).first()
            
            if not all([group, subject, teacher, room]):
                return jsonify({'success': False, 'message': 'Не найдены объекты'})
            
            day = data['day']
            lesson_number = int(data['lesson_number'])
            
            if day in ["Понедельник", "Четверг"] and lesson_number == 0 and subject.name != "Разговоры о важном":
                return jsonify({'success': False, 'message': 'На 0 урок можно поставить только "Разговоры о важном"'})
            
            if is_main:
                conflict = MainScheduleEntry.query.filter_by(
                    group_id=group.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    semester=int(data.get('semester', 1))
                ).first()
            else:
                conflict = ScheduleEntry.query.filter_by(
                    group_id=group.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    week_number=int(data.get('week', 1)),
                    semester=int(data.get('semester', 1))
                ).first()
            
            if conflict:
                return jsonify({'success': False, 'message': 'Конфликт расписания'})
            
            if is_main:
                entry = MainScheduleEntry(
                    group_id=group.id,
                    subject_id=subject.id,
                    teacher_id=teacher.id,
                    room_id=room.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    week_parity=data.get('week_parity', 'both'),
                    semester=int(data.get('semester', 1))
                )
            else:
                entry = ScheduleEntry(
                    group_id=group.id,
                    subject_id=subject.id,
                    teacher_id=teacher.id,
                    room_id=room.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    week_number=int(data.get('week', 1)),
                    semester=int(data.get('semester', 1)),
                    is_changed=True
                )
            
            db.session.add(entry)
            db.session.commit()
            
            return jsonify({'success': True, 'message': 'Добавлено', 'id': entry.id})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    @app.route('/api/schedule/delete/<int:id>', methods=['DELETE'])
    @login_required
    def api_delete_schedule(id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            entry = ScheduleEntry.query.get(id)
            if entry:
                db.session.delete(entry)
                db.session.commit()
                return jsonify({'success': True, 'message': 'Удалено'})
            return jsonify({'success': False, 'message': 'Не найдено'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    @app.route('/api/schedule/main/delete/<int:id>', methods=['DELETE'])
    @login_required
    def api_delete_main_schedule(id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            entry = MainScheduleEntry.query.get(id)
            if entry:
                db.session.delete(entry)
                db.session.commit()
                return jsonify({'success': True, 'message': 'Удалено'})
            return jsonify({'success': False, 'message': 'Не найдено'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    @app.route('/api/schedule/update/<int:id>', methods=['PUT'])
    @login_required
    def api_update_schedule(id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            entry = ScheduleEntry.query.get(id)
            
            if not entry:
                return jsonify({'success': False, 'message': 'Запись не найдена'})
            
            if 'subject' in data:
                subject = Subject.query.filter_by(name=data['subject']).first()
                if subject:
                    entry.subject_id = subject.id
            
            if 'teacher' in data:
                teacher = Teacher.query.filter_by(name=data['teacher']).first()
                if teacher:
                    entry.teacher_id = teacher.id
            
            if 'room' in data:
                room = Room.query.filter_by(name=data['room']).first()
                if room:
                    entry.room_id = room.id
            
            entry.is_changed = True
            db.session.commit()
            
            return jsonify({'success': True, 'message': 'Обновлено'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Управление группами - получение предметов группы
    @app.route('/api/group/<int:group_id>/subjects')
    @login_required
    def api_get_group_subjects(group_id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        group = Group.query.get_or_404(group_id)
        subjects = GroupSubject.query.filter_by(group_id=group_id).all()
        
        result = []
        for gs in subjects:
            result.append({
                'id': gs.id,
                'subject_id': gs.subject_id,
                'subject_name': gs.subject.name,
                'teacher_id': gs.teacher_id,
                'teacher_name': gs.teacher.name if gs.teacher else None,
                'hours_per_week': gs.hours_per_week,
                'total_hours_semester1': gs.total_hours_semester1,
                'total_hours_semester2': gs.total_hours_semester2
            })
        
        # Получаем информацию о практике
        practice = GroupPractice.query.filter_by(group_id=group_id).first()
        practice_info = {
            'has_practice': bool(practice),
            'practice_day': practice.day if practice else None,
            'practice_subject': practice.subject.name if practice and practice.subject else None,
            'practice_teacher': practice.teacher.name if practice and practice.teacher else None,
            'practice_room': practice.room.name if practice and practice.room else None
        } if practice else {'has_practice': False}
        
        return jsonify({
            'group_id': group.id,
            'group_name': group.name,
            'course': group.course,
            'subjects': result,
            'practice': practice_info
        })
    
    @app.route('/api/group/subject/add', methods=['POST'])
    @login_required
    def api_add_group_subject():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            group_id = data['group_id']
            subject_id = data['subject_id']
            teacher_id = data.get('teacher_id')
            hours_per_week = data.get('hours_per_week', 0)
            total_hours_semester1 = data.get('total_hours_semester1', 0)
            total_hours_semester2 = data.get('total_hours_semester2', 0)
            
            existing = GroupSubject.query.filter_by(
                group_id=group_id,
                subject_id=subject_id
            ).first()
            
            if existing:
                existing.teacher_id = teacher_id
                existing.hours_per_week = hours_per_week
                existing.total_hours_semester1 = total_hours_semester1
                existing.total_hours_semester2 = total_hours_semester2
            else:
                gs = GroupSubject(
                    group_id=group_id,
                    subject_id=subject_id,
                    teacher_id=teacher_id,
                    hours_per_week=hours_per_week,
                    total_hours_semester1=total_hours_semester1,
                    total_hours_semester2=total_hours_semester2
                )
                db.session.add(gs)
            
            db.session.commit()
            return jsonify({'success': True, 'message': 'Сохранено'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    @app.route('/api/group/subject/delete/<int:id>', methods=['DELETE'])
    @login_required
    def api_delete_group_subject(id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            gs = GroupSubject.query.get(id)
            if gs:
                db.session.delete(gs)
                db.session.commit()
                return jsonify({'success': True, 'message': 'Удалено'})
            return jsonify({'success': False, 'message': 'Не найдено'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Обновление часов предмета группы
    @app.route('/api/group/subject/update_hours/<int:id>', methods=['PUT'])
    @login_required
    def api_update_group_subject_hours(id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            hours_per_week = data.get('hours_per_week', 0)
            total_hours_semester1 = data.get('total_hours_semester1', 0)
            total_hours_semester2 = data.get('total_hours_semester2', 0)
            
            gs = GroupSubject.query.get(id)
            if not gs:
                return jsonify({'success': False, 'message': 'Запись не найдена'})
            
            gs.hours_per_week = hours_per_week
            gs.total_hours_semester1 = total_hours_semester1
            gs.total_hours_semester2 = total_hours_semester2
            
            db.session.commit()
            
            return jsonify({'success': True, 'message': 'Часы обновлены'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Добавление/обновление практики для группы
    @app.route('/api/group/practice', methods=['POST'])
    @login_required
    def api_set_group_practice():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            group_id = data['group_id']
            day = data['day']
            subject_id = data.get('subject_id')
            teacher_id = data.get('teacher_id')
            room_id = data.get('room_id')
            
            practice = GroupPractice.query.filter_by(group_id=group_id).first()
            
            if practice:
                practice.day = day
                practice.subject_id = subject_id
                practice.teacher_id = teacher_id
                practice.room_id = room_id
            else:
                practice = GroupPractice(
                    group_id=group_id,
                    day=day,
                    subject_id=subject_id,
                    teacher_id=teacher_id,
                    room_id=room_id
                )
                db.session.add(practice)
            
            db.session.commit()
            return jsonify({'success': True, 'message': 'Практика назначена'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    @app.route('/api/group/practice/delete/<int:group_id>', methods=['DELETE'])
    @login_required
    def api_delete_group_practice(group_id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            practice = GroupPractice.query.filter_by(group_id=group_id).first()
            if practice:
                db.session.delete(practice)
                db.session.commit()
                return jsonify({'success': True, 'message': 'Практика удалена'})
            return jsonify({'success': False, 'message': 'Практика не найдена'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Автозаполнение расписания
    @app.route('/api/schedule/autofill', methods=['POST'])
    @login_required
    def api_autofill_schedule():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            week = data.get('week', get_current_week())
            semester = data.get('semester', get_current_semester())
            fill_type = data.get('type', 'both')  # 'current', 'main', 'both'
            
            result = auto_fill_schedule(week, semester, fill_type)
            
            return jsonify({
                'success': True,
                'message': 'Расписание успешно заполнено',
                'details': result
            })
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Статистика (обновленная с учетом часов)
    @app.route('/api/statistics')
    @login_required
    def api_get_statistics():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        week = request.args.get('week', type=int, default=1)
        semester = request.args.get('semester', type=int, default=1)
        
        # Статистика по группам (с часами)
        groups = Group.query.all()
        group_stats = []
        
        for group in groups:
            entries = ScheduleEntry.query.filter_by(
                group_id=group.id,
                week_number=week,
                semester=semester
            ).all()
            
            changed = sum(1 for e in entries if e.is_changed)
            main = len(entries) - changed
            
            # Часы из GroupSubject
            group_subjects = GroupSubject.query.filter_by(group_id=group.id).all()
            total_hours = sum(gs.hours_per_week for gs in group_subjects)
            
            # Часы проведено и осталось
            completed_hours = len(entries) * 2  # 1 пара = 2 часа
            remaining_hours = max(0, total_hours - completed_hours)
            
            group_stats.append({
                'group_name': group.name,
                'course': group.course,
                'total_lessons': len(entries),
                'changed_lessons': changed,
                'main_lessons': main,
                'total_hours': total_hours,
                'completed_hours': completed_hours,
                'remaining_hours': remaining_hours,
                'progress': int((completed_hours / total_hours) * 100) if total_hours > 0 else 0
            })
        
        # Статистика по преподавателям (с часами)
        teachers = Teacher.query.all()
        teacher_stats = []
        
        for teacher in teachers:
            entries = ScheduleEntry.query.filter_by(
                teacher_id=teacher.id,
                week_number=week,
                semester=semester
            ).all()
            
            teacher_stats.append({
                'teacher_name': teacher.name,
                'total_lessons': len(entries)
            })
        
        # Общая статистика
        total_lessons = sum(g['total_lessons'] for g in group_stats)
        total_completed_hours = sum(g['completed_hours'] for g in group_stats)
        total_remaining_hours = sum(g['remaining_hours'] for g in group_stats)
        
        return jsonify({
            'week': week,
            'semester': semester,
            'total_lessons': total_lessons,
            'total_completed_hours': total_completed_hours,
            'total_remaining_hours': total_remaining_hours,
            'group_stats': group_stats,
            'teacher_stats': teacher_stats
        })
    
    # Полная статистика с детализацией
    @app.route('/api/statistics/full')
    @login_required
    def api_get_full_statistics():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        week = request.args.get('week', type=int, default=1)
        semester = request.args.get('semester', type=int, default=1)
        
        # Статистика по группам (с часами)
        groups = Group.query.all()
        group_stats = []
        
        for group in groups:
            # Занятия в расписании
            entries = ScheduleEntry.query.filter_by(
                group_id=group.id,
                week_number=week,
                semester=semester
            ).all()
            
            changed = sum(1 for e in entries if e.is_changed)
            main = len(entries) - changed
            
            # Часы из GroupSubject
            group_subjects = GroupSubject.query.filter_by(group_id=group.id).all()
            total_hours = sum(gs.hours_per_week for gs in group_subjects)
            
            # Часы проведено и осталось
            completed_hours = len(entries) * 2  # 1 пара = 2 часа
            remaining_hours = max(0, total_hours - completed_hours)
            
            # Детали по предметам
            subjects_detail = []
            for gs in group_subjects:
                subjects_detail.append({
                    'subject_name': gs.subject.name,
                    'teacher_name': gs.teacher.name if gs.teacher else 'Не назначен',
                    'hours_per_week': gs.hours_per_week,
                    'total_hours_semester1': gs.total_hours_semester1,
                    'total_hours_semester2': gs.total_hours_semester2
                })
            
            group_stats.append({
                'group_name': group.name,
                'course': group.course,
                'total_lessons': len(entries),
                'changed_lessons': changed,
                'main_lessons': main,
                'total_hours': total_hours,
                'completed_hours': completed_hours,
                'remaining_hours': remaining_hours,
                'progress': int((completed_hours / total_hours) * 100) if total_hours > 0 else 0,
                'subjects': subjects_detail
            })
        
        # Статистика по преподавателям (с часами)
        teachers = Teacher.query.all()
        teacher_stats = []
        
        for teacher in teachers:
            # Занятия в расписании
            entries = ScheduleEntry.query.filter_by(
                teacher_id=teacher.id,
                week_number=week,
                semester=semester
            ).all()
            
            # Часы из GroupSubject
            teacher_subjects = GroupSubject.query.filter_by(teacher_id=teacher.id).all()
            total_hours = sum(ts.hours_per_week for ts in teacher_subjects)
            
            # Детали по группам
            groups_detail = []
            for ts in teacher_subjects:
                groups_detail.append({
                    'group_name': ts.group.name,
                    'subject_name': ts.subject.name,
                    'hours_per_week': ts.hours_per_week
                })
            
            teacher_stats.append({
                'teacher_name': teacher.name,
                'total_lessons': len(entries),
                'total_hours': total_hours,
                'groups': groups_detail
            })
        
        # Суммарная статистика
        total_groups_hours = sum(g['total_hours'] for g in group_stats)
        total_teachers_hours = sum(t['total_hours'] for t in teacher_stats)
        total_completed_hours = sum(g['completed_hours'] for g in group_stats)
        total_remaining_hours = sum(g['remaining_hours'] for g in group_stats)
        
        return jsonify({
            'success': True,
            'week': week,
            'semester': semester,
            'total_groups_hours': total_groups_hours,
            'total_teachers_hours': total_teachers_hours,
            'total_completed_hours': total_completed_hours,
            'total_remaining_hours': total_remaining_hours,
            'group_stats': group_stats,
            'teacher_stats': teacher_stats
        })
    
    # Логи автозаполнения
    @app.route('/api/autofill/logs')
    @login_required
    def api_get_autofill_logs():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        logs = AutoFillLog.query.order_by(AutoFillLog.created_at.desc()).limit(50).all()
        
        result = []
        for log in logs:
            result.append({
                'id': log.id,
                'week': log.week_number,
                'semester': log.semester,
                'type': log.fill_type,
                'entries_added': log.entries_added,
                'conflicts': log.conflicts,
                'errors': log.errors,
                'created_at': log.created_at.strftime('%Y-%m-%d %H:%M:%S')
            })
        
        return jsonify({'success': True, 'logs': result})
    
    # Получить доступные пары для дня
    @app.route('/api/pairs/<day>')
    def api_get_pairs_for_day(day):
        pairs = get_available_pairs_for_day(day)
        result = []
        
        for pair_num in pairs:
            result.append({
                'pair': pair_num,
                'name': get_pair_name(pair_num),
                'lessons': get_lessons_in_pair(day, pair_num),
                'time': get_pair_time(day, pair_num)
            })
        
        return jsonify(result)
    
    # Получить уроки в паре
    @app.route('/api/pair/<day>/<int:pair>/lessons')
    def api_get_lessons_in_pair(day, pair):
        lessons = get_lessons_in_pair(day, pair)
        result = []
        
        for lesson_num in lessons:
            result.append({
                'lesson': lesson_num,
                'time': get_lesson_time(day, lesson_num)
            })
        
        return jsonify(result)
    
    # Переход на следующую неделю
    @app.route('/api/next_week', methods=['POST'])
    @login_required
    def api_next_week():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            current_week = get_current_week()
            next_week = current_week + 1
            
            setting = AppSettings.query.filter_by(key='current_week').first()
            if setting:
                setting.value = str(next_week)
            else:
                setting = AppSettings(key='current_week', value=str(next_week))
                db.session.add(setting)
            
            current_semester = get_current_semester()
            update_current_schedule_from_main(next_week, current_semester)
            
            db.session.commit()
            
            return jsonify({'success': True, 'message': f'Перешли на неделю {next_week}'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Очистка текущей недели
    @app.route('/api/clear_week', methods=['POST'])
    @login_required
    def api_clear_week():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            current_week = get_current_week()
            current_semester = get_current_semester()
            
            ScheduleEntry.query.filter_by(
                week_number=current_week,
                semester=current_semester
            ).delete()
            
            update_current_schedule_from_main(current_week, current_semester)
            
            db.session.commit()
            return jsonify({'success': True, 'message': f'Неделя {current_week} очищена и заполнена из основного расписания'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Переход на следующий семестр
    @app.route('/api/next_semester', methods=['POST'])
    @login_required
    def api_next_semester():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            current_semester = get_current_semester()
            next_semester = 2 if current_semester == 1 else 1
            
            setting = AppSettings.query.filter_by(key='current_semester').first()
            if setting:
                setting.value = str(next_semester)
            else:
                setting = AppSettings(key='current_semester', value=str(next_semester))
                db.session.add(setting)
            
            week_setting = AppSettings.query.filter_by(key='current_week').first()
            if week_setting:
                week_setting.value = '1'
            else:
                week_setting = AppSettings(key='current_week', value='1')
                db.session.add(week_setting)
            
            ScheduleEntry.query.filter_by(semester=next_semester).delete()
            
            db.session.commit()
            return jsonify({'success': True, 'message': f'Перешли на {next_semester} семестр'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': str(e)})
    
    # Получение статистики по семестрам
    @app.route('/api/semester_stats')
    @login_required
    def api_get_semester_stats():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            semester_stats = {}
            
            for semester in [1, 2]:
                total_entries = ScheduleEntry.query.filter_by(semester=semester).count()
                main_entries = MainScheduleEntry.query.filter_by(semester=semester).count()
                
                semester_stats[semester] = {
                    'name': 'Осенний семестр' if semester == 1 else 'Весенний семестр',
                    'entries_count': total_entries,
                    'main_entries_count': main_entries,
                    'weeks': 52
                }
            
            current_week = get_current_week()
            current_semester = get_current_semester()
            
            return jsonify({
                'current_week': current_week,
                'current_semester': current_semester,
                'semester_stats': semester_stats,
                'max_weeks': 52
            })
            
        except Exception as e:
            return jsonify({'success': False, 'message': str(e)})
    
    # Нагрузка преподавателей
    @app.route('/api/teacher_load')
    @login_required
    def api_get_teacher_load():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            teacher_load = []
            
            teachers = Teacher.query.all()
            for teacher in teachers:
                total_pairs = ScheduleEntry.query.filter_by(teacher_id=teacher.id).count()
                
                teacher_load.append({
                    'teacher_id': teacher.id,
                    'teacher_name': teacher.name,
                    'total_pairs': total_pairs,
                    'total_hours': total_pairs * 2
                })
            
            return jsonify({
                'success': True,
                'teacher_load': teacher_load
            })
            
        except Exception as e:
            return jsonify({'success': False, 'message': str(e)})
    
    # Проверка расписания на конфликты
    @app.route('/api/schedule/check_conflicts')
    @login_required
    def api_check_conflicts():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            week = request.args.get('week', type=int, default=get_current_week())
            semester = request.args.get('semester', type=int, default=get_current_semester())
            
            conflicts = check_schedule_conflicts(week, semester)
            
            return jsonify({
                'success': True,
                'conflicts': conflicts,
                'has_conflicts': len(conflicts) > 0
            })
            
        except Exception as e:
            return jsonify({'success': False, 'message': str(e)})
    
    return app

# ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========

def get_pair_number_by_lesson(day, lesson_number):
    """Определить номер пары по дню и номеру урока"""
    if lesson_number == 0:
        return 0
    elif day == "Суббота":
        if lesson_number in [1, 2]:
            return 1
        elif lesson_number in [3, 4]:
            return 2
        elif lesson_number in [5, 6]:
            return 3
        elif lesson_number in [7, 8]:
            return 4
    else:
        if lesson_number in [1, 2]:
            return 1
        elif lesson_number in [3, 4]:
            return 2
        elif lesson_number in [5, 6]:
            return 3
        elif lesson_number in [7, 8]:
            return 4
        elif lesson_number in [9, 10]:
            return 5
        elif lesson_number in [11, 12]:
            return 6
    return 0

def get_available_pairs_for_day(day):
    """Получить доступные пары для дня"""
    if day == "Суббота":
        return [1, 2, 3, 4]
    elif day in ["Понедельник", "Четверг"]:
        return [0, 1, 2, 3, 4, 5, 6]
    else:
        return [1, 2, 3, 4, 5, 6]

def get_lessons_in_pair(day, pair):
    """Получить номера уроков в паре"""
    if pair == 0:
        return [0]
    elif pair == 1:
        return [1, 2]
    elif pair == 2:
        return [3, 4]
    elif pair == 3:
        return [5, 6]
    elif pair == 4:
        return [7, 8]
    elif pair == 5:
        return [9, 10]
    elif pair == 6:
        return [11, 12]
    return []

def get_pair_name(pair):
    """Получить название пары"""
    return f"Пара {pair}"

def get_pair_time(day, pair):
    """Получить время пары"""
    if pair == 0:
        return "8:30-9:10"
    elif pair == 1:
        if day == "Суббота":
            return "8:00-9:25"
        elif day in ["Понедельник", "Четверг"]:
            return "9:15-10:40"
        else:
            return "8:30-9:55"
    elif pair == 2:
        if day == "Суббота":
            return "9:30-10:55"
        elif day in ["Понедельник", "Четверг"]:
            return "11:20-12:45"
        else:
            return "10:35-12:00"
    elif pair == 3:
        if day == "Суббота":
            return "11:00-12:25"
        elif day in ["Понедельник", "Четверг"]:
            return "13:25-14:50"
        else:
            return "12:40-14:05"
    elif pair == 4:
        if day == "Суббота":
            return "12:30-13:55"
        elif day in ["Понедельник", "Четверг"]:
            return "15:00-16:25"
        else:
            return "14:15-15:40"
    elif pair == 5:
        if day in ["Понедельник", "Четверг"]:
            return "16:30-17:55"
        else:
            return "15:45-17:10"
    elif pair == 6:
        if day in ["Понедельник", "Четверг"]:
            return "18:00-19:25"
        else:
            return "17:15-18:40"
    return ""

def get_lesson_time(day, lesson_number):
    """Получить время конкретного урока"""
    pair = get_pair_number_by_lesson(day, lesson_number)
    return get_pair_time(day, pair)

def get_current_week():
    """Получить текущую неделю из настроек"""
    setting = AppSettings.query.filter_by(key='current_week').first()
    if setting:
        return int(setting.value)
    return 1

def get_current_semester():
    """Получить текущий семестр из настроек"""
    setting = AppSettings.query.filter_by(key='current_semester').first()
    if setting:
        return int(setting.value)
    return 1

def update_current_schedule_from_main(week_number, semester):
    """Обновить текущее расписание из основного"""
    ScheduleEntry.query.filter_by(
        week_number=week_number,
        semester=semester
    ).delete()
    
    week_parity = 'even' if week_number % 2 == 0 else 'odd'
    
    main_entries = MainScheduleEntry.query.filter_by(
        semester=semester
    ).filter(
        (MainScheduleEntry.week_parity == 'both') |
        (MainScheduleEntry.week_parity == week_parity)
    ).all()
    
    for main_entry in main_entries:
        schedule_entry = ScheduleEntry(
            group_id=main_entry.group_id,
            subject_id=main_entry.subject_id,
            teacher_id=main_entry.teacher_id,
            room_id=main_entry.room_id,
            day=main_entry.day,
            lesson_number=main_entry.lesson_number,
            week_number=week_number,
            week_parity=main_entry.week_parity,
            semester=semester,
            is_changed=False
        )
        db.session.add(schedule_entry)

def check_schedule_conflicts(week, semester):
    """Проверить расписание на конфликты"""
    conflicts = []
    
    # Проверка: один учитель не может вести одновременно в двух группах
    entries = ScheduleEntry.query.filter_by(
        week_number=week,
        semester=semester
    ).all()
    
    # Группируем по дням, урокам и преподавателям
    teacher_conflicts = {}
    for entry in entries:
        key = (entry.day, entry.lesson_number, entry.teacher_id)
        if key not in teacher_conflicts:
            teacher_conflicts[key] = []
        teacher_conflicts[key].append(entry)
    
    for key, entries_list in teacher_conflicts.items():
        if len(entries_list) > 1:
            conflicts.append({
                'type': 'teacher_conflict',
                'day': key[0],
                'lesson_number': key[1],
                'teacher': entries_list[0].teacher.name,
                'groups': [e.group.name for e in entries_list],
                'message': f'Преподаватель {entries_list[0].teacher.name} ведет одновременно в группах: {", ".join([e.group.name for e in entries_list])}'
            })
    
    # Проверка: одна группа не может быть в двух местах одновременно
    group_conflicts = {}
    for entry in entries:
        key = (entry.day, entry.lesson_number, entry.group_id)
        if key not in group_conflicts:
            group_conflicts[key] = []
        group_conflicts[key].append(entry)
    
    for key, entries_list in group_conflicts.items():
        if len(entries_list) > 1:
            conflicts.append({
                'type': 'group_conflict',
                'day': key[0],
                'lesson_number': key[1],
                'group': entries_list[0].group.name,
                'subjects': [e.subject.name for e in entries_list],
                'message': f'Группа {entries_list[0].group.name} имеет {len(entries_list)} занятия одновременно'
            })
    
    # Проверка: одна аудитория не может быть занята двумя группами
    room_conflicts = {}
    for entry in entries:
        key = (entry.day, entry.lesson_number, entry.room_id)
        if key not in room_conflicts:
            room_conflicts[key] = []
        room_conflicts[key].append(entry)
    
    for key, entries_list in room_conflicts.items():
        if len(entries_list) > 1:
            conflicts.append({
                'type': 'room_conflict',
                'day': key[0],
                'lesson_number': key[1],
                'room': entries_list[0].room.name,
                'groups': [e.group.name for e in entries_list],
                'message': f'Аудитория {entries_list[0].room.name} занята {len(entries_list)} группами одновременно'
            })
    
    return conflicts

def auto_fill_schedule(week, semester, fill_type='both'):
    """Автоматическое заполнение расписания без дырок"""
    
    log_entry = AutoFillLog(
        week_number=week,
        semester=semester,
        fill_type=fill_type,
        entries_added=0,
        conflicts=0,
        errors=0
    )
    db.session.add(log_entry)
    
    try:
        # Очищаем текущее расписание если нужно
        if fill_type in ['current', 'both']:
            ScheduleEntry.query.filter_by(
                week_number=week,
                semester=semester
            ).delete()
        
        if fill_type in ['main', 'both']:
            MainScheduleEntry.query.filter_by(semester=semester).delete()
        
        # Получаем все группы
        groups = Group.query.order_by(Group.course, Group.name).all()
        
        # Дни недели
        days = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"]
        
        # Для каждой группы создаем расписание
        for group in groups:
            # Получаем предметы группы
            group_subjects = GroupSubject.query.filter_by(group_id=group.id).all()
            
            # Получаем практику группы если есть
            practice = GroupPractice.query.filter_by(group_id=group.id).first()
            
            # Создаем список для распределения часов
            subjects_to_schedule = []
            for gs in group_subjects:
                for _ in range(gs.hours_per_week // 2):  # Добавляем по 2 часа (одна пара)
                    subjects_to_schedule.append({
                        'subject_id': gs.subject_id,
                        'teacher_id': gs.teacher_id,
                        'subject_name': gs.subject.name,
                        'teacher_name': gs.teacher.name if gs.teacher else None
                    })
            
            # Перемешиваем для случайного распределения
            random.shuffle(subjects_to_schedule)
            
            # Распределяем по дням
            current_day_index = 0
            current_lesson = 0
            
            # Сначала размещаем практику если есть
            if practice and practice.day in days:
                practice_day_index = days.index(practice.day)
                # Ставим практику на весь день (пары 1-4 для 2-4 курсов)
                max_pairs = 4 if group.course >= 2 else 2
                
                for pair in range(1, max_pairs + 1):
                    lessons = get_lessons_in_pair(practice.day, pair)
                    for lesson in lessons:
                        # Проверяем возможность поставить занятие
                        if can_schedule_lesson(
                            group.id, practice.subject_id, practice.teacher_id, practice.room_id,
                            practice.day, lesson, week, semester, fill_type
                        ):
                            if fill_type in ['main', 'both']:
                                entry = MainScheduleEntry(
                                    group_id=group.id,
                                    subject_id=practice.subject_id,
                                    teacher_id=practice.teacher_id,
                                    room_id=practice.room_id,
                                    day=practice.day,
                                    lesson_number=lesson,
                                    week_parity='both',
                                    semester=semester
                                )
                                db.session.add(entry)
                            
                            if fill_type in ['current', 'both']:
                                entry = ScheduleEntry(
                                    group_id=group.id,
                                    subject_id=practice.subject_id,
                                    teacher_id=practice.teacher_id,
                                    room_id=practice.room_id,
                                    day=practice.day,
                                    lesson_number=lesson,
                                    week_number=week,
                                    semester=semester,
                                    is_changed=False
                                )
                                db.session.add(entry)
                            
                            log_entry.entries_added += 1
            
            # Распределяем обычные предметы
            for subject_data in subjects_to_schedule:
                placed = False
                attempts = 0
                max_attempts = len(days) * 10  # Максимальное количество попыток
                
                while not placed and attempts < max_attempts:
                    day = days[current_day_index % len(days)]
                    
                    # Пропускаем день практики для 2-4 курсов
                    if practice and group.course >= 2 and day == practice.day:
                        current_day_index += 1
                        attempts += 1
                        continue
                    
                    # Получаем доступные пары для дня
                    available_pairs = get_available_pairs_for_day(day)
                    
                    # Для понедельника и четверга начинаем с 0 урока для "Разговоры о важном"
                    if day in ["Понедельник", "Четверг"] and subject_data['subject_name'] == "Разговоры о важном":
                        lesson = 0
                    else:
                        # Выбираем случайную пару
                        pair = random.choice(available_pairs)
                        # Пропускаем 0 пару если это не "Разговоры о важном"
                        if pair == 0:
                            current_day_index += 1
                            attempts += 1
                            continue
                        
                        lessons = get_lessons_in_pair(day, pair)
                        lesson = random.choice(lessons)
                    
                    # Получаем свободную аудиторию
                    room = get_available_room(day, lesson, week, semester, fill_type)
                    
                    if room and subject_data['teacher_id']:
                        if can_schedule_lesson(
                            group.id, subject_data['subject_id'], subject_data['teacher_id'], room.id,
                            day, lesson, week, semester, fill_type
                        ):
                            if fill_type in ['main', 'both']:
                                entry = MainScheduleEntry(
                                    group_id=group.id,
                                    subject_id=subject_data['subject_id'],
                                    teacher_id=subject_data['teacher_id'],
                                    room_id=room.id,
                                    day=day,
                                    lesson_number=lesson,
                                    week_parity='both',
                                    semester=semester
                                )
                                db.session.add(entry)
                            
                            if fill_type in ['current', 'both']:
                                entry = ScheduleEntry(
                                    group_id=group.id,
                                    subject_id=subject_data['subject_id'],
                                    teacher_id=subject_data['teacher_id'],
                                    room_id=room.id,
                                    day=day,
                                    lesson_number=lesson,
                                    week_number=week,
                                    semester=semester,
                                    is_changed=False
                                )
                                db.session.add(entry)
                            
                            log_entry.entries_added += 1
                            placed = True
                    
                    current_day_index += 1
                    attempts += 1
                
                if not placed:
                    log_entry.errors += 1
        
        db.session.commit()
        
        # Проверяем конфликты
        conflicts = check_schedule_conflicts(week, semester)
        log_entry.conflicts = len(conflicts)
        
        db.session.commit()
        
        return {
            'entries_added': log_entry.entries_added,
            'conflicts': len(conflicts),
            'errors': log_entry.errors,
            'has_conflicts': len(conflicts) > 0
        }
        
    except Exception as e:
        db.session.rollback()
        log_entry.errors += 1
        db.session.commit()
        raise e

def can_schedule_lesson(group_id, subject_id, teacher_id, room_id, day, lesson, week, semester, fill_type):
    """Проверить, можно ли поставить занятие"""
    
    # Проверка для основного расписания
    if fill_type in ['main', 'both']:
        conflict = MainScheduleEntry.query.filter(
            or_(
                and_(
                    MainScheduleEntry.group_id == group_id,
                    MainScheduleEntry.day == day,
                    MainScheduleEntry.lesson_number == lesson,
                    MainScheduleEntry.semester == semester
                ),
                and_(
                    MainScheduleEntry.teacher_id == teacher_id,
                    MainScheduleEntry.day == day,
                    MainScheduleEntry.lesson_number == lesson,
                    MainScheduleEntry.semester == semester
                ),
                and_(
                    MainScheduleEntry.room_id == room_id,
                    MainScheduleEntry.day == day,
                    MainScheduleEntry.lesson_number == lesson,
                    MainScheduleEntry.semester == semester
                )
            )
        ).first()
        
        if conflict:
            return False
    
    # Проверка для текущего расписания
    if fill_type in ['current', 'both']:
        conflict = ScheduleEntry.query.filter(
            or_(
                and_(
                    ScheduleEntry.group_id == group_id,
                    ScheduleEntry.day == day,
                    ScheduleEntry.lesson_number == lesson,
                    ScheduleEntry.week_number == week,
                    ScheduleEntry.semester == semester
                ),
                and_(
                    ScheduleEntry.teacher_id == teacher_id,
                    ScheduleEntry.day == day,
                    ScheduleEntry.lesson_number == lesson,
                    ScheduleEntry.week_number == week,
                    ScheduleEntry.semester == semester
                ),
                and_(
                    ScheduleEntry.room_id == room_id,
                    ScheduleEntry.day == day,
                    ScheduleEntry.lesson_number == lesson,
                    ScheduleEntry.week_number == week,
                    ScheduleEntry.semester == semester
                )
            )
        ).first()
        
        if conflict:
            return False
    
    return True

def get_available_room(day, lesson, week, semester, fill_type):
    """Получить свободную аудиторию"""
    rooms = Room.query.all()
    
    for room in rooms:
        available = True
        
        # Проверка для основного расписания
        if fill_type in ['main', 'both']:
            conflict = MainScheduleEntry.query.filter_by(
                room_id=room.id,
                day=day,
                lesson_number=lesson,
                semester=semester
            ).first()
            
            if conflict:
                available = False
        
        # Проверка для текущего расписания
        if fill_type in ['current', 'both']:
            conflict = ScheduleEntry.query.filter_by(
                room_id=room.id,
                day=day,
                lesson_number=lesson,
                week_number=week,
                semester=semester
            ).first()
            
            if conflict:
                available = False
        
        if available:
            return room
    
    return None

def create_admin_user():
    """Создать администратора"""
    if not User.query.filter_by(username='admin').first():
        admin = User(username='admin', role='admin')
        admin.set_password('admin123')
        db.session.add(admin)
        db.session.commit()

def populate_initial_data():
    """Заполнить начальные данные"""
    from initial_data import TEACHER_INITIAL_LOAD, SUBJECTS, GROUPS, ROOMS
    
    # Создаем таблицу group_subject если она не существует
    from sqlalchemy import inspect
    inspector = inspect(db.engine)
    
    if 'group_subject' not in inspector.get_table_names():
        print("Создаем таблицу group_subject...")
        GroupSubject.__table__.create(db.engine)
    
    if 'group_practice' not in inspector.get_table_names():
        print("Создаем таблицу group_practice...")
        GroupPractice.__table__.create(db.engine)
    
    # Заполняем данные
    for teacher_name in TEACHER_INITIAL_LOAD.keys():
        if not Teacher.query.filter_by(name=teacher_name).first():
            db.session.add(Teacher(name=teacher_name))
    
    for subject_name in SUBJECTS:
        if not Subject.query.filter_by(name=subject_name).first():
            db.session.add(Subject(name=subject_name))
    
    for group_name in GROUPS:
        if not Group.query.filter_by(name=group_name).first():
            course = int(group_name[0]) if group_name[0].isdigit() else 1
            db.session.add(Group(name=group_name, course=course))
    
    for room_name in ROOMS:
        if not Room.query.filter_by(name=room_name).first():
            db.session.add(Room(name=room_name))
    
    if not AppSettings.query.filter_by(key='current_week').first():
        db.session.add(AppSettings(key='current_week', value='1'))
    
    if not AppSettings.query.filter_by(key='current_semester').first():
        db.session.add(AppSettings(key='current_semester', value='1'))
    
    db.session.commit()

app = create_app()

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)

auth.py
from flask_login import LoginManager

login_manager = LoginManager()
login_manager.login_view = 'login_page'
login_manager.login_message = 'Пожалуйста, войдите для доступа к этой странице.'

@login_manager.user_loader
def load_user(user_id):
    from models import User
    return User.query.get(int(user_id))

def init_auth(app):
    login_manager.init_app(app)

config_local.py
import os

basedir = os.path.abspath(os.path.dirname(__file__))

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'your-secret-key-change-in-production'
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or f'sqlite:///{os.path.join(basedir, "schedule.db")}'
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    
    # Настройки для работы в сети
    HOST = '192.168.0.185'  # Ваш IP адрес
    PORT = 5000
    DEBUG = True

config.py
import os

basedir = os.path.abspath(os.path.dirname(__file__))

class Config:
    SECRET_KEY = os.environ.get('SECRET_KEY') or 'your-secret-key-here-change-in-production'
    SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URL') or f'sqlite:///{os.path.join(basedir, "schedule.db")}'
    SQLALCHEMY_TRACK_MODIFICATIONS = False

create_sjortcut.py
import os
import sys
import subprocess
import ctypes
from pathlib import Path

def is_admin():
    """Проверка прав администратора"""
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

def create_shortcut():
    """Создание ярлыка на рабочем столе"""
    
    # Путь к BAT файлу
    bat_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "start_server.bat")
    
    # Путь для ярлыка
    desktop = Path.home() / "Desktop"
    shortcut_path = desktop / "Расписание Колледжа.lnk"
    
    # Создаем BAT файл для ярлыка (если не существует)
    if not os.path.exists(bat_path):
        with open(bat_path, 'w', encoding='utf-8') as f:
            f.write('''@echo off
cd /d "%~dp0"
python app.py
pause''')
    
    # Команда для создания ярлыка через PowerShell
    ps_script = f'''
$WshShell = New-Object -comObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut("{shortcut_path}")
$Shortcut.TargetPath = "{bat_path}"
$Shortcut.WorkingDirectory = "{os.path.dirname(bat_path)}"
$Shortcut.IconLocation = "C:\\Windows\\System32\\SHELL32.dll,15"
$Shortcut.Description = "Запуск системы расписания колледжа"
$Shortcut.Save()
'''
    
    try:
        # Запускаем PowerShell для создания ярлыка
        result = subprocess.run(['powershell', '-Command', ps_script], 
                              capture_output=True, text=True)
        
        if result.returncode == 0:
            print(f"✅ Ярлык создан: {shortcut_path}")
            
            # Создаем иконку для ярлыка (опционально)
            create_icon()
            
        else:
            print(f"❌ Ошибка создания ярлыка: {result.stderr}")
            
    except Exception as e:
        print(f"❌ Ошибка: {e}")

def create_icon():
    """Создание иконки для ярлыка"""
    icon_script = '''
Add-Type -AssemblyName System.Drawing
$iconPath = Join-Path (Get-Location) "icon.ico"
if (Test-Path $iconPath) { return }

$bitmap = New-Object System.Drawing.Bitmap 256, 256
$graphics = [System.Drawing.Graphics]::FromImage($bitmap)
$graphics.Clear([System.Drawing.Color]::FromArgb(52, 152, 219))

$font = New-Object System.Drawing.Font("Arial", 100, [System.Drawing.FontStyle]::Bold)
$brush = New-Object System.Drawing.SolidBrush([System.Drawing.Color]::White)
$format = New-Object System.Drawing.StringFormat
$format.Alignment = [System.Drawing.StringAlignment]::Center
$format.LineAlignment = [System.Drawing.StringAlignment]::Center

$graphics.DrawString("📚", $font, $brush, [System.Drawing.Rectangle]::new(0, 0, 256, 256), $format)
$graphics.Dispose()

$bitmap.Save($iconPath, [System.Drawing.Imaging.ImageFormat]::Icon)
$bitmap.Dispose()
'''
    
    try:
        subprocess.run(['powershell', '-Command', icon_script], 
                      capture_output=True, text=True)
        print("✅ Иконка создана")
    except:
        print("⚠️  Не удалось создать иконку")

if __name__ == "__main__":
    print("=" * 50)
    print("Создание ярлыка для системы расписания")
    print("=" * 50)
    
    # Проверяем права администратора
    if not is_admin():
        print("⚠️  Запустите программу от имени администратора")
        input("Нажмите Enter для выхода...")
        sys.exit(1)
    
    create_shortcut()
    print("\n✅ Готово! Ярлык создан на рабочем столе")
    input("Нажмите Enter для выхода...")

current_schedule.py
# current_schedule.py
from flask import Blueprint, render_template, jsonify, request
from flask_login import login_required
from models import db, ScheduleEntry, MainScheduleEntry, Group, Subject, Teacher, Room
from initial_data import AVAILABLE_DAYS, AVAILABLE_PAIRS, get_lesson_time, get_pair_number, get_lessons_in_pair, is_zero_lesson_pair

current_schedule_bp = Blueprint('current_schedule', __name__)

@current_schedule_bp.route('/current_schedule')
@login_required
def current_schedule_page():
    """Страница текущего расписания с возможностью редактирования"""
    day = request.args.get('day', 'Понедельник')
    week = request.args.get('week', '1')
    semester = request.args.get('semester', '1')
    
    # Получаем текущее расписание
    entries = ScheduleEntry.query.filter_by(
        day=day,
        week_number=int(week),
        semester=int(semester)
    ).all()
    
    # Получаем основное расписание для сравнения
    main_entries = MainScheduleEntry.query.filter_by(
        day=day,
        semester=int(semester)
    ).all()
    
    # Группируем по парам
    schedule_by_pair = {}
    all_groups = set()
    
    for entry in entries:
        pair_num = get_pair_number(entry.day, entry.lesson_number)
        if pair_num not in schedule_by_pair:
            schedule_by_pair[pair_num] = {}
        
        if entry.group.name not in schedule_by_pair[pair_num]:
            schedule_by_pair[pair_num][entry.group.name] = []
        
        schedule_by_pair[pair_num][entry.group.name].append({
            'id': entry.id,
            'subject': entry.subject.name,
            'teacher': entry.teacher.name,
            'room': entry.room.name,
            'lesson_number': entry.lesson_number,
            'time': get_lesson_time(entry.day, entry.lesson_number),
            'is_changed': entry.is_changed
        })
        
        all_groups.add(entry.group.name)
    
    # Получаем всех преподавателей, предметы, группы и комнаты для форм
    all_teachers = [t.name for t in Teacher.query.order_by(Teacher.name).all()]
    all_subjects = [s.name for s in Subject.query.order_by(Subject.name).all()]
    all_groups_list = [g.name for g in Group.query.order_by(Group.name).all()]
    all_rooms = [r.name for r in Room.query.order_by(Room.name).all()]
    
    return render_template('current_schedule.html',
                         day=day,
                         week=week,
                         semester=semester,
                         schedule_by_pair=schedule_by_pair,
                         all_groups=sorted(list(all_groups)),
                         all_teachers=all_teachers,
                         all_subjects=all_subjects,
                         all_groups_list=all_groups_list,
                         all_rooms=all_rooms,
                         available_days=AVAILABLE_DAYS,
                         available_pairs=AVAILABLE_PAIRS.get(day, []),
                         get_lessons_in_pair=get_lessons_in_pair)

@current_schedule_bp.route('/api/current/add_entry', methods=['POST'])
@login_required
def add_entry():
    """Добавить запись в текущее расписание"""
    try:
        data = request.get_json()
        
        # Проверка: для 0 урока только "Разговоры о важном"
        day = data['day']
        lesson_number = int(data['lesson_number'])
        subject = data['subject']
        
        if day in ["Понедельник", "Четверг"] and lesson_number == 0 and subject != "Разговоры о важном":
            return jsonify({'success': False, 'message': 'На 0 урок можно поставить только "Разговоры о важном"'})
        
        # Находим объекты
        group = Group.query.filter_by(name=data['group']).first()
        subject_obj = Subject.query.filter_by(name=subject).first()
        teacher = Teacher.query.filter_by(name=data['teacher']).first()
        room = Room.query.filter_by(name=data['room']).first()
        
        if not all([group, subject_obj, teacher, room]):
            return jsonify({'success': False, 'message': 'Один из объектов не найден'})
        
        # Проверка конфликтов
        conflict = ScheduleEntry.query.filter_by(
            group_id=group.id,
            day=day,
            lesson_number=lesson_number,
            week_number=int(data['week']),
            semester=int(data['semester'])
        ).first()
        
        if conflict:
            return jsonify({'success': False, 'message': 'Конфликт: группа уже занята в это время'})
        
        # Создаем запись
        entry = ScheduleEntry(
            group_id=group.id,
            subject_id=subject_obj.id,
            teacher_id=teacher.id,
            room_id=room.id,
            day=day,
            lesson_number=lesson_number,
            week_number=int(data['week']),
            semester=int(data['semester']),
            is_changed=True
        )
        
        db.session.add(entry)
        db.session.commit()
        
        return jsonify({'success': True, 'message': 'Запись добавлена', 'id': entry.id})
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})

@current_schedule_bp.route('/api/current/delete_entry/<int:entry_id>', methods=['DELETE'])
@login_required
def delete_entry(entry_id):
    """Удалить запись из текущего расписания"""
    try:
        entry = ScheduleEntry.query.get(entry_id)
        if entry:
            db.session.delete(entry)
            db.session.commit()
            return jsonify({'success': True, 'message': 'Запись удалена'})
        else:
            return jsonify({'success': False, 'message': 'Запись не найдена'})
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})

@current_schedule_bp.route('/api/current/update_entry/<int:entry_id>', methods=['PUT'])
@login_required
def update_entry(entry_id):
    """Обновить запись в текущем расписании"""
    try:
        data = request.get_json()
        entry = ScheduleEntry.query.get(entry_id)
        
        if not entry:
            return jsonify({'success': False, 'message': 'Запись не найдена'})
        
        # Обновляем поля
        if 'subject' in data:
            subject = Subject.query.filter_by(name=data['subject']).first()
            if subject:
                entry.subject_id = subject.id
        
        if 'teacher' in data:
            teacher = Teacher.query.filter_by(name=data['teacher']).first()
            if teacher:
                entry.teacher_id = teacher.id
        
        if 'room' in data:
            room = Room.query.filter_by(name=data['room']).first()
            if room:
                entry.room_id = room.id
        
        entry.is_changed = True
        db.session.commit()
        
        return jsonify({'success': True, 'message': 'Запись обновлена'})
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})

db_manager.py
import sqlite3
import pandas as pd
import os
from pathlib import Path
from collections import namedtuple
from datetime import datetime

# Модели данных
Teacher = namedtuple("Teacher", ["id", "name"])
Subject = namedtuple("Subject", ["id", "name"])
Group = namedtuple("Group", ["id", "name"])
Room = namedtuple("Room", ["id", "name"])
ScheduleEntry = namedtuple("ScheduleEntry", 
                           ["id", "group_name", "subject_name", "teacher_name", 
                            "room_name", "day", "lesson_number", "week_number"])

class DatabaseManager:
    def __init__(self, db_name="schedule.db"):
        self.db_name = db_name
        self.conn = None
        self._connect()
        print(f"Подключено к базе данных: {self.db_name}")

    def _connect(self):
        try:
            self.conn = sqlite3.connect(self.db_name)
            self.conn.row_factory = sqlite3.Row
        except sqlite3.Error as e:
            print(f"Ошибка подключения к базе данных: {e}")
            self.conn = None

    def _close(self):
        if self.conn:
            self.conn.close()
            self.conn = None

    def _execute(self, query, params=(), fetch_one=False, fetch_all=False, commit=False):
        if not self.conn:
            self._connect()
            if not self.conn:
                return None

        try:
            cursor = self.conn.cursor()
            cursor.execute(query, params)
            if commit:
                self.conn.commit()
            if fetch_one:
                return cursor.fetchone()
            if fetch_all:
                return cursor.fetchall()
            return cursor.lastrowid # Для INSERT операций
        except sqlite3.Error as e:
            print(f"Ошибка выполнения запроса: {e}")
            print(f"Запрос: {query}, Параметры: {params}")
            return None

    def create_tables(self):
        queries = [
            """
            CREATE TABLE IF NOT EXISTS teachers (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE
            );
            """,
            """
            CREATE TABLE IF NOT EXISTS subjects (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE
            );
            """,
            """
            CREATE TABLE IF NOT EXISTS groups (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE
            );
            """,
            """
            CREATE TABLE IF NOT EXISTS rooms (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE
            );
            """,
            """
            CREATE TABLE IF NOT EXISTS schedule_entries (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                group_id INTEGER NOT NULL,
                subject_id INTEGER NOT NULL,
                teacher_id INTEGER NOT NULL,
                room_id INTEGER NOT NULL,
                day TEXT NOT NULL,
                lesson_number INTEGER NOT NULL,
                week_number INTEGER NOT NULL DEFAULT 1,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (group_id) REFERENCES groups(id),
                FOREIGN KEY (subject_id) REFERENCES subjects(id),
                FOREIGN KEY (teacher_id) REFERENCES teachers(id),
                FOREIGN KEY (room_id) REFERENCES rooms(id),
                UNIQUE (group_id, day, lesson_number, week_number),
                UNIQUE (teacher_id, day, lesson_number, week_number),
                UNIQUE (room_id, day, lesson_number, week_number)
            );
            """,
            """
            CREATE TABLE IF NOT EXISTS teacher_subject_hours (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                teacher_id INTEGER NOT NULL,
                subject_id INTEGER NOT NULL,
                total_hours INTEGER NOT NULL,
                used_hours INTEGER NOT NULL DEFAULT 0,
                FOREIGN KEY (teacher_id) REFERENCES teachers(id),
                FOREIGN KEY (subject_id) REFERENCES subjects(id),
                UNIQUE (teacher_id, subject_id)
            );
            """,
            """
            CREATE TABLE IF NOT EXISTS app_settings (
                key TEXT PRIMARY KEY,
                value TEXT NOT NULL
            );
            """
        ]
        for query in queries:
            self._execute(query, commit=True)
        print("Таблицы проверены/созданы.")
        
        # Проверяем существование столбца week_number и добавляем его если нужно
        try:
            self._execute("SELECT week_number FROM schedule_entries LIMIT 1", fetch_one=True)
        except sqlite3.OperationalError:
            print("Добавляем отсутствующий столбец week_number...")
            self._execute("ALTER TABLE schedule_entries ADD COLUMN week_number INTEGER NOT NULL DEFAULT 1", commit=True)

        # Проверяем существование столбца created_at и добавляем его если нужно
        try:
            self._execute("SELECT created_at FROM schedule_entries LIMIT 1", fetch_one=True)
        except sqlite3.OperationalError:
            print("Добавляем отсутствующий столбец created_at...")
            self._execute("ALTER TABLE schedule_entries ADD COLUMN created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP", commit=True)

    def populate_initial_data(self, teachers_data, subjects_data, groups_data, rooms_data):
        # Проверяем, есть ли уже начальные данные
        if self._execute("SELECT COUNT(*) FROM teachers", fetch_one=True)[0] > 0:
            # Проверяем также, установлена ли уже текущая неделя
            if self._execute("SELECT value FROM app_settings WHERE key = 'current_week'", fetch_one=True):
                print("Начальные данные уже существуют. Пропускаем заполнение.")
                return

        print("Заполнение начальных данных...")
        
        # Заполнение преподавателей и их предметов/часов
        for teacher_name, subjects_info in teachers_data.items():
            teacher_id = self.add_teacher(teacher_name)
            if teacher_id:
                for subject_name, total_hours in subjects_info.items():
                    subject_id = self.add_subject(subject_name)
                    if subject_id:
                        self.add_teacher_subject_hours(teacher_id, subject_id, total_hours)

        # Заполнение остальных данных
        for subject_name in subjects_data:
            self.add_subject(subject_name) # На случай, если предмет не был привязан к преподавателю
        for group_name in groups_data:
            self.add_group(group_name)
        for room_name in rooms_data:
            self.add_room(room_name)

        # Установка начальной недели
        self.set_setting('current_week', '1')

        print("Начальные данные заполнены.")

    # --- Методы для работы с таблицами ---
    def add_teacher(self, name):
        return self._execute("INSERT OR IGNORE INTO teachers (name) VALUES (?)", (name,), commit=True)

    def get_teacher_id_by_name(self, name):
        result = self._execute("SELECT id FROM teachers WHERE name = ?", (name,), fetch_one=True)
        return result[0] if result else None

    def get_teacher_by_id(self, teacher_id):
        result = self._execute("SELECT id, name FROM teachers WHERE id = ?", (teacher_id,), fetch_one=True)
        return Teacher(result[0], result[1]) if result else None
    
    def get_all_teachers(self):
        results = self._execute("SELECT id, name FROM teachers", fetch_all=True)
        return [Teacher(row['id'], row['name']) for row in results] if results else []

    def add_subject(self, name):
        return self._execute("INSERT OR IGNORE INTO subjects (name) VALUES (?)", (name,), commit=True)

    def get_subject_id_by_name(self, name):
        result = self._execute("SELECT id FROM subjects WHERE name = ?", (name,), fetch_one=True)
        return result[0] if result else None

    def get_subject_by_id(self, subject_id):
        result = self._execute("SELECT id, name FROM subjects WHERE id = ?", (subject_id,), fetch_one=True)
        return Subject(result[0], result[1]) if result else None

    def add_group(self, name):
        return self._execute("INSERT OR IGNORE INTO groups (name) VALUES (?)", (name,), commit=True)

    def get_group_id_by_name(self, name):
        result = self._execute("SELECT id FROM groups WHERE name = ?", (name,), fetch_one=True)
        return result[0] if result else None

    def get_group_by_id(self, group_id):
        result = self._execute("SELECT id, name FROM groups WHERE id = ?", (group_id,), fetch_one=True)
        return Group(result[0], result[1]) if result else None

    def add_room(self, name):
        return self._execute("INSERT OR IGNORE INTO rooms (name) VALUES (?)", (name,), commit=True)

    def get_room_id_by_name(self, name):
        result = self._execute("SELECT id FROM rooms WHERE name = ?", (name,), fetch_one=True)
        return result[0] if result else None

    def get_room_by_id(self, room_id):
        result = self._execute("SELECT id, name FROM rooms WHERE id = ?", (room_id,), fetch_one=True)
        return Room(result[0], result[1]) if result else None

    def get_all_rooms(self):
        results = self._execute("SELECT id, name FROM rooms", fetch_all=True)
        return [Room(row['id'], row['name']) for row in results] if results else []

    def add_teacher_subject_hours(self, teacher_id, subject_id, total_hours):
        # Если запись уже существует, обновляем total_hours
        existing_entry = self._execute(
            "SELECT id FROM teacher_subject_hours WHERE teacher_id = ? AND subject_id = ?",
            (teacher_id, subject_id), fetch_one=True
        )
        if existing_entry:
            self._execute(
                "UPDATE teacher_subject_hours SET total_hours = ? WHERE id = ?",
                (total_hours, existing_entry[0]), commit=True
            )
            return existing_entry[0]
        else:
            return self._execute(
                "INSERT INTO teacher_subject_hours (teacher_id, subject_id, total_hours, used_hours) VALUES (?, ?, ?, 0)",
                (teacher_id, subject_id, total_hours), commit=True
            )

    def update_teacher_used_hours(self, teacher_id, subject_id, amount=2):
        self._execute(
            """
            UPDATE teacher_subject_hours 
            SET used_hours = used_hours + ? 
            WHERE teacher_id = ? AND subject_id = ?
            """,
            (amount, teacher_id, subject_id), commit=True
        )

    def get_teacher_subject_remaining_hours(self, teacher_id, subject_id):
        result = self._execute(
            "SELECT total_hours, used_hours FROM teacher_subject_hours WHERE teacher_id = ? AND subject_id = ?",
            (teacher_id, subject_id), fetch_one=True
        )
        if result:
            return result['total_hours'] - result['used_hours']
        return 0 # Если нет записи, считаем 0 оставшихся часов

    def get_all_teacher_load_info(self):
        query = """
            SELECT
                T.name AS teacher_name,
                S.name AS subject_name,
                TSH.total_hours,
                TSH.used_hours
            FROM teachers AS T
            JOIN teacher_subject_hours AS TSH ON T.id = TSH.teacher_id
            JOIN subjects AS S ON S.id = TSH.subject_id
            ORDER BY T.name, S.name;
        """
        return self._execute(query, fetch_all=True)

    def add_schedule_entry(self, group_id, subject_id, teacher_id, room_id, day, lesson_number, week_number=None):
        if week_number is None:
            week_number = self.get_current_week()

        # Проверка конфликтов перед добавлением
        conflicts = [
            ("SELECT id FROM schedule_entries WHERE group_id = ? AND day = ? AND lesson_number = ? AND week_number = ?", 
             (group_id, day, lesson_number, week_number)),
            ("SELECT id FROM schedule_entries WHERE teacher_id = ? AND day = ? AND lesson_number = ? AND week_number = ?", 
             (teacher_id, day, lesson_number, week_number)),
            ("SELECT id FROM schedule_entries WHERE room_id = ? AND day = ? AND lesson_number = ? AND week_number = ?", 
             (room_id, day, lesson_number, week_number))
        ]
        
        for query, params in conflicts:
            if self._execute(query, params, fetch_one=True):
                return None # Возвращаем None, если есть конфликт
        
        # Если конфликтов нет, добавляем запись
        return self._execute(
            """
            INSERT INTO schedule_entries 
            (group_id, subject_id, teacher_id, room_id, day, lesson_number, week_number) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
            """,
            (group_id, subject_id, teacher_id, room_id, day, lesson_number, week_number), commit=True
        )

    def get_all_schedule_entries(self, week_number=None):
        if week_number is None:
            week_number = self.get_current_week()
        
        query = """
            SELECT 
                SE.id, G.name AS group_name, S.name AS subject_name, 
                T.name AS teacher_name, R.name AS room_name, 
                SE.day, SE.lesson_number, SE.week_number
            FROM schedule_entries AS SE
            JOIN groups AS G ON SE.group_id = G.id
            JOIN subjects AS S ON SE.subject_id = S.id
            JOIN teachers AS T ON SE.teacher_id = T.id
            JOIN rooms AS R ON SE.room_id = R.id
            WHERE SE.week_number = ?
            ORDER BY SE.day, SE.lesson_number, G.name
        """
        results = self._execute(query, (week_number,), fetch_all=True)
        return [ScheduleEntry(*row) for row in results] if results else []

    def get_schedule_entries_for_day(self, day, week_number=None):
        if week_number is None:
            week_number = self.get_current_week()

        query = """
            SELECT 
                SE.id, G.name AS group_name, S.name AS subject_name, 
                T.name AS teacher_name, R.name AS room_name, 
                SE.day, SE.lesson_number, SE.week_number
            FROM schedule_entries AS SE
            JOIN groups AS G ON SE.group_id = G.id
            JOIN subjects AS S ON SE.subject_id = S.id
            JOIN teachers AS T ON SE.teacher_id = T.id
            JOIN rooms AS R ON SE.room_id = R.id
            WHERE SE.day = ? AND SE.week_number = ?
            ORDER BY SE.lesson_number, G.name
        """
        results = self._execute(query, (day, week_number), fetch_all=True)
        return [ScheduleEntry(*row) for row in results] if results else []

    def update_schedule_entry(self, entry_id, group_id=None, subject_id=None, teacher_id=None, room_id=None, day=None, lesson_number=None):
        set_parts = []
        params = []
        
        # Получаем текущие значения записи для валидации конфликтов
        current_entry = self._execute("SELECT * FROM schedule_entries WHERE id = ?", (entry_id,), fetch_one=True)
        if not current_entry:
            print(f"Ошибка: Запись с ID {entry_id} не найдена.")
            return False

        # Подготовка параметров для обновления
        if group_id is not None and group_id != current_entry['group_id']:
            set_parts.append("group_id = ?")
            params.append(group_id)
        if subject_id is not None and subject_id != current_entry['subject_id']:
            set_parts.append("subject_id = ?")
            params.append(subject_id)
        if teacher_id is not None and teacher_id != current_entry['teacher_id']:
            set_parts.append("teacher_id = ?")
            params.append(teacher_id)
        if room_id is not None and room_id != current_entry['room_id']:
            set_parts.append("room_id = ?")
            params.append(room_id)
        if day is not None and day != current_entry['day']:
            set_parts.append("day = ?")
            params.append(day)
        if lesson_number is not None and lesson_number != current_entry['lesson_number']:
            set_parts.append("lesson_number = ?")
            params.append(lesson_number)
        
        if not set_parts:
            # print("Нет данных для обновления, или значения совпадают с текущими.")
            return True # Ничего не изменилось, но операция успешна

        # Для проверки конфликтов используем новые (или старые, если не менялись) значения
        final_group_id = group_id if group_id is not None else current_entry['group_id']
        final_teacher_id = teacher_id if teacher_id is not None else current_entry['teacher_id']
        final_room_id = room_id if room_id is not None else current_entry['room_id']
        final_day = day if day is not None else current_entry['day']
        final_lesson_number = lesson_number if lesson_number is not None else current_entry['lesson_number']
        final_week_number = current_entry['week_number'] # Неделя не меняется при редактировании записи

        # Проверка конфликтов с ДРУГИМИ записями (исключая текущую)
        conflicts = [
            ("SELECT id FROM schedule_entries WHERE group_id = ? AND day = ? AND lesson_number = ? AND week_number = ? AND id != ?", 
             (final_group_id, final_day, final_lesson_number, final_week_number, entry_id)),
            ("SELECT id FROM schedule_entries WHERE teacher_id = ? AND day = ? AND lesson_number = ? AND week_number = ? AND id != ?", 
             (final_teacher_id, final_day, final_lesson_number, final_week_number, entry_id)),
            ("SELECT id FROM schedule_entries WHERE room_id = ? AND day = ? AND lesson_number = ? AND week_number = ? AND id != ?", 
             (final_room_id, final_day, final_lesson_number, final_week_number, entry_id))
        ]
        
        for query_check, params_check in conflicts:
            if self._execute(query_check, params_check, fetch_one=True):
                print(f"Ошибка: Изменение приведет к конфликту расписания. Запись не обновлена.")
                return False # Возвращаем False, если есть конфликт
        
        query = f"UPDATE schedule_entries SET {', '.join(set_parts)} WHERE id = ?"
        params.append(entry_id)
        
        return self._execute(query, tuple(params), commit=True) is not None

    def delete_schedule_entry(self, entry_id):
        # При удалении записи, часы преподавателя по этому предмету должны быть "возвращены"
        # Получаем данные удаляемой записи
        entry_data = self._execute(
            "SELECT teacher_id, subject_id FROM schedule_entries WHERE id = ?",
            (entry_id,), fetch_one=True
        )

        if entry_data:
            teacher_id = entry_data['teacher_id']
            subject_id = entry_data['subject_id']
            # Уменьшаем использованные часы преподавателя
            self._execute(
                """
                UPDATE teacher_subject_hours 
                SET used_hours = used_hours - 2 
                WHERE teacher_id = ? AND subject_id = ? AND used_hours >= 2
                """,
                (teacher_id, subject_id), commit=True
            )

        return self._execute("DELETE FROM schedule_entries WHERE id = ?", (entry_id,), commit=True) is not None

    def delete_week(self, week_number):
        # При удалении недели, также сбрасываем used_hours для преподавателей
        # так как это расписание больше не существует.
        self._execute("UPDATE teacher_subject_hours SET used_hours = 0", commit=True)
        return self._execute("DELETE FROM schedule_entries WHERE week_number = ?", (week_number,), commit=True) is not None

    # --- Методы для работы с app_settings (новое) ---
    def set_setting(self, key, value):
        self._execute("INSERT OR REPLACE INTO app_settings (key, value) VALUES (?, ?)", (key, str(value)), commit=True)

    def get_setting(self, key, default=None):
        result = self._execute("SELECT value FROM app_settings WHERE key = ?", (key,), fetch_one=True)
        return result[0] if result else default

    # --- Методы для работы с текущей неделей (новое) ---
    def get_current_week(self):
        week = self.get_setting('current_week', '1') # По умолчанию неделя 1
        return int(week)

    def get_next_week_schedule(self):
        current_week = self.get_current_week()
        next_week = current_week + 1
        self.set_setting('current_week', next_week)
        
        # Сброс часов использования преподавателей при переходе на новую неделю
        # Это предотвращает накопление `used_hours` через недели, что важно для еженедельного планирования.
        self._execute("UPDATE teacher_subject_hours SET used_hours = 0", commit=True)

        return next_week
    
    # --- Экспорт в Excel ---
    def export_schedule_to_excel(self, day=None, week_number=None, filename="schedule_export.xlsx"):
        if week_number is None:
            week_number = self.get_current_week()

        if day:
            entries = self.get_schedule_entries_for_day(day, week_number)
            if entries:
                filename = filename.replace(".xlsx", f"_{day}.xlsx") # Добавляем день к имени файла
        else:
            entries = self.get_all_schedule_entries(week_number)
            if entries:
                filename = filename.replace(".xlsx", f"_week_{week_number}.xlsx") # Добавляем номер недели к имени файла
            
        if not entries:
            print(f"Нет данных для экспорта за неделю {week_number}" + (f" на день {day}" if day else ""))
            return False

        # Преобразование namedtuple в список словарей для DataFrame
        data = [entry._asdict() for entry in entries]
        df = pd.DataFrame(data)

        # Переименование колонок для читаемости
        df = df.rename(columns={
            'group_name': 'Группа',
            'subject_name': 'Предмет',
            'teacher_name': 'Преподаватель',
            'room_name': 'Аудитория',
            'day': 'День Недели',
            'lesson_number': 'Номер Пары',
            'week_number': 'Неделя'
        })
        
        # Удаляем ненужный 'id'
        df = df.drop(columns=['id'])

        try:
            # Получаем путь к папке Загрузки (Downloads)
            downloads_path = Path.home() / "Downloads"
            filepath = downloads_path / filename
            
            df.to_excel(filepath, index=False)
            print(f"Расписание успешно экспортировано в '{filepath}'")
            return True
        except Exception as e:
            print(f"Ошибка при экспорте в Excel: {e}")
            return False


initial_data.py
# Полный список преподавателей (добавлены недостающие)
TEACHER_INITIAL_LOAD = {
    "Магафурова Г.Я.": {"Русский язык", "Литература", "Русский язык и культура речи", "Русский язык и культура профессиональной коммуникации педагога"},
    "Давлетшина А.Д.": {"Русский язык", "Литература"},
    "Шапкина Е.Д.": {"Русский язык", "Литература", "Основы обучения лиц с особыми образовательными потребностями"},
    "Дагаева М.М.": {"Литература", "Русский язык", "Индивидуальный проект", "Теоретические основы дошкольного образования"},
    "Ханов А.Р.": {"История", "Обществознание", "Разговоры о важном", "История России", "Основы финансовой грамотности"},
    "Горелова Е.Е.": {"История", "Разговоры о важном"},
    "Усманова Э.Б.": {"История", "Разговоры о важном"},
    "Пьянков Г.Ю.": {"Обществознание", "БЖ", "Разговоры о важном", "Безопасность", "Безопасность жизнедеятельности"},
    "Таукеева Ф.В.": {"Обществознание", "Разговоры о важном", "Биология"},
    "Мухаметгалина А.Г.": {"Иностранный язык", "Иностранный язык в профессиональной деятельности", "Разговоры о важном"},
    "Шуматбаева Г.Р.": {"Иностранный язык", "Разговоры о важном", "Иностранный язык в профессиональной деятельности"},
    "Литвишко И.В.": {"Иностранный язык", "Сервисная деятельность в туризме и гостеприимстве", "Экономика и бухгалтерский учёт"},
    "Курмангалеева Г.Н.": {"География", "Разговоры о важном", "Введение в специальность", "Координация работы служб предприятий туризма"},
    "Вандышева Н.Н.": {"Физика", "Разговоры о важном"},
    "Мурзабаева Д.М.": {"Математика", "Разговоры о важном"},
    "Миронова Л.И.": {"Математика", "Разговоры о важном"},
    "Лапшина Л.Н.": {"Математика", "Элементы высшей математики", "Дискретная математика", "Теория вероятностей", "Разговоры о важном"},
    "Бикбаева А.В.": {"Химия", "Разговоры о важном"},
    "Асылгужина Ю.Д.": {"Информатика", "Разговоры о важном"},
    "Ручкина О.Н.": {"Информатика", "Математика", "Стандартизация, сертификация и техническое документоведение", "Разговоры о важном"},
    "Зайнуллина И.М.": {"Информатика", "Информационные технологии", "Разговоры о важном"},
    "Шакирова С.С.": {"Физ-ра", "Физическая культура", "Разговоры о важном"},
    "Никитин М.А.": {"Физ-ра", "Физическая культура", "Разговоры о важном"},
    "Лахмостов М.Ю.": {"Физ-ра", "Физическая культура", "Безопасность жизнедеятельности", "Разговоры о важном"},
    "Ахмадеев Д.Н.": {"Физ-ра", "Гимнастика", "Легкая атлетика", "Теория и методика физического воспитания", "Разговоры о важном"},
    "Салов С.В.": {"ОБЖ", "Основы безопасности и защиты Родины", "Разговоры о важном"},
    "Адельмурдина Р.М.": {"Индивидуальный проект", "МДК01.06естеств. с метод. преподавания", "Основы организации внеурочной деятельности", "Теория и методика обучения в начальных классах", "Осуществление расчётов с клиентом", "Разговоры о важном"},
    "Астанова Б.З.": {"Индивидуальный проект", "Башкирский язык", "Разговоры о важном"},
    "Хусаинова Г.М.": {"Башкирский язык", "Башкирский язык в профессиональной деятельности", "Разговоры о важном"},
    "Ломакина Ю.В.": {"Основы педагогики", "Педагогика", "Проектная и исследовательская деятельность", "Современные программы и технологии воспитания", "Теория и методика деятельности классного руководства", "Разговоры о важном"},
    "Привалова О.С.": {"Основы педагогики", "Дошкольная педагогика", "Теоретические и методические основы организации игровой деятельности", "Разговоры о важном"},
    "Семавина Н.Г.": {"Основы психологии", "Возрастная психология", "Основы логопедии", "Основы специальной психологии", "Разговоры о важном"},
    "Кожевникова Н.Г.": {"Основы психологии", "Психология делового общения и конфликтология", "Психология общения", "Соблюдение норм этики делового общения", "Разговоры о важном"},
    "Шайхелисламов А.Д.": {"Правовое и документационное обеспечение", "Правовое обеспечение профессиональной деятельности", "Разговоры о важном"},
    "Иргалина Д.Д.": {"Менеджмент в туризме", "Менеджмент в туризме и гостеприимстве", "Разговоры о важном"},
    "Ахмедьянова М.Н.": {"Детская литература", "Теория и методика преподавания", "Теоретические основы начального курса математики с методикой преподавания", "Методика формирования элементарных математических представлений", "Разговоры о важном"},
    "Карпушова К.Ю.": {"Основы бережливого производства", "Разговоры о важном"},
    "Евдокимова Ю.Ф.": {"Изучение основ делопроизводства", "Разговоры о важном"},
    "Душина Е.П.": {"Основы философии", "Проектная и исследовательская деятельность", "Разговоры о важном"},
    "Гридневская Л.Г.": {"Возрастная анатомия, физиология и гигиена", "Медико-биологические основы обучения и воспитания детей", "Здоровьесберегающие технологии", "Разговоры о важном"},
    "Ахметзянова Л.В.": {"Методика обучения продуктивным видам деятельности", "Практикум по художественной обработке материалов", "Разговоры о важном"},
    "Попова О.В.": {"Теория и методика музыкального воспитания", "Методика развития речи", "Разговоры о важном"},
    "Князева Н.Л.": {"Теория и методика физического воспитания", "Методика организации продуктивных видов деятельности", "Практикум по совершенствованию двигательных навыков", "Разговоры о важном"},
    "Саитова Ю.Н.": {"Основы алгоритмизации и программирования", "Инженерная компьютерная графика", "Администрирование сетевых операционных систем", "Программное обеспечение компьютерных сетей", "Разговоры о важном"},
    "Шаяхметов Р.Р.": {"Основы проектирования баз данных", "Разработка программных модулей", "Организация администрирования компьютерных сетей", "Разговоры о важном"},
    "Михайлов А.А.": {"Архитектура аппаратных средств", "Основы электротехники", "Технологии физического уровня передачи данных", "Разговоры о важном"},
    "Клюц И.Д.": {"Операционные системы и среды", "Менеджмент", "Наладчик технологического оборудования", "Разговоры о важном"},
    "Клюц Е.В.": {"Экономика отрасли", "Разговоры о важном"},
    "Какушкин": {"Организация, принципы построения и функционирования компьютерных сетей", "Безопасность компьютерных сетей", "Разговоры о важном"},
    "Лисьев Г.А.": {"Архитектура аппаратных средств", "Разработчик веб и мультимедийных приложений", "Разработка мобильных приложений", "Инструментальные средства разработки программного обеспечения", "Разговоры о важном"},
    "Сарапулов": {"Внедрение и поддержка компьютерных систем", "Внедрение и поддержка программного обеспечения компьютерных систем", "Разговоры о важном"},
    "Дмитриева С.Л.": {"Проектная и исследовательская деятельность", "Методика организации трудовой деятельности", "Теория и методика экологического образования", "Теория и методика ознакомления с социальным миром", "Разговоры о важном"},
    "Ерастова М.Ю.": {"Основы финансовой грамотности", "Разговоры о важном"},
    "Мирзаханов": {"Техническое черчение", "Общие основы технологии металлообработки", "Разговоры о важном"},
    "Султанова З.М.": {"Педагогика", "Разговоры о важном"},
    "Шайхетдинов Р.Р.": {"Информатика", "Разговоры о важном"},
    "Хайретдинов Р.Р.": {"Информатика", "Разговоры о важном"},
    "Кобелькова Е.В.": {"Информатика и ИКТ", "Разговоры о важном"},
    "Ульданова И.Р.": {"Литература", "Разговоры о важном"},
    "Червоткина Л.В.": {"МДК02.03 теор.основы прод.деят", "Разговоры о важном"},
    "Саитова Г.Ф.": {"МДК 02.01 админ.сет.опер.сис", "Разговоры о важном"},
    "Емченко В.А.": {"МДК 01.01 разраб.прог.мод", "Разговоры о важном"},
    "Казачкова Е.В.": {"Основы психолого-педагогического развития", "Разговоры о важном"},
    "Лисьев П.Н.": {"Архитектура", "Разговоры о важном"},
    "Востриков А.С.": {"МДК03.01 экс.об.сетевой инфрст.", "Разговоры о важном"},
    "Султанова Р.К.": {"МДК 02.02 теор.и метод.осн.физ.озд.работы", "Разговоры о важном"},
    # Добавлено "вак" (вакансия) как специальный преподаватель
    "вак": {"Информатика", "Предпринимательская деятельность в сфере туризма", "Координация работы по реализации заказа экскурсий", "Технология и организация информационно-экскурсионной деятельности", "Предоставление туроператорских услуг", "Координация качества выполнения турагентских услуг", "Основы предпринимательской деятельности", "Основы эффективного поведения на рынке труда", "Системное программирование", "Технология разработки программного обеспечения", "Инструментальные средства разработки программного обеспечения", "Математическое моделирование", "Внедрение и поддержка компьютерных систем", "Обеспечение качества функционирования компьютерных систем", "Экономика отрасли", "Планирование карьеры", "Поддержка и тестирование программных модулей", "Разработка программных модулей", "Разработчик веб и мультимедийных приложений", "Администрирование сетевых"}
}

# Список всех специальностей
SPECIALITIES = {
    "44.02.02": "Преподавание в начальных классах",
    "44.02.01": "Дошкольное образование", 
    "44.02.04": "Специальное дошкольное образование",
    "09.02.06": "Сети и системы связи",
    "09.02.07": "Информационные системы и программирование",
    "43.02.10": "Туризм",
    "10.02.05": "Обеспечение информационной безопасности автоматизированных систем",
    "15.01.38": "Станочник (металлообработка)"
}

# Полный список групп с указанием курса и специальности
GROUPS = [
    # 1 курс
    "1А", "1Б", "1В", "1Г", "1Д", "1Е", "1Ж", "1К", "1Т", "1М", "1Н",
    # 2 курс  
    "2А", "2Б", "2В", "2Г", "2Д", "2Е", "2Ж", "2И", "2К", "2Т",
    # 3 курс
    "3А", "3Б", "3В", "3Г", "3Д", "3Е", "3Ж", "3И", "3Т",
    # 4 курс
    "4А", "4Б", "4В", "4Г", "4Д", "4Е"
]

# Группы по специальностям (для удобства)
GROUPS_BY_SPECIALITY = {
    "44.02.02": ["1А", "2А", "3А", "4А"],  # Преподавание в начальных классах
    "44.02.01": ["1Г", "2Г", "3Г"],  # Дошкольное образование
    "44.02.04": ["1Д", "2Е", "3Е"],  # Специальное дошкольное образование
    "09.02.06": ["1Б", "2Б", "3Б", "4Б"],  # Сети и системы связи
    "09.02.07": ["1Е", "1К", "2И", "2К", "3Д", "3И", "4Д", "4Е"],  # Информационные системы
    "43.02.10": ["1Ж", "1Т", "2Т", "2Ж", "3Т", "3Ж"],  # Туризм
    "10.02.05": ["1М"],  # Обеспечение информационной безопасности
    "15.01.38": ["1Н"]  # Станочник
}

# Список всех предметов
SUBJECTS = sorted(list(set(
    ["Разговоры о важном"] +  # Добавляем первым
    [subject for subjects in TEACHER_INITIAL_LOAD.values() for subject in subjects] +
    ["Обществознание", "Биология", "Информатика", "Техническое черчение", "ОБЖ",
     "Физ-ра", "Физическая культура", "География", "Литература", "Русский язык", 
     "История", "Иностранный язык", "Башкирский язык", "Математика", "Физика", 
     "Химия", "Основы педагогики", "Основы психологии", "Основы безопасности и защиты Родины",
     "Индивидуальный проект", "Безопасность жизнедеятельности", "Экономика отрасли",
     "Менеджмент", "Основы предпринимательской деятельности", "Основы бережливого производства",
     "Основы финансовой грамотности", "Правовое обеспечение профессиональной деятельности",
     "Психология общения", "Основы философии", "Основы логопедии", "Возрастная психология",
     "Детская литература", "Теория и методика музыкального воспитания", "Теория и методика физического воспитания",
     "Методика развития речи", "Теория и методика экологического образования", "Теория и методика ознакомления с социальным миром"]
)))

# Список комнат (остается без изменений)
ROOMS = [
    "101", "102", "103", "104", "105", "106", "107", "108", "109", "110",
    "111", "112", "113", "114", "115", "116", "117", "118", "119", "120",
    "123", "124", "125", "126", "127", "128", "129", "130",
    "201", "202", "203", "204", "205", "206", "207", "208", "209", "210",
    "211", "212", "213", "214", "215", "216", "217", "218", "219", "220",
    "221", "222", "223", "224", "225", "226", "227", "228", "229", "230",
    "301", "302", "303", "304", "305", "306", "307", "308", "309", "310",
    "311", "312", "313", "314", "315", "316", "317", "318", "319", "320",
    "401", "402", "403", "404", "405", "406", "407", "408", "409", "410",
    "411", "412", "413", "414", "415", "416", "417", "418", "419", "420",
    "Спортзал", "Актовый зал", "Библиотека", "Компьютерный класс 1", "Компьютерный класс 2",
    "Лаборатория физики", "Лаборатория химии", "Лаборатория биологии", "Мастерская", "Музыкальный класс"
]

# Дни недели (остается без изменений)
AVAILABLE_DAYS = ["Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"]

# Функция для получения времени урока (остается без изменений)
def get_lesson_time(day, lesson_number):
    """Получить время урока"""
    if day in ["Понедельник", "Четверг"]:
        times = {
            0: "8:30-9:10",
            1: "9:15-9:55",
            2: "10:00-10:40",
            3: "11:20-12:00",
            4: "12:05-12:45",
            5: "13:25-14:05",
            6: "14:10-14:50",
            7: "15:00-15:40",
            8: "15:45-16:25",
            9: "16:30-17:10",
            10: "17:15-17:55",
            11: "18:00-18:40",
            12: "18:45-19:25"
        }
    elif day in ["Вторник", "Среда", "Пятница"]:
        times = {
            1: "8:30-9:10",
            2: "9:15-9:55",
            3: "10:35-11:15",
            4: "11:20-12:00",
            5: "12:40-13:20",
            6: "13:25-14:05",
            7: "14:15-14:55",
            8: "15:00-15:40",
            9: "15:45-16:25",
            10: "16:30-17:10",
            11: "17:15-17:55",
            12: "18:00-18:40"
        }
    elif day == "Суббота":
        times = {
            1: "8:00-8:40",
            2: "8:45-9:25",
            3: "9:30-10:10",
            4: "10:15-10:55",
            5: "11:00-11:40",
            6: "11:45-12:25",
            7: "12:30-13:10",
            8: "13:15-13:55"
        }
    else:
        return ""
    
    return times.get(lesson_number, "")

# Функция для получения доступных пар по дням (остается без изменений)
def get_available_pairs(day):
    """Получить доступные пары для дня"""
    if day == "Суббота":
        return [1, 2, 3, 4]  # В субботу 4 пары
    elif day in ["Понедельник", "Четверг"]:
        return [0, 1, 2, 3, 4, 5, 6]  # Пн и Чт есть 0 пара
    else:
        return [1, 2, 3, 4, 5, 6]  # Остальные дни

models.py
from flask_sqlalchemy import SQLAlchemy
from flask_login import UserMixin
from werkzeug.security import generate_password_hash, check_password_hash
from datetime import datetime

db = SQLAlchemy()

class User(UserMixin, db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(64), unique=True, nullable=False)
    password_hash = db.Column(db.String(128))
    role = db.Column(db.String(20), default='viewer')
    
    def set_password(self, password):
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        return check_password_hash(self.password_hash, password)

class Teacher(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False, unique=True)
    
    def __repr__(self):
        return f'<Teacher {self.name}>'

class Subject(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False, unique=True)
    
    def __repr__(self):
        return f'<Subject {self.name}>'

class Group(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), nullable=False, unique=True)
    course = db.Column(db.Integer, nullable=False)
    
    def __repr__(self):
        return f'<Group {self.name}>'

class Room(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), nullable=False, unique=True)
    
    def __repr__(self):
        return f'<Room {self.name}>'

class TeacherSubject(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    teacher_id = db.Column(db.Integer, db.ForeignKey('teacher.id'), nullable=False)
    subject_id = db.Column(db.Integer, db.ForeignKey('subject.id'), nullable=False)
    
    teacher = db.relationship('Teacher', backref=db.backref('subjects', lazy=True))
    subject = db.relationship('Subject', backref=db.backref('teachers', lazy=True))

class GroupSubject(db.Model):
    __tablename__ = 'group_subject'
    id = db.Column(db.Integer, primary_key=True)
    group_id = db.Column(db.Integer, db.ForeignKey('group.id'), nullable=False)
    subject_id = db.Column(db.Integer, db.ForeignKey('subject.id'), nullable=False)
    teacher_id = db.Column(db.Integer, db.ForeignKey('teacher.id'), nullable=True)
    hours_per_week = db.Column(db.Integer, default=0)
    total_hours_semester1 = db.Column(db.Integer, default=0)
    total_hours_semester2 = db.Column(db.Integer, default=0)
    
    group = db.relationship('Group', backref=db.backref('group_subjects', lazy=True))
    subject = db.relationship('Subject', backref=db.backref('group_subjects', lazy=True))
    teacher = db.relationship('Teacher', backref=db.backref('group_assignments', lazy=True))

class GroupPractice(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    group_id = db.Column(db.Integer, db.ForeignKey('group.id'), nullable=False)
    day = db.Column(db.String(20), nullable=False)
    subject_id = db.Column(db.Integer, db.ForeignKey('subject.id'), nullable=True)
    teacher_id = db.Column(db.Integer, db.ForeignKey('teacher.id'), nullable=True)
    room_id = db.Column(db.Integer, db.ForeignKey('room.id'), nullable=True)
    
    group = db.relationship('Group', backref=db.backref('practice', lazy=True))
    subject = db.relationship('Subject', backref=db.backref('practices', lazy=True))
    teacher = db.relationship('Teacher', backref=db.backref('practices', lazy=True))
    room = db.relationship('Room', backref=db.backref('practices', lazy=True))

class ScheduleEntry(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    group_id = db.Column(db.Integer, db.ForeignKey('group.id'), nullable=False)
    subject_id = db.Column(db.Integer, db.ForeignKey('subject.id'), nullable=False)
    teacher_id = db.Column(db.Integer, db.ForeignKey('teacher.id'), nullable=False)
    room_id = db.Column(db.Integer, db.ForeignKey('room.id'), nullable=False)
    day = db.Column(db.String(20), nullable=False)
    lesson_number = db.Column(db.Integer, nullable=False)
    week_number = db.Column(db.Integer, default=1)
    week_parity = db.Column(db.String(10), default='both')
    semester = db.Column(db.Integer, default=1)
    is_changed = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    group = db.relationship('Group', backref=db.backref('schedule_entries', lazy=True))
    subject = db.relationship('Subject', backref=db.backref('schedule_entries', lazy=True))
    teacher = db.relationship('Teacher', backref=db.backref('schedule_entries', lazy=True))
    room = db.relationship('Room', backref=db.backref('schedule_entries', lazy=True))

class MainScheduleEntry(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    group_id = db.Column(db.Integer, db.ForeignKey('group.id'), nullable=False)
    subject_id = db.Column(db.Integer, db.ForeignKey('subject.id'), nullable=False)
    teacher_id = db.Column(db.Integer, db.ForeignKey('teacher.id'), nullable=False)
    room_id = db.Column(db.Integer, db.ForeignKey('room.id'), nullable=False)
    day = db.Column(db.String(20), nullable=False)
    lesson_number = db.Column(db.Integer, nullable=False)
    week_parity = db.Column(db.String(10), default='both')
    semester = db.Column(db.Integer, default=1)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    group = db.relationship('Group', backref=db.backref('main_schedule_entries', lazy=True))
    subject = db.relationship('Subject', backref=db.backref('main_schedule_entries', lazy=True))
    teacher = db.relationship('Teacher', backref=db.backref('main_schedule_entries', lazy=True))
    room = db.relationship('Room', backref=db.backref('main_schedule_entries', lazy=True))

class AutoFillLog(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    week_number = db.Column(db.Integer, nullable=False)
    semester = db.Column(db.Integer, nullable=False)
    fill_type = db.Column(db.String(20), nullable=False)  # 'current', 'main', 'both'
    entries_added = db.Column(db.Integer, default=0)
    conflicts = db.Column(db.Integer, default=0)
    errors = db.Column(db.Integer, default=0)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class AppSettings(db.Model):
    key = db.Column(db.String(50), primary_key=True)
    value = db.Column(db.String(100), nullable=False)

requirements.txt
Flask>=2.3.0
Flask-SQLAlchemy>=3.0.0
Flask-Login>=0.6.0
Werkzeug>=2.3.0
pandas>=1.5.0
openpyxl>=3.0.0
chart.js>=3.9.0

routes.py
# routes.py
from flask import render_template, request, jsonify, flash, redirect, url_for, send_file
from flask_login import login_required, current_user, login_user, logout_user
from models import db, User, Teacher, Subject, Group, Room, ScheduleEntry, MainScheduleEntry, AppSettings
from initial_data import AVAILABLE_DAYS, GROUPS, SUBJECTS, ROOMS, TEACHER_INITIAL_LOAD, AVAILABLE_PAIRS, get_lesson_time, WEEK_PARITIES, SEMESTERS, MAX_WEEKS, get_pair_number
import pandas as pd
import os
from datetime import datetime
import io
from openpyxl import Workbook

def init_routes(app):
    
    # Добавляем фильтр для форматирования пары
    @app.template_filter('pair_format')
    def pair_format(lesson_number, day):
        pair_num = get_pair_number(day, lesson_number)
        time = get_lesson_time(day, lesson_number)
        if time:
            return f"Пара {pair_num} (урок {lesson_number} - {time})"
        return f"Пара {pair_num} (урок {lesson_number})"
    
    # Добавляем фильтр для определения четности недели
    @app.template_filter('week_parity_text')
    def week_parity_text(parity):
        if parity == 'even':
            return 'чётная'
        elif parity == 'odd':
            return 'нечётная'
        else:
            return 'всегда'
    
    @app.route('/login', methods=['GET', 'POST'])
    def login():
        if request.method == 'POST':
            username = request.form.get('username')
            password = request.form.get('password')
            
            user = User.query.filter_by(username=username).first()
            if user and user.check_password(password):
                login_user(user)
                flash('Вы успешно вошли!', 'success')
                return redirect(url_for('admin'))
            else:
                flash('Неверное имя пользователя или пароль', 'error')
        
        return render_template('login.html')
    
    @app.route('/logout')
    def logout():
        logout_user()
        flash('Вы вышли из системы', 'info')
        return redirect(url_for('index'))
    
    @app.route('/')
    def index():
        return render_template('index.html')
    
    @app.route('/schedule')
    def schedule():
        day = request.args.get('day', 'Понедельник')
        week = request.args.get('week', '')
        semester = request.args.get('semester', '')
        schedule_type = request.args.get('type', 'current')
        
        current_semester = get_current_semester()
        if semester:
            current_semester = int(semester)
        
        if week:
            current_week = int(week)
        else:
            current_week = get_current_week()
        
        current_parity = 'even' if current_week % 2 == 0 else 'odd'
        
        if schedule_type == 'main':
            entries = MainScheduleEntry.query.filter(
                MainScheduleEntry.day == day,
                MainScheduleEntry.semester == current_semester
            ).filter(
                (MainScheduleEntry.week_parity == 'both') |
                (MainScheduleEntry.week_parity == current_parity)
            ).order_by(MainScheduleEntry.lesson_number).all()
        else:
            entries = ScheduleEntry.query.filter(
                ScheduleEntry.day == day,
                ScheduleEntry.semester == current_semester,
                ScheduleEntry.week_number == current_week
            ).order_by(ScheduleEntry.lesson_number).all()
        
        schedule_data = {}
        all_groups = set()
        
        for entry in entries:
            group_name = entry.group.name
            all_groups.add(group_name)
            if group_name not in schedule_data:
                schedule_data[group_name] = {}
            
            pair_num = get_pair_number(entry.day, entry.lesson_number)
            if pair_num not in schedule_data[group_name]:
                schedule_data[group_name][pair_num] = []
            
            schedule_data[group_name][pair_num].append({
                'subject': entry.subject.name,
                'teacher': entry.teacher.name,
                'room': entry.room.name,
                'lesson_number': entry.lesson_number,
                'time': get_lesson_time(entry.day, entry.lesson_number),
                'is_changed': getattr(entry, 'is_changed', False)
            })
        
        return render_template('schedule.html',
                             days=AVAILABLE_DAYS,
                             selected_day=day,
                             schedule_data=schedule_data,
                             groups=sorted(all_groups),
                             current_week=current_week,
                             current_semester=current_semester,
                             schedule_type=schedule_type,
                             week_parity=current_parity)
    
    @app.route('/admin')
    @login_required
    def admin():
        if current_user.role != 'admin':
            flash('Доступ запрещен', 'error')
            return redirect(url_for('index'))
        
        current_week = get_current_week()
        current_semester = get_current_semester()
        week_parity = 'even' if current_week % 2 == 0 else 'odd'
        
        entries = ScheduleEntry.query.filter_by(
            week_number=current_week, 
            semester=current_semester
        ).order_by(
            ScheduleEntry.day, ScheduleEntry.lesson_number, ScheduleEntry.group_id
        ).all()
        
        main_entries = MainScheduleEntry.query.filter_by(
            semester=current_semester
        ).filter(
            (MainScheduleEntry.week_parity == 'both') |
            (MainScheduleEntry.week_parity == week_parity)
        ).order_by(
            MainScheduleEntry.day, MainScheduleEntry.lesson_number, MainScheduleEntry.group_id
        ).all()
        
        all_teachers = Teacher.query.order_by(Teacher.name).all()
        teachers_list = [teacher.name for teacher in all_teachers]
        
        return render_template('admin.html', 
                             entries=entries,
                             main_entries=main_entries,
                             days=AVAILABLE_DAYS,
                             groups=GROUPS,
                             subjects=SUBJECTS,
                             teachers=teachers_list,
                             rooms=ROOMS,
                             week_parities=WEEK_PARITIES,
                             current_week=current_week,
                             current_semester=current_semester,
                             week_parity=week_parity)
    
    @app.route('/api/add_schedule', methods=['POST'])
    @login_required
    def add_schedule():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            data = request.get_json()
            current_week = get_current_week()
            current_semester = get_current_semester()
            is_main = data.get('is_main', 'false') == 'true'
            week_parity = data.get('week_parity', 'both')
            
            group = Group.query.filter_by(name=data['group']).first()
            if not group:
                return jsonify({'success': False, 'message': 'Группа не найдена'})
            
            if is_main:
                conflict = MainScheduleEntry.query.filter_by(
                    group_id=group.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    semester=current_semester
                ).filter(
                    (MainScheduleEntry.week_parity == week_parity) |
                    (MainScheduleEntry.week_parity == 'both') |
                    (week_parity == 'both')
                ).first()
            else:
                conflict = ScheduleEntry.query.filter_by(
                    group_id=group.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    week_number=current_week,
                    semester=current_semester
                ).first()
            
            if conflict:
                return jsonify({'success': False, 'message': 'Конфликт: группа уже занята в это время'})
            
            subject = Subject.query.filter_by(name=data['subject']).first()
            teacher = Teacher.query.filter_by(name=data['teacher']).first()
            room = Room.query.filter_by(name=data['room']).first()
            
            if not all([group, subject, teacher, room]):
                return jsonify({'success': False, 'message': 'Неверные данные'})
            
            if is_main:
                entry = MainScheduleEntry(
                    group_id=group.id,
                    subject_id=subject.id,
                    teacher_id=teacher.id,
                    room_id=room.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    week_parity=week_parity,
                    semester=current_semester
                )
            else:
                entry = ScheduleEntry(
                    group_id=group.id,
                    subject_id=subject.id,
                    teacher_id=teacher.id,
                    room_id=room.id,
                    day=data['day'],
                    lesson_number=data['lesson_number'],
                    week_number=current_week,
                    week_parity=week_parity,
                    semester=current_semester,
                    is_changed=True
                )
            
            db.session.add(entry)
            db.session.commit()
            
            if is_main:
                update_current_schedule_from_main(current_week, current_semester)
            
            return jsonify({'success': True, 'message': 'Успешно добавлено!'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})
    
    @app.route('/api/delete_schedule/<int:entry_id>', methods=['DELETE'])
    @login_required
    def delete_schedule(entry_id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            entry = ScheduleEntry.query.get(entry_id)
            if entry:
                db.session.delete(entry)
                db.session.commit()
                return jsonify({'success': True, 'message': 'Запись удалена'})
            else:
                return jsonify({'success': False, 'message': 'Запись не найдена'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})
    
    @app.route('/api/delete_main_schedule/<int:entry_id>', methods=['DELETE'])
    @login_required
    def delete_main_schedule(entry_id):
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            entry = MainScheduleEntry.query.get(entry_id)
            if entry:
                db.session.delete(entry)
                db.session.commit()
                
                current_week = get_current_week()
                current_semester = get_current_semester()
                update_current_schedule_from_main(current_week, current_semester)
                
                return jsonify({'success': True, 'message': 'Запись основного расписания удалена'})
            else:
                return jsonify({'success': False, 'message': 'Запись не найдена'})
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})
    
    @app.route('/api/next_week', methods=['POST'])
    @login_required
    def next_week():
        if current_user.role != 'admin':
            return jsonify({'success': False, 'message': 'Доступ запрещен'})
        
        try:
            current_week = get_current_week()
            next_week = current_week + 1
            
            setting = AppSettings.query.filter_by(key='current_week').first()
            if setting:
                setting.value = str(next_week)
            else:
                setting = AppSettings(key='current_week', value=str(next_week))
                db.session.add(setting)
            
            current_semester = get_current_semester()
            update_current_schedule_from_main(next_week, current_semester)
            
            db.session.commit()
            
            return jsonify({'success': True, 'message': f'Перешли на неделю {next_week}'})
            
        except Exception as e:
            db.session.rollback()
            return jsonify({'success': False, 'message': f'Ошибка: {str(e)}'})

# Вспомогательные функции
def get_current_week():
    setting = AppSettings.query.filter_by(key='current_week').first()
    if setting:
        return int(setting.value)
    else:
        setting = AppSettings(key='current_week', value='1')
        db.session.add(setting)
        db.session.commit()
        return 1

def get_current_semester():
    setting = AppSettings.query.filter_by(key='current_semester').first()
    if setting:
        return int(setting.value)
    else:
        setting = AppSettings(key='current_semester', value='1')
        db.session.add(setting)
        db.session.commit()
        return 1

def update_current_schedule_from_main(week_number, semester):
    ScheduleEntry.query.filter_by(
        week_number=week_number,
        semester=semester
    ).delete()
    
    week_parity = 'even' if week_number % 2 == 0 else 'odd'
    
    main_entries = MainScheduleEntry.query.filter_by(
        semester=semester
    ).filter(
        (MainScheduleEntry.week_parity == 'both') |
        (MainScheduleEntry.week_parity == week_parity)
    ).all()
    
    for main_entry in main_entries:
        schedule_entry = ScheduleEntry(
            group_id=main_entry.group_id,
            subject_id=main_entry.subject_id,
            teacher_id=main_entry.teacher_id,
            room_id=main_entry.room_id,
            day=main_entry.day,
            lesson_number=main_entry.lesson_number,
            week_number=week_number,
            week_parity=main_entry.week_parity,
            semester=semester,
            is_changed=False
        )
        db.session.add(schedule_entry)
    
    db.session.commit()

run.py
import os
import sys
from app import app

if __name__ == '__main__':
    # Получаем настройки из переменных окружения или используем значения по умолчанию
    host = os.environ.get('FLASK_HOST', '192.168.0.185')
    port = int(os.environ.get('FLASK_PORT', 5000))
    
    print(f"🚀 Запуск сервера расписания...")
    print(f"📡 Внешний адрес: http://{host}:{port}")
    print(f"🏠 Локальный адрес: http://localhost:{port}")
    print("=" * 50)
    print("⚡ Для остановки нажмите Ctrl+C")
    print("=" * 50)
    
    app.run(host=host, port=port, debug=True)

schedule.db

start_server.bat
@echo off
chcp 65001 > nul
title Система расписания колледжа
color 0A

echo ========================================
echo    Система расписания колледжа
echo ========================================
echo.

REM Проверка установленного Python
python --version > nul 2>&1
if errorlevel 1 (
    echo ❌ Python не установлен или не добавлен в PATH
    echo Установите Python 3.8+ с официального сайта
    echo https://www.python.org/downloads/
    pause
    exit /b 1
)

echo ✅ Python обнаружен
echo.

REM Проверка виртуального окружения
if not exist "venv\" (
    echo 🔧 Создание виртуального окружения...
    python -m venv venv
    echo ✅ Виртуальное окружение создано
    echo.
    
    echo 📦 Установка зависимостей...
    call venv\Scripts\activate.bat
    pip install --upgrade pip
    pip install flask flask-sqlalchemy flask-login werkzeug pandas openpyxl
    echo ✅ Зависимости установлены
) else (
    echo 🔧 Активация виртуального окружения...
    call venv\Scripts\activate.bat
)

echo.
echo 🚀 Запуск сервера...
echo 📡 Сервер будет доступен по адресу: http://192.168.0.185:5000
echo 📡 Локальный доступ: http://localhost:5000
echo.
echo ⚠️  Для остановки сервера нажмите Ctrl+C
echo ========================================
echo.

REM Запуск Flask приложения с указанным IP
flask run --host=192.168.0.185 --port=5000

pause

папка pages внутри:
admin_management.html
{% extends "base.html" %}

{% block title %}Управление данными{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <h2>⚙️ Управление данными системы</h2>

    <!-- Навигация -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-3">
            <a href="#subjects" class="btn btn-outline-primary w-100">📚 Предметы</a>
          </div>
          <div class="col-md-3">
            <a href="#groups" class="btn btn-outline-info w-100">👥 Группы</a>
          </div>
          <div class="col-md-3">
            <a href="#teacher-rooms" class="btn btn-outline-success w-100">🏫 Кабинеты</a>
          </div>
          <div class="col-md-3">
            <a href="#group-subjects" class="btn btn-outline-warning w-100">📊 Нагрузка групп</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Управление предметами -->
    <div id="subjects" class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">📚 Управление предметами</h5>
      </div>
      <div class="card-body">
        <form id="addSubjectForm" class="row g-3 mb-4">
          <div class="col-md-8">
            <input type="text" class="form-control" id="subjectName" placeholder="Название предмета" required>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">➕ Добавить предмет</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Название предмета</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="subjectsTable">
              {% for subject in subjects %}
              <tr id="subject-{{ subject.id }}">
                <td>{{ subject.id }}</td>
                <td>{{ subject.name }}</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-subject" data-id="{{ subject.id }}">🗑️ Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Управление группами -->
    <div id="groups" class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">👥 Управление группами</h5>
      </div>
      <div class="card-body">
        <form id="addGroupForm" class="row g-3 mb-4">
          <div class="col-md-6">
            <input type="text" class="form-control" id="groupName" placeholder="Название группы (например, 1А)"
              required>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="groupCourse" required>
              <option value="">Выберите курс</option>
              <option value="1">1 курс</option>
              <option value="2">2 курс</option>
              <option value="3">3 курс</option>
              <option value="4">4 курс</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">➕ Добавить</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Название группы</th>
                <th>Курс</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="groupsTable">
              {% for group in groups %}
              <tr id="group-{{ group.id }}">
                <td>{{ group.id }}</td>
                <td>{{ group.name }}</td>
                <td>{{ group.course }} курс</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-group" data-id="{{ group.id }}">🗑️ Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Закрепление кабинетов за преподавателями -->
    <div id="teacher-rooms" class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">🏫 Закрепление кабинетов</h5>
      </div>
      <div class="card-body">
        <form id="assignRoomForm" class="row g-3 mb-4">
          <div class="col-md-4">
            <select class="form-select" id="teacherSelect" required>
              <option value="">Выберите преподавателя</option>
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="roomSelect" required>
              <option value="">Выберите кабинет</option>
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">🔗 Закрепить</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Преподаватель</th>
                <th>Кабинет</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="teacherRoomsTable">
              {% for assignment in teacher_rooms %}
              <tr id="assignment-{{ assignment.id }}">
                <td>{{ assignment.teacher.name }}</td>
                <td>{{ assignment.room.name }}</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-assignment" data-id="{{ assignment.id }}">🗑️
                    Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Нагрузка групп по предметам -->
    <div id="group-subjects" class="card">
      <div class="card-header">
        <h5 class="mb-0">📊 Нагрузка групп по предметам</h5>
      </div>
      <div class="card-body">
        <form id="assignGroupSubjectForm" class="row g-3 mb-4">
          <div class="col-md-3">
            <select class="form-select" id="groupSelect" required>
              <option value="">Выберите группу</option>
              {% for group in groups %}
              <option value="{{ group.id }}">{{ group.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="subjectSelectLoad" required>
              <option value="">Выберите предмет</option>
              {% for subject in subjects %}
              <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" class="form-control" id="hoursPerWeek" placeholder="Часов в неделю" min="0" max="20"
              required>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-success w-100">💾 Сохранить</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Группа</th>
                <th>Предмет</th>
                <th>Часов в неделю</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody id="groupSubjectsTable">
              {% for load in group_subject_loads %}
              <tr id="load-{{ load.id }}">
                <td>{{ load.group.name }}</td>
                <td>{{ load.subject.name }}</td>
                <td>{{ load.hours_per_week }}</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-load" data-id="{{ load.id }}">🗑️ Удалить</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Добавление предмета
  document.getElementById('addSubjectForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const name = document.getElementById('subjectName').value;

    fetch('/api/add_subject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  });

  // Добавление группы
  document.getElementById('addGroupForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const name = document.getElementById('groupName').value;
    const course = document.getElementById('groupCourse').value;

    fetch('/api/add_group', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name, course: course })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  });

  // Закрепление кабинета
  document.getElementById('assignRoomForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const teacher_id = document.getElementById('teacherSelect').value;
    const room_id = document.getElementById('roomSelect').value;

    fetch('/api/assign_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ teacher_id: teacher_id, room_id: room_id })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  });

  // Назначение нагрузки группе
  document.getElementById('assignGroupSubjectForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const group_id = document.getElementById('groupSelect').value;
    const subject_id = document.getElementById('subjectSelectLoad').value;
    const hours_per_week = document.getElementById('hoursPerWeek').value;

    fetch('/api/assign_group_subject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        group_id: group_id,
        subject_id: subject_id,
        hours_per_week: hours_per_week
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('Ошибка: ' + data.message);
        }
      });
  });

  // Удаление элементов
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('delete-subject')) {
      if (confirm('Удалить предмет?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_subject/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('Ошибка: ' + data.message);
          });
      }
    }

    if (e.target.classList.contains('delete-group')) {
      if (confirm('Удалить группу?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_group/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('Ошибка: ' + data.message);
          });
      }
    }

    if (e.target.classList.contains('delete-assignment')) {
      if (confirm('Удалить закрепление?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_room_assignment/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('Ошибка: ' + data.message);
          });
      }
    }

    if (e.target.classList.contains('delete-load')) {
      if (confirm('Удалить нагрузку?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_group_subject/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('Ошибка: ' + data.message);
          });
      }
    }
  });
</script>
{% endblock %}

admin.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Админ-панель</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .sidebar {
      background: white;
      min-height: calc(100vh - 56px);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05);
    }

    .sidebar .nav-link {
      color: #333;
      padding: 12px 20px;
      border-left: 4px solid transparent;
    }

    .sidebar .nav-link:hover {
      background-color: #f8f9fa;
      border-left-color: #667eea;
    }

    .sidebar .nav-link.active {
      background-color: #eef2ff;
      border-left-color: #667eea;
      color: #667eea;
      font-weight: 600;
    }

    .main-content {
      padding: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .table-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .badge-changed {
      background-color: #ffc107;
    }

    .badge-main {
      background-color: #17a2b8;
    }
  </style>
</head>

<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">
        <i class="bi bi-gear"></i> Админ-панель
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="userInfo">Загрузка...</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">
          <i class="bi bi-box-arrow-right"></i> Выйти
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Сайдбар -->
      <div class="col-md-3 col-lg-2 sidebar p-0">
        <div class="p-3">
          <h6 class="text-uppercase text-muted mb-3">Меню</h6>
          <ul class="nav flex-column" id="sidebarMenu">
            <li class="nav-item">
              <a class="nav-link active" href="#" onclick="loadDashboard()">
                <i class="bi bi-speedometer2 me-2"></i> Панель управления
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/current_schedule">
                <i class="bi bi-calendar-event me-2"></i> Текущее расписание
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/schedule">
                <i class="bi bi-calendar-week me-2"></i> Просмотр расписания
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="loadMainSchedule()">
                <i class="bi bi-calendar-check me-2"></i> Основное расписание
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/group_management">
                <i class="bi bi-people me-2"></i> Управление группами
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="loadAddSchedule()">
                <i class="bi bi-plus-circle me-2"></i> Добавить расписание
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/teacher_load">
                <i class="bi bi-bar-chart me-2"></i> Нагрузка преподавателей
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/statistics">
                <i class="bi bi-graph-up me-2"></i> Статистика
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/semester_management">
                <i class="bi bi-calendar-month me-2"></i> Управление семестрами
              </a>
            </li>
          </ul>

          <hr class="my-4">

          <h6 class="text-uppercase text-muted mb-3">Быстрые действия</h6>
          <div class="row g-2">
            <div class="col-6">
              <div class="quick-action" onclick="quickAction('next_week')">
                <div class="action-icon">
                  <i class="bi bi-arrow-right-circle"></i>
                </div>
                <small>След. неделя</small>
              </div>
            </div>
            <div class="col-6">
              <div class="quick-action" onclick="quickAction('export')">
                <div class="action-icon">
                  <i class="bi bi-download"></i>
                </div>
                <small>Экспорт</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Основной контент -->
      <div class="col-md-9 col-lg-10 main-content">
        <div id="contentArea">
          <!-- Здесь будет загружаться контент -->
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-3">Загрузка панели управления...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления расписания -->
  <div class="modal fade" id="addScheduleModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Добавить занятие в расписание</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addScheduleForm">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="scheduleType" id="currentType" value="current"
                    checked>
                  <label class="form-check-label" for="currentType">
                    Текущее расписание
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="scheduleType" id="mainType" value="main">
                  <label class="form-check-label" for="mainType">
                    Основное расписание
                  </label>
                </div>
              </div>
              <div class="col-md-6" id="weekParityContainer" style="display: none;">
                <label class="form-label">Четность недели:</label>
                <select class="form-select" name="week_parity" id="weekParity">
                  <option value="both">Всегда</option>
                  <option value="even">Четная</option>
                  <option value="odd">Нечетная</option>
                </select>
              </div>

              <div class="col-md-6">
                <label class="form-label">Группа:</label>
                <select class="form-select" id="addGroup" required>
                  <option value="">Выберите группу</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Предмет:</label>
                <select class="form-select" id="addSubject" required>
                  <option value="">Выберите предмет</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Преподаватель:</label>
                <select class="form-select" id="addTeacher" required>
                  <option value="">Выберите преподавателя</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Аудитория:</label>
                <select class="form-select" id="addRoom" required>
                  <option value="">Выберите аудиторию</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">День недели:</label>
                <select class="form-select" id="addDay" required onchange="updatePairOptions()">
                  <option value="Понедельник">Понедельник</option>
                  <option value="Вторник">Вторник</option>
                  <option value="Среда">Среда</option>
                  <option value="Четверг">Четверг</option>
                  <option value="Пятница">Пятница</option>
                  <option value="Суббота">Суббота</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Пара:</label>
                <select class="form-select" id="addPair" required onchange="updateLessonOptions()">
                  <option value="">Выберите пару</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Урок в паре:</label>
                <select class="form-select" id="addLesson" required>
                  <option value="">Выберите урок</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Неделя (для текущего расписания):</label>
                <input type="number" class="form-control" id="addWeek" min="1" max="52" value="1">
              </div>
              <div class="col-md-6">
                <label class="form-label">Семестр:</label>
                <select class="form-select" id="addSemester">
                  <option value="1">1 семестр</option>
                  <option value="2">2 семестр</option>
                </select>
              </div>
            </div>

            <div class="alert alert-warning mt-3" id="zeroLessonWarning" style="display: none;">
              <i class="bi bi-exclamation-triangle"></i>
              <strong>Внимание:</strong> На понедельник и четверг 0 уроком могут быть только "Разговоры о важном"
            </div>
          </form>
          <div id="addScheduleMessage" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="saveSchedule()">Добавить</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Глобальные переменные
    let currentSettings = {};
    let allGroups = [];
    let allTeachers = [];
    let allSubjects = [];
    let allRooms = [];

    // Конфигурация пар
    const PAIR_CONFIG = {
      'Понедельник': { pairs: [0, 1, 2, 3, 4, 5, 6], maxPairs: 7 },
      'Вторник': { pairs: [1, 2, 3, 4, 5, 6], maxPairs: 6 },
      'Среда': { pairs: [1, 2, 3, 4, 5, 6], maxPairs: 6 },
      'Четверг': { pairs: [0, 1, 2, 3, 4, 5, 6], maxPairs: 7 },
      'Пятница': { pairs: [1, 2, 3, 4, 5, 6], maxPairs: 6 },
      'Суббота': { pairs: [1, 2, 3, 4], maxPairs: 4 }
    };

    const PAIR_TIMES = {
      0: { name: 'Пара 0 (нулевой урок)', lessons: [0], time: '8:30-9:10' },
      1: { name: 'Пара 1', lessons: [1, 2] },
      2: { name: 'Пара 2', lessons: [3, 4] },
      3: { name: 'Пара 3', lessons: [5, 6] },
      4: { name: 'Пара 4', lessons: [7, 8] },
      5: { name: 'Пара 5', lessons: [9, 10] },
      6: { name: 'Пара 6', lessons: [11, 12] }
    };

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await checkAuth();
      await loadUserInfo();
      await loadInitialData();
      await loadDashboard();
      updateNavActive();
    });

    // Проверка авторизации
    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (!data.authenticated || data.role !== 'admin') {
          window.location.href = '/login';
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login';
        return false;
      }
    }

    // Загрузка информации о пользователе
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userInfo').innerHTML = `
                        <i class="bi bi-person-circle"></i> ${data.username} (${data.role})
                    `;
        }
      } catch (error) {
        console.error('Ошибка загрузки информации о пользователе:', error);
      }
    }

    // Загрузка начальных данных
    async function loadInitialData() {
      try {
        // Загружаем группы
        const groupsResponse = await fetch('/api/data/groups');
        if (groupsResponse.ok) {
          allGroups = await groupsResponse.json();
          updateGroupSelect();
        }

        // Загружаем преподавателей
        const teachersResponse = await fetch('/api/data/teachers');
        if (teachersResponse.ok) {
          allTeachers = await teachersResponse.json();
          updateTeacherSelect();
        }

        // Загружаем предметы
        const subjectsResponse = await fetch('/api/data/subjects');
        if (subjectsResponse.ok) {
          allSubjects = await subjectsResponse.json();
          updateSubjectSelect();
        }

        // Загружаем аудитории
        const roomsResponse = await fetch('/api/data/rooms');
        if (roomsResponse.ok) {
          allRooms = await roomsResponse.json();
          updateRoomSelect();
        }

        // Загружаем настройки
        const settingsResponse = await fetch('/api/settings/current');
        if (settingsResponse.ok) {
          currentSettings = await settingsResponse.json();
        }

      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        showMessage('contentArea', 'Ошибка загрузки данных', 'danger');
      }
    }

    // Обновление выпадающих списков
    function updateGroupSelect() {
      const select = document.getElementById('addGroup');
      select.innerHTML = '<option value="">Выберите группу</option>';

      // Сортируем группы
      const sortedGroups = [...allGroups].sort((a, b) => {
        if (a.course !== b.course) return a.course - b.course;
        return a.name.localeCompare(b.name);
      });

      sortedGroups.forEach(group => {
        const option = document.createElement('option');
        option.value = group.name;
        option.textContent = `${group.name} (${group.course} курс)`;
        select.appendChild(option);
      });
    }

    function updateTeacherSelect() {
      const select = document.getElementById('addTeacher');
      select.innerHTML = '<option value="">Выберите преподавателя</option>';

      allTeachers.sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.name;
        option.textContent = teacher.name;
        select.appendChild(option);
      });
    }

    function updateSubjectSelect() {
      const select = document.getElementById('addSubject');
      select.innerHTML = '<option value="">Выберите предмет</option>';

      allSubjects.sort((a, b) => a.name.localeCompare(b.name)).forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.name;
        option.textContent = subject.name;
        select.appendChild(option);
      });
    }

    function updateRoomSelect() {
      const select = document.getElementById('addRoom');
      select.innerHTML = '<option value="">Выберите аудиторию</option>';

      allRooms.sort((a, b) => {
        const aIsNum = /^\d+$/.test(a.name);
        const bIsNum = /^\d+$/.test(b.name);
        if (aIsNum && !bIsNum) return -1;
        if (!aIsNum && bIsNum) return 1;
        if (aIsNum && bIsNum) return parseInt(a.name) - parseInt(b.name);
        return a.name.localeCompare(b.name);
      }).forEach(room => {
        const option = document.createElement('option');
        option.value = room.name;
        option.textContent = room.name;
        select.appendChild(option);
      });
    }

    // Загрузка главной панели
    async function loadDashboard() {
      try {
        document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3">Загрузка панели управления...</p>
                    </div>
                `;

        // Загружаем статистику
        const statsResponse = await fetch('/api/statistics');
        let stats = { group_stats: [], teacher_stats: [] };

        if (statsResponse.ok) {
          stats = await statsResponse.json();
        }

        // Загружаем текущее расписание
        const scheduleResponse = await fetch(`/api/schedule/current?week=${currentSettings.week || 1}&semester=${currentSettings.semester || 1}&day=Понедельник`);
        let schedule = [];

        if (scheduleResponse.ok) {
          schedule = await scheduleResponse.json();
        }

        // Отображаем панель
        const totalLessons = schedule.length;
        const changedLessons = schedule.filter(l => l.is_changed).length;
        const mainLessons = totalLessons - changedLessons;

        const html = `
                    <h3 class="mb-4">
                        <i class="bi bi-speedometer2"></i> Панель управления
                        <small class="text-muted fs-6">Неделя: ${currentSettings.week || 1}, Семестр: ${currentSettings.semester || 1}</small>
                    </h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-calendar-week"></i>
                                </div>
                                <h3>${totalLessons}</h3>
                                <p class="text-muted mb-0">Всего занятий</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-pencil-square"></i>
                                </div>
                                <h3>${changedLessons}</h3>
                                <p class="text-muted mb-0">Изменено</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-calendar-check"></i>
                                </div>
                                <h3>${mainLessons}</h3>
                                <p class="text-muted mb-0">Основных</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="bi bi-people"></i>
                                </div>
                                <h3>${allGroups.length}</h3>
                                <p class="text-muted mb-0">Групп</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-card">
                        <h5 class="mb-3">
                            <i class="bi bi-clock-history"></i> Последние занятия (понедельник)
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Группа</th>
                                        <th>Предмет</th>
                                        <th>Преподаватель</th>
                                        <th>Аудитория</th>
                                        <th>Пара</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${schedule.slice(0, 10).map(lesson => `
                                        <tr>
                                            <td>${lesson.group}</td>
                                            <td>${lesson.subject}</td>
                                            <td>${lesson.teacher}</td>
                                            <td>${lesson.room}</td>
                                            <td>${lesson.pair}</td>
                                            <td>
                                                ${lesson.is_changed ?
            '<span class="badge bg-warning">изм</span>' :
            '<span class="badge bg-success">осн</span>'
          }
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${schedule.length === 0 ? `
                                        <tr>
                                            <td colspan="6" class="text-center text-muted py-3">
                                                Нет занятий на понедельник
                                            </td>
                                        </tr>
                                    ` : ''}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

        document.getElementById('contentArea').innerHTML = html;

      } catch (error) {
        console.error('Ошибка загрузки панели:', error);
        showMessage('contentArea', 'Ошибка загрузки данных', 'danger');
      }
    }

    // Загрузка основного расписания
    async function loadMainSchedule() {
      try {
        document.getElementById('contentArea').innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-3">Загрузка основного расписания...</p>
                    </div>
                `;

        // Загружаем данные
        const response = await fetch(`/api/schedule/main?semester=${currentSettings.semester || 1}&day=Понедельник`);
        const entries = await response.json();

        // Группируем по группам
        const grouped = {};
        entries.forEach(entry => {
          if (!grouped[entry.group]) {
            grouped[entry.group] = [];
          }
          grouped[entry.group].push(entry);
        });

        // Создаем HTML
        let html = `
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-calendar-check"></i> Основное расписание</h3>
                        <div>
                            <select class="form-select form-select-sm d-inline-block w-auto" id="mainScheduleDay" onchange="filterMainSchedule()">
                                <option value="Понедельник">Понедельник</option>
                                <option value="Вторник">Вторник</option>
                                <option value="Среда">Среда</option>
                                <option value="Четверг">Четверг</option>
                                <option value="Пятница">Пятница</option>
                                <option value="Суббота">Суббота</option>
                            </select>
                            <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="mainScheduleParity" onchange="filterMainSchedule()">
                                <option value="both">Все недели</option>
                                <option value="even">Четные</option>
                                <option value="odd">Нечетные</option>
                            </select>
                        </div>
                    </div>
                `;

        // Для каждой группы
        Object.keys(grouped).sort().forEach(groupName => {
          const groupEntries = grouped[groupName];

          html += `
                        <div class="table-card mb-3">
                            <h5 class="mb-3">Группа: ${groupName}</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Пара</th>
                                            <th>Предмет</th>
                                            <th>Преподаватель</th>
                                            <th>Аудитория</th>
                                            <th>Четность</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

          groupEntries.sort((a, b) => a.lesson_number - b.lesson_number).forEach(entry => {
            html += `
                            <tr>
                                <td>${entry.pair} (урок ${entry.lesson_number})</td>
                                <td>${entry.subject}</td>
                                <td>${entry.teacher}</td>
                                <td>${entry.room}</td>
                                <td>
                                    ${entry.week_parity === 'even' ? 'четная' :
                entry.week_parity === 'odd' ? 'нечетная' : 'всегда'}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteMainSchedule(${entry.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
          });

          html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
        });

        if (Object.keys(grouped).length === 0) {
          html += `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Нет данных для отображения
                        </div>
                    `;
        }

        document.getElementById('contentArea').innerHTML = html;

      } catch (error) {
        console.error('Ошибка загрузки основного расписания:', error);
        showMessage('contentArea', 'Ошибка загрузки данных', 'danger');
      }
    }

    // Фильтрация основного расписания
    async function filterMainSchedule() {
      const day = document.getElementById('mainScheduleDay').value;
      const parity = document.getElementById('mainScheduleParity').value;

      try {
        const response = await fetch(`/api/schedule/main?semester=${currentSettings.semester || 1}&day=${day}&week_parity=${parity}`);
        const entries = await response.json();

        // Обновляем таблицу
        const grouped = {};
        entries.forEach(entry => {
          if (!grouped[entry.group]) {
            grouped[entry.group] = [];
          }
          grouped[entry.group].push(entry);
        });

        // Находим все таблицы групп и обновляем их
        const groupCards = document.querySelectorAll('.table-card');

        // Удаляем старые карточки, кроме первой (заголовок)
        groupCards.forEach((card, index) => {
          if (index > 0) {
            card.remove();
          }
        });

        // Добавляем новые карточки
        const contentArea = document.getElementById('contentArea');

        Object.keys(grouped).sort().forEach(groupName => {
          const groupEntries = grouped[groupName];

          let cardHtml = `
                        <div class="table-card mb-3">
                            <h5 class="mb-3">Группа: ${groupName}</h5>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Пара</th>
                                            <th>Предмет</th>
                                            <th>Преподаватель</th>
                                            <th>Аудитория</th>
                                            <th>Четность</th>
                                            <th>Действия</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

          groupEntries.sort((a, b) => a.lesson_number - b.lesson_number).forEach(entry => {
            cardHtml += `
                            <tr>
                                <td>${entry.pair} (урок ${entry.lesson_number})</td>
                                <td>${entry.subject}</td>
                                <td>${entry.teacher}</td>
                                <td>${entry.room}</td>
                                <td>
                                    ${entry.week_parity === 'even' ? 'четная' :
                entry.week_parity === 'odd' ? 'нечетная' : 'всегда'}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteMainSchedule(${entry.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
          });

          cardHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;

          // Добавляем после заголовка
          contentArea.insertAdjacentHTML('beforeend', cardHtml);
        });

        // Если нет данных
        if (Object.keys(grouped).length === 0) {
          contentArea.insertAdjacentHTML('beforeend', `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> Нет данных для отображения
                        </div>
                    `);
        }

      } catch (error) {
        console.error('Ошибка фильтрации:', error);
      }
    }

    // Удаление из основного расписания
    async function deleteMainSchedule(id) {
      if (!confirm('Удалить это занятие из основного расписания?')) {
        return;
      }

      try {
        const response = await fetch(`/api/schedule/main/delete/${id}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          alert('Занятие удалено');
          loadMainSchedule();
        } else {
          alert('Ошибка: ' + data.message);
        }
      } catch (error) {
        alert('Ошибка сети: ' + error.message);
      }
    }

    // Загрузка формы добавления расписания
    function loadAddSchedule() {
      const html = `
                <h3 class="mb-4"><i class="bi bi-plus-circle"></i> Добавить занятие в расписание</h3>
                
                <div class="table-card">
                    <p class="mb-4">Используйте кнопку ниже, чтобы открыть форму добавления занятия:</p>
                    
                    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                        <i class="bi bi-plus-circle"></i> Открыть форму добавления
                    </button>
                    
                    <hr class="my-4">
                    
                    <h5><i class="bi bi-info-circle"></i> Инструкция:</h5>
                    <ol>
                        <li>Выберите тип расписания (текущее или основное)</li>
                        <li>Выберите группу, предмет, преподавателя и аудиторию</li>
                        <li>Выберите день недели и пару</li>
                        <li>Для основного расписания укажите четность недели</li>
                        <li>Нажмите "Добавить"</li>
                    </ol>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Важно:</strong> На понедельник и четверг 0 уроком могут быть только "Разговоры о важном"
                    </div>
                </div>
            `;

      document.getElementById('contentArea').innerHTML = html;

      // Сбрасываем форму
      document.getElementById('addScheduleForm').reset();
      document.getElementById('weekParityContainer').style.display = 'none';
      document.getElementById('zeroLessonWarning').style.display = 'none';

      // Обновляем опции пар
      updatePairOptions();
    }

    // Обновление опций пар
    function updatePairOptions() {
      const day = document.getElementById('addDay').value;
      const pairSelect = document.getElementById('addPair');

      pairSelect.innerHTML = '<option value="">Выберите пару</option>';

      const availablePairs = PAIR_CONFIG[day]?.pairs || [];

      availablePairs.forEach(pairNum => {
        const option = document.createElement('option');
        option.value = pairNum;
        option.textContent = PAIR_TIMES[pairNum]?.name || `Пара ${pairNum}`;
        pairSelect.appendChild(option);
      });

      // Сбрасываем уроки
      document.getElementById('addLesson').innerHTML = '<option value="">Выберите урок</option>';
    }

    // Обновление опций уроков
    function updateLessonOptions() {
      const pairNum = parseInt(document.getElementById('addPair').value);
      const day = document.getElementById('addDay').value;
      const lessonSelect = document.getElementById('addLesson');
      const warning = document.getElementById('zeroLessonWarning');

      lessonSelect.innerHTML = '<option value="">Выберите урок</option>';

      if (isNaN(pairNum)) return;

      const lessons = PAIR_TIMES[pairNum]?.lessons || [];

      lessons.forEach(lessonNum => {
        const option = document.createElement('option');
        option.value = lessonNum;
        option.textContent = `Урок ${lessonNum}`;
        lessonSelect.appendChild(option);
      });

      // Проверяем нулевой урок
      checkZeroLesson();
    }

    // Проверка нулевого урока
    function checkZeroLesson() {
      const day = document.getElementById('addDay').value;
      const lessonNum = parseInt(document.getElementById('addLesson').value);
      const subject = document.getElementById('addSubject').value;
      const warning = document.getElementById('zeroLessonWarning');

      if ((day === 'Понедельник' || day === 'Четверг') && lessonNum === 0 && subject !== 'Разговоры о важном') {
        warning.style.display = 'block';

        // Автоматически выбираем "Разговоры о важном"
        const subjectSelect = document.getElementById('addSubject');
        for (let i = 0; i < subjectSelect.options.length; i++) {
          if (subjectSelect.options[i].value === 'Разговоры о важном') {
            subjectSelect.selectedIndex = i;
            break;
          }
        }
      } else {
        warning.style.display = 'none';
      }
    }

    // Сохранение расписания
    async function saveSchedule() {
      const form = document.getElementById('addScheduleForm');
      const formData = new FormData(form);
      const scheduleType = formData.get('scheduleType');
      const isMain = scheduleType === 'main';

      // Получаем данные
      const day = document.getElementById('addDay').value;
      const lessonNumber = parseInt(document.getElementById('addLesson').value);
      const subject = document.getElementById('addSubject').value;

      // Проверка нулевого урока
      if ((day === 'Понедельник' || day === 'Четверг') && lessonNumber === 0 && subject !== 'Разговоры о важном') {
        alert('Ошибка: На 0 урок можно поставить только "Разговоры о важном"');
        return;
      }

      const data = {
        is_main: isMain,
        group: document.getElementById('addGroup').value,
        subject: subject,
        teacher: document.getElementById('addTeacher').value,
        room: document.getElementById('addRoom').value,
        day: day,
        lesson_number: lessonNumber,
        week: parseInt(document.getElementById('addWeek').value) || 1,
        semester: parseInt(document.getElementById('addSemester').value) || 1
      };

      if (isMain) {
        data.week_parity = document.getElementById('weekParity').value;
      }

      try {
        const response = await fetch('/api/schedule/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
          // Закрываем модальное окно
          const modal = bootstrap.Modal.getInstance(document.getElementById('addScheduleModal'));
          modal.hide();

          // Показываем сообщение
          showMessage('contentArea', 'Занятие успешно добавлено', 'success');

          // Обновляем текущий вид
          if (isMain) {
            loadMainSchedule();
          } else {
            loadDashboard();
          }
        } else {
          document.getElementById('addScheduleMessage').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> ${result.message}
                        </div>
                    `;
        }

      } catch (error) {
        document.getElementById('addScheduleMessage').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка сети: ${error.message}
                    </div>
                `;
      }
    }

    // Быстрые действия
    async function quickAction(action) {
      switch (action) {
        case 'next_week':
          if (confirm('Перейти на следующую неделю?')) {
            const newWeek = (currentSettings.week || 1) + 1;

            try {
              const response = await fetch('/api/settings/set_week', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ week: newWeek })
              });

              const data = await response.json();

              if (data.success) {
                currentSettings.week = newWeek;
                loadDashboard();
                alert('Перешли на неделю ' + newWeek);
              } else {
                alert('Ошибка: ' + data.message);
              }
            } catch (error) {
              alert('Ошибка сети: ' + error.message);
            }
          }
          break;

        case 'export':
          alert('Функция экспорта пока не реализована');
          break;
      }
    }

    // Выход из системы
    async function logout() {
      try {
        const response = await fetch('/api/logout', {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          window.location.href = '/';
        }
      } catch (error) {
        window.location.href = '/';
      }
    }

    // Обновление активного пункта меню
    function updateNavActive() {
      const currentPath = window.location.pathname;
      const navLinks = document.querySelectorAll('.sidebar .nav-link');

      navLinks.forEach(link => {
        link.classList.remove('active');

        if (link.getAttribute('href') === currentPath) {
          link.classList.add('active');
        } else if (link.getAttribute('href') === '#' && currentPath === '/admin') {
          link.classList.add('active');
        }
      });
    }

    // Вспомогательная функция для отображения сообщений
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
    }

    // Добавляем обработчики событий
    document.getElementById('addDay').addEventListener('change', function () {
      updatePairOptions();
      updateLessonOptions();
    });

    document.getElementById('addPair').addEventListener('change', updateLessonOptions);

    document.getElementById('addLesson').addEventListener('change', checkZeroLesson);
    document.getElementById('addSubject').addEventListener('change', checkZeroLesson);

    // Обработчик изменения типа расписания
    document.querySelectorAll('input[name="scheduleType"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const isMain = this.value === 'main';
        document.getElementById('weekParityContainer').style.display = isMain ? 'block' : 'none';
      });
    });
  </script>
</body>

</html>

base.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Расписание колледжа{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .navbar-brand {
      font-weight: bold;
    }

    .lesson-card {
      border-left: 4px solid #007bff;
    }

    .table-schedule th {
      background-color: #f8f9fa;
    }

    .admin-menu {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
    }

    .changed-lesson {
      background-color: #fff3cd !important;
      border-left: 4px solid #ffc107;
    }

    .main-lesson {
      background-color: #d1ecf1 !important;
      border-left: 4px solid #17a2b8;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">📚 Расписание Колледжа</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <div class="navbar-nav ms-auto">
          <a class="nav-link" href="/schedule">📅 Расписание</a>
          <a class="nav-link" href="/schedule?type=main">📋 Основное расписание</a>
          {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <a class="nav-link" href="/admin">⚙️ Админ-панель</a>
          <a class="nav-link" href="/semester_management">🎓 Семестры</a>
          <a class="nav-link" href="/teacher_load">📊 Нагрузка преподавателей</a>
          <a class="nav-link" href="/group_statistics">👥 Нагрузка групп</a>
          <a class="nav-link" href="/statistics">📈 Статистика</a>
          <a class="nav-link" href="/logout">🚪 Выйти</a>
          {% elif not current_user.is_authenticated %}
          <a class="nav-link" href="/login">🔐 Войти</a>
          {% endif %}
        </div>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>

current_schedule.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Текущее расписание</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .schedule-table {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .pair-header {
      background-color: #f8f9fa;
      font-weight: bold;
      text-align: center;
    }

    .lesson-cell {
      min-height: 120px;
      vertical-align: top;
      position: relative;
      border-right: 1px solid #dee2e6;
      border-bottom: 1px solid #dee2e6;
    }

    .lesson-card {
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 5px;
      font-size: 0.85rem;
      position: relative;
    }

    .main-lesson {
      background-color: #d1ecf1;
      border-left: 4px solid #17a2b8;
    }

    .changed-lesson {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .combined-lesson {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
    }

    .practice-lesson {
      background-color: #d4edda;
      border-left: 4px solid #28a745;
    }

    .zero-lesson {
      background-color: #e9ecef;
      border-left: 4px solid #6c757d;
    }

    .lesson-actions {
      position: absolute;
      top: 5px;
      right: 5px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .lesson-card:hover .lesson-actions {
      opacity: 1;
    }

    .btn-floating {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      margin-bottom: 10px;
    }

    .badge-combined {
      background-color: #dc3545;
    }

    .badge-practice {
      background-color: #28a745;
    }

    .auto-fill-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 1000;
    }

    .gaps-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      font-size: 0.7rem;
    }

    .empty-slot {
      cursor: pointer;
      transition: all 0.3s;
    }

    .empty-slot:hover {
      background-color: #f8f9fa;
      border: 2px dashed #007bff;
    }
  </style>
</head>

<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">
        <i class="bi bi-arrow-left"></i> Текущее расписание
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="currentInfo">
          <i class="bi bi-calendar-week"></i> Загрузка...
        </span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- Фильтры -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-3">
            <label class="form-label">День недели:</label>
            <select class="form-select" id="daySelect" onchange="loadSchedule()">
              <option value="Понедельник">Понедельник</option>
              <option value="Вторник">Вторник</option>
              <option value="Среда">Среда</option>
              <option value="Четверг">Четверг</option>
              <option value="Пятница">Пятница</option>
              <option value="Суббота">Суббота</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Неделя:</label>
            <input type="number" class="form-control" id="weekInput" min="1" max="52" value="1"
              onchange="loadSchedule()">
          </div>
          <div class="col-md-2">
            <label class="form-label">Семестр:</label>
            <select class="form-select" id="semesterSelect" onchange="loadSchedule()">
              <option value="1">1 семестр</option>
              <option value="2">2 семестр</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Группа (фильтр):</label>
            <select class="form-select" id="groupFilter" onchange="filterSchedule()">
              <option value="">Все группы</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="loadSchedule()">
              <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-12">
            <div class="btn-group">
              <button class="btn btn-outline-success" onclick="showAddModal()">
                <i class="bi bi-plus-circle"></i> Добавить занятие
              </button>
              <button class="btn btn-outline-info" onclick="showAutoFillModal()">
                <i class="bi bi-magic"></i> Автозаполнение
              </button>
              <button class="btn btn-outline-warning" onclick="checkGaps()">
                <i class="bi bi-hourglass-split"></i> Проверить пропуски
              </button>
              <button class="btn btn-outline-danger" onclick="clearDay()">
                <i class="bi bi-trash"></i> Очистить день
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Информация о пропусках -->
    <div class="alert alert-info" id="gapsAlert" style="display: none;">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <i class="bi bi-info-circle"></i>
          <span id="gapsMessage">Обнаружены пропуски в расписании</span>
        </div>
        <button class="btn btn-sm btn-outline-primary" onclick="fillGaps()">
          <i class="bi bi-magic"></i> Заполнить автоматически
        </button>
      </div>
    </div>

    <!-- Таблица расписания -->
    <div class="schedule-table">
      <div id="scheduleContainer">
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
          <p class="mt-3">Загрузка расписания...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Кнопки действий -->
  <div class="action-buttons" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
    <button class="btn btn-primary btn-floating" onclick="showAddModal()" title="Добавить занятие">
      <i class="bi bi-plus-lg"></i>
    </button>
    <button class="btn btn-info btn-floating" onclick="showAutoFillModal()" title="Автозаполнение">
      <i class="bi bi-magic"></i>
    </button>
    <button class="btn btn-success btn-floating" onclick="loadSchedule()" title="Обновить">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  </div>

  <!-- Кнопка автозаполнения пропусков -->
  <div class="auto-fill-btn" id="autoFillButton" style="display: none;">
    <button class="btn btn-warning btn-floating" onclick="fillGaps()" title="Заполнить пропуски">
      <i class="bi bi-patch-check"></i>
    </button>
  </div>

  <!-- Модальное окно добавления -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Добавить занятие</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Группа *</label>
                <select class="form-select" id="addGroup" required>
                  <option value="">Выберите группу</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Предмет *</label>
                <select class="form-select" id="addSubject" required onchange="checkZeroLesson()">
                  <option value="">Выберите предмет</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Преподаватель *</label>
                <select class="form-select" id="addTeacher" required>
                  <option value="">Выберите преподавателя</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Аудитория *</label>
                <select class="form-select" id="addRoom" required>
                  <option value="">Выберите аудиторию</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">День недели *</label>
                <select class="form-select" id="addDay" required>
                  <option value="">Выберите день</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Пара *</label>
                <select class="form-select" id="addPair" required onchange="updateLessonOptions()">
                  <option value="">Выберите пару</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Урок в паре *</label>
                <select class="form-select" id="addLesson" required onchange="checkZeroLesson()">
                  <option value="">Выберите урок</option>
                </select>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="addIsCombined">
                  <label class="form-check-label" for="addIsCombined">
                    Совмещенное занятие (выделится красным)
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="addIsPractice">
                  <label class="form-check-label" for="addIsPractice">
                    Практическое занятие
                  </label>
                </div>
              </div>
            </div>

            <div class="alert alert-warning mt-3" id="zeroLessonWarning" style="display: none;">
              <i class="bi bi-exclamation-triangle"></i>
              <strong>Внимание:</strong> На понедельник и четверг 0 уроком могут быть только "Разговоры о важном"
            </div>

            <div class="alert alert-info mt-3" id="availabilityInfo" style="display: none;">
              <i class="bi bi-info-circle"></i>
              <div id="availabilityMessage"></div>
            </div>
          </form>
          <div id="addMessage" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="addLesson()">Добавить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно редактирования -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Редактировать занятие</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" id="editLessonId">
            <div class="mb-3">
              <label class="form-label">Предмет</label>
              <select class="form-select" id="editSubject">
                <option value="">Выберите предмет</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Преподаватель</label>
              <select class="form-select" id="editTeacher">
                <option value="">Выберите преподавателя</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Аудитория</label>
              <select class="form-select" id="editRoom">
                <option value="">Выберите аудиторию</option>
              </select>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="editIsCombined">
                <label class="form-check-label" for="editIsCombined">
                  Совмещенное занятие
                </label>
              </div>
            </div>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              Группа, день, пара и урок не могут быть изменены
            </div>
          </form>
          <div id="editMessage" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="saveEdit()">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно автозаполнения -->
  <div class="modal fade" id="autoFillModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Автоматическое заполнение расписания</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Тип заполнения:</label>
            <select class="form-select" id="fillType">
              <option value="full">Полное заполнение</option>
              <option value="gaps_only">Только пропуски</option>
              <option value="practice_only">Только практика</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Группы:</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="allGroups" checked onchange="toggleGroupSelection()">
              <label class="form-check-label" for="allGroups">
                Все группы
              </label>
            </div>

            <div id="groupSelection" class="mt-2" style="max-height: 200px; overflow-y: auto;">
              <!-- Группы будут загружены динамически -->
            </div>
          </div>

          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Полное заполнение:</strong> Создает расписание на основе предметов групп<br>
            <strong>Только пропуски:</strong> Заполняет пустые слоты в существующем расписании<br>
            <strong>Только практика:</strong> Заполняет дни практики для групп 2-4 курсов
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="startAutoFill()">Запустить</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Глобальные переменные
    let currentSettings = {};
    let allGroups = [];
    let allTeachers = [];
    let allSubjects = [];
    let allRooms = [];
    let currentSchedule = [];
    let currentDay = 'Понедельник';
    let currentWeek = 1;
    let currentSemester = 1;
    let selectedGroup = '';
    let hasGaps = false;

    // Конфигурация пар
    const PAIR_CONFIG = {
      'Понедельник': { pairs: [0, 1, 2, 3, 4, 5, 6], maxPairs: 7 },
      'Вторник': { pairs: [1, 2, 3, 4, 5, 6], maxPairs: 6 },
      'Среда': { pairs: [1, 2, 3, 4, 5, 6], maxPairs: 6 },
      'Четверг': { pairs: [0, 1, 2, 3, 4, 5, 6], maxPairs: 7 },
      'Пятница': { pairs: [1, 2, 3, 4, 5, 6], maxPairs: 6 },
      'Суббота': { pairs: [1, 2, 3, 4], maxPairs: 4 }
    };

    const PAIR_TIMES = {
      0: { name: 'Пара 0 (нулевой урок)', lessons: [0], time: '8:30-9:10' },
      1: { name: 'Пара 1', lessons: [1, 2] },
      2: { name: 'Пара 2', lessons: [3, 4] },
      3: { name: 'Пара 3', lessons: [5, 6] },
      4: { name: 'Пара 4', lessons: [7, 8] },
      5: { name: 'Пара 5', lessons: [9, 10] },
      6: { name: 'Пара 6', lessons: [11, 12] }
    };

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await checkAuth();
      await loadSettings();
      await loadInitialData();
      await loadSchedule();
    });

    // Проверка авторизации
    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (!data.authenticated || data.role !== 'admin') {
          window.location.href = '/login';
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login';
        return false;
      }
    }

    // Загрузка настроек
    async function loadSettings() {
      try {
        const response = await fetch('/api/settings/current');
        if (response.ok) {
          currentSettings = await response.json();
          currentWeek = currentSettings.week || 1;
          currentSemester = currentSettings.semester || 1;

          document.getElementById('weekInput').value = currentWeek;
          document.getElementById('semesterSelect').value = currentSemester;
        }
      } catch (error) {
        console.error('Ошибка загрузки настроек:', error);
      }
    }

    // Загрузка начальных данных
    async function loadInitialData() {
      try {
        // Загружаем группы
        const groupsResponse = await fetch('/api/data/groups');
        if (groupsResponse.ok) {
          allGroups = await groupsResponse.json();
          updateGroupFilters();
          updateGroupSelection();
        }

        // Загружаем преподавателей
        const teachersResponse = await fetch('/api/data/teachers');
        if (teachersResponse.ok) {
          allTeachers = await teachersResponse.json();
          updateTeacherSelect();
        }

        // Загружаем предметы
        const subjectsResponse = await fetch('/api/data/subjects');
        if (subjectsResponse.ok) {
          allSubjects = await subjectsResponse.json();
          updateSubjectSelect();
        }

        // Загружаем аудитории
        const roomsResponse = await fetch('/api/data/rooms');
        if (roomsResponse.ok) {
          allRooms = await roomsResponse.json();
          updateRoomSelect();
        }

      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        showMessage('scheduleContainer', 'Ошибка загрузки данных', 'danger');
      }
    }

    // Обновление фильтров групп
    function updateGroupFilters() {
      const groupFilter = document.getElementById('groupFilter');
      const addGroupSelect = document.getElementById('addGroup');

      groupFilter.innerHTML = '<option value="">Все группы</option>';
      addGroupSelect.innerHTML = '<option value="">Выберите группу</option>';

      // Сортируем группы по курсам
      const sortedGroups = [...allGroups].sort((a, b) => {
        if (a.course !== b.course) return a.course - b.course;
        return a.name.localeCompare(b.name);
      });

      sortedGroups.forEach(group => {
        // Для фильтра
        const option1 = document.createElement('option');
        option1.value = group.name;
        let label = `${group.name} (${group.course} курс)`;
        if (group.has_practice && group.practice_day) {
          label += ` - практика: ${group.practice_day}`;
        }
        option1.textContent = label;
        groupFilter.appendChild(option1);

        // Для формы добавления
        const option2 = document.createElement('option');
        option2.value = group.name;
        option2.textContent = `${group.name} (${group.course} курс)`;
        addGroupSelect.appendChild(option2);
      });
    }

    // Обновление выбора групп для автозаполнения
    function updateGroupSelection() {
      const groupSelection = document.getElementById('groupSelection');
      groupSelection.innerHTML = '';

      const sortedGroups = [...allGroups].sort((a, b) => {
        if (a.course !== b.course) return a.course - b.course;
        return a.name.localeCompare(b.name);
      });

      sortedGroups.forEach(group => {
        const div = document.createElement('div');
        div.className = 'form-check';
        div.innerHTML = `
          <input class="form-check-input group-checkbox" type="checkbox" value="${group.id}" id="group-${group.id}" checked>
          <label class="form-check-label" for="group-${group.id}">
            ${group.name} (${group.course} курс)
            ${group.has_practice && group.practice_day ? `<small class="text-muted"> - практика: ${group.practice_day}</small>` : ''}
          </label>
        `;
        groupSelection.appendChild(div);
      });
    }

    function toggleGroupSelection() {
      const allGroupsCheckbox = document.getElementById('allGroups');
      const groupCheckboxes = document.querySelectorAll('.group-checkbox');

      groupCheckboxes.forEach(cb => {
        cb.checked = allGroupsCheckbox.checked;
        cb.disabled = allGroupsCheckbox.checked;
      });
    }

    function updateTeacherSelect() {
      const addTeacher = document.getElementById('addTeacher');
      const editTeacher = document.getElementById('editTeacher');

      addTeacher.innerHTML = '<option value="">Выберите преподавателя</option>';
      editTeacher.innerHTML = '<option value="">Выберите преподавателя</option>';

      allTeachers.sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
        const option1 = document.createElement('option');
        option1.value = teacher.name;
        option1.textContent = teacher.name;
        addTeacher.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = teacher.name;
        option2.textContent = teacher.name;
        editTeacher.appendChild(option2);
      });
    }

    function updateSubjectSelect() {
      const addSubject = document.getElementById('addSubject');
      const editSubject = document.getElementById('editSubject');

      addSubject.innerHTML = '<option value="">Выберите предмет</option>';
      editSubject.innerHTML = '<option value="">Выберите предмет</option>';

      allSubjects.sort((a, b) => a.name.localeCompare(b.name)).forEach(subject => {
        const option1 = document.createElement('option');
        option1.value = subject.name;
        option1.textContent = subject.name;
        addSubject.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = subject.name;
        option2.textContent = subject.name;
        editSubject.appendChild(option2);
      });
    }

    function updateRoomSelect() {
      const addRoom = document.getElementById('addRoom');
      const editRoom = document.getElementById('editRoom');

      addRoom.innerHTML = '<option value="">Выберите аудиторию</option>';
      editRoom.innerHTML = '<option value="">Выберите аудиторию</option>';

      allRooms.sort((a, b) => {
        const aIsNum = /^\d+$/.test(a.name);
        const bIsNum = /^\d+$/.test(b.name);
        if (aIsNum && !bIsNum) return -1;
        if (!aIsNum && bIsNum) return 1;
        if (aIsNum && bIsNum) return parseInt(a.name) - parseInt(b.name);
        return a.name.localeCompare(b.name);
      }).forEach(room => {
        const option1 = document.createElement('option');
        option1.value = room.name;
        option1.textContent = room.name;
        addRoom.appendChild(option1);

        const option2 = document.createElement('option');
        option2.value = room.name;
        option2.textContent = room.name;
        editRoom.appendChild(option2);
      });
    }

    // Загрузка расписания
    async function loadSchedule() {
      currentDay = document.getElementById('daySelect').value;
      currentWeek = parseInt(document.getElementById('weekInput').value) || 1;
      currentSemester = parseInt(document.getElementById('semesterSelect').value) || 1;
      selectedGroup = document.getElementById('groupFilter').value;

      // Обновляем информацию в заголовке
      document.getElementById('currentInfo').innerHTML = `
                <i class="bi bi-calendar-week"></i> ${currentDay}, неделя ${currentWeek}
            `;

      // Показываем загрузку
      document.getElementById('scheduleContainer').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3">Загрузка расписания...</p>
                </div>
            `;

      try {
        const response = await fetch(
          `/api/schedule/current?day=${encodeURIComponent(currentDay)}&week=${currentWeek}&semester=${currentSemester}`
        );

        if (!response.ok) {
          throw new Error('Ошибка загрузки расписания');
        }

        currentSchedule = await response.json();
        renderSchedule();

        // Проверяем пропуски
        await checkGaps();

      } catch (error) {
        console.error('Ошибка:', error);
        document.getElementById('scheduleContainer').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки расписания: ${error.message}
                    </div>
                `;
      }
    }

    // Отображение расписания
    function renderSchedule() {
      // Фильтруем по выбранной группе
      let filteredSchedule = currentSchedule;
      if (selectedGroup) {
        filteredSchedule = currentSchedule.filter(lesson => lesson.group === selectedGroup);
      }

      // Группируем по группам и парам
      const groupedByGroup = {};
      filteredSchedule.forEach(lesson => {
        if (!groupedByGroup[lesson.group]) {
          groupedByGroup[lesson.group] = {};
        }
        if (!groupedByGroup[lesson.group][lesson.pair]) {
          groupedByGroup[lesson.group][lesson.pair] = [];
        }
        groupedByGroup[lesson.group][lesson.pair].push(lesson);
      });

      // Получаем список всех групп
      let groups = Object.keys(groupedByGroup);
      if (!selectedGroup) {
        // Если не выбрана конкретная группа, показываем все группы
        groups = [...new Set(currentSchedule.map(lesson => lesson.group))].sort();
      }

      // Получаем доступные пары для текущего дня
      const availablePairs = PAIR_CONFIG[currentDay]?.pairs || [];

      // Если нет данных, показываем сообщение
      if (groups.length === 0) {
        document.getElementById('scheduleContainer').innerHTML = `
                    <div class="text-center p-5">
                        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3">Нет занятий</h4>
                        <p class="text-muted">На ${currentDay} нет занятий для выбранных групп</p>
                        <button class="btn btn-primary mt-3" onclick="showAddModal()">
                            <i class="bi bi-plus-circle"></i> Добавить первое занятие
                        </button>
                    </div>
                `;
        return;
      }

      // Создаем таблицу
      let html = `
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th class="pair-header" style="width: 120px;">Пара / Группа</th>
            `;

      // Заголовки групп
      groups.forEach(group => {
        html += `<th class="pair-header">${group}</th>`;
      });

      html += `</tr></thead><tbody>`;

      // Строки с парами
      availablePairs.forEach(pairNum => {
        const pairInfo = PAIR_TIMES[pairNum];
        let pairTime = '';

        if (pairNum === 0) {
          pairTime = '8:30-9:10';
        } else if (pairNum === 1) {
          if (currentDay === 'Понедельник' || currentDay === 'Четверг') {
            pairTime = '9:15-9:55, 10:00-10:40';
          } else if (currentDay === 'Суббота') {
            pairTime = '8:00-8:40, 8:45-9:25';
          } else {
            pairTime = '8:30-9:10, 9:15-9:55';
          }
        } else if (pairNum === 2) {
          if (currentDay === 'Понедельник' || currentDay === 'Четверг') {
            pairTime = '11:20-12:00, 12:05-12:45';
          } else if (currentDay === 'Суббота') {
            pairTime = '9:30-10:10, 10:15-10:55';
          } else {
            pairTime = '10:35-11:15, 11:20-12:00';
          }
        } else if (pairNum === 3) {
          if (currentDay === 'Понедельник' || currentDay === 'Четверг') {
            pairTime = '13:25-14:05, 14:10-14:50';
          } else if (currentDay === 'Суббота') {
            pairTime = '11:00-11:40, 11:45-12:25';
          } else {
            pairTime = '12:40-13:20, 13:25-14:05';
          }
        } else if (pairNum === 4) {
          if (currentDay === 'Понедельник' || currentDay === 'Четверг') {
            pairTime = '15:00-15:40, 15:45-16:25';
          } else if (currentDay === 'Суббота') {
            pairTime = '12:30-13:10, 13:15-13:55';
          } else {
            pairTime = '14:15-14:55, 15:00-15:40';
          }
        } else if (pairNum === 5) {
          if (currentDay === 'Понедельник' || currentDay === 'Четверг') {
            pairTime = '16:30-17:10, 17:15-17:55';
          } else {
            pairTime = '15:45-16:25, 16:30-17:10';
          }
        } else if (pairNum === 6) {
          if (currentDay === 'Понедельник' || currentDay === 'Четверг') {
            pairTime = '18:00-18:40, 18:45-19:25';
          } else {
            pairTime = '17:15-17:55, 18:00-18:40';
          }
        }

        html += `
                    <tr>
                        <td class="pair-header">
                            <strong>${pairInfo.name}</strong>
                            <div class="small text-muted">${pairTime}</div>
                        </td>
                `;

        // Ячейки для каждой группы
        groups.forEach(group => {
          const lessons = groupedByGroup[group]?.[pairNum] || [];
          html += `<td class="lesson-cell p-2" id="cell-${group}-${pairNum}">`;

          if (lessons.length === 0) {
            // Пустая ячейка - потенциальный пропуск
            html += `
                            <div class="empty-slot text-center text-muted py-4" 
                                 onclick="fillEmptySlot('${group}', ${pairNum})"
                                 title="Кликните для заполнения пропуска">
                                <i class="bi bi-plus-circle"></i><br>
                                <small>Добавить занятие</small>
                            </div>
                        `;
          } else {
            lessons.forEach(lesson => {
              let lessonClass = '';
              if (lesson.lesson_number === 0) {
                lessonClass = 'zero-lesson';
              } else if (lesson.is_combined) {
                lessonClass = 'combined-lesson';
              } else if (lesson.is_changed) {
                lessonClass = 'changed-lesson';
              } else {
                lessonClass = 'main-lesson';
              }

              // Проверяем, является ли это практикой
              const groupInfo = allGroups.find(g => g.name === group);
              if (groupInfo && groupInfo.has_practice && groupInfo.practice_day === currentDay) {
                lessonClass = 'practice-lesson';
              }

              html += `
                                <div class="lesson-card ${lessonClass}" id="lesson-${lesson.id}">
                                    <div class="lesson-actions">
                                        <button class="btn btn-sm btn-warning me-1" onclick="showEditModal(${lesson.id})" title="Редактировать">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteLesson(${lesson.id})" title="Удалить">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <div class="fw-bold">${lesson.subject}</div>
                                    <div class="small">${lesson.teacher}</div>
                                    <div class="small text-muted">ауд. ${lesson.room}</div>
                                    <div class="small">урок ${lesson.lesson_number}</div>
                                    ${lesson.is_changed ? '<span class="badge bg-warning badge-sm">изм</span>' : ''}
                                    ${lesson.is_combined ? '<span class="badge badge-combined badge-sm">совм</span>' : ''}
                                    ${(groupInfo && groupInfo.has_practice && groupInfo.practice_day === currentDay) ?
                  '<span class="badge badge-practice badge-sm">практ</span>' : ''}
                                </div>
                            `;
            });
          }

          html += `</td>`;
        });

        html += `</tr>`;
      });

      html += `</tbody></table></div>`;

      document.getElementById('scheduleContainer').innerHTML = html;
    }

    // Заполнить пустой слот
    async function fillEmptySlot(groupName, pairNum) {
      const group = allGroups.find(g => g.name === groupName);
      if (!group) return;

      // Заполняем форму добавления
      document.getElementById('addGroup').value = groupName;
      document.getElementById('addDay').value = currentDay;
      document.getElementById('addPair').value = pairNum;

      // Обновляем опции уроков
      updateLessonOptions();

      // Выбираем первый урок
      const lessonSelect = document.getElementById('addLesson');
      if (lessonSelect.options.length > 1) {
        lessonSelect.selectedIndex = 1;
      }

      // Показываем модальное окно
      showAddModal();
    }

    // Фильтрация расписания
    function filterSchedule() {
      selectedGroup = document.getElementById('groupFilter').value;
      renderSchedule();
    }

    // Проверка пропусков
    async function checkGaps() {
      try {
        const gapsAlert = document.getElementById('gapsAlert');
        const autoFillButton = document.getElementById('autoFillButton');

        if (selectedGroup) {
          // Проверяем пропуски для выбранной группы
          const group = allGroups.find(g => g.name === selectedGroup);
          if (group) {
            const response = await fetch(`/api/schedule/gaps/${group.id}?week=${currentWeek}&semester=${currentSemester}`);
            if (response.ok) {
              const data = await response.json();
              if (data.success && data.total_gaps > 0) {
                hasGaps = true;
                gapsAlert.style.display = 'block';
                autoFillButton.style.display = 'block';
                document.getElementById('gapsMessage').textContent =
                  `У группы ${selectedGroup} обнаружено ${data.total_gaps} пропусков в расписании`;
              } else {
                hasGaps = false;
                gapsAlert.style.display = 'none';
                autoFillButton.style.display = 'none';
              }
            }
          }
        } else {
          // Для всех групп просто скрываем алерт
          hasGaps = false;
          gapsAlert.style.display = 'none';
          autoFillButton.style.display = 'none';
        }
      } catch (error) {
        console.error('Ошибка проверки пропусков:', error);
      }
    }

    // Заполнить пропуски
    async function fillGaps() {
      if (!selectedGroup) {
        alert('Выберите группу для заполнения пропусков');
        return;
      }

      const group = allGroups.find(g => g.name === selectedGroup);
      if (!group) return;

      if (confirm(`Заполнить пропуски в расписании для группы ${selectedGroup}?`)) {
        try {
          const response = await fetch('/api/schedule/auto_fill', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              week: currentWeek,
              semester: currentSemester,
              group_ids: [group.id],
              type: 'gaps_only'
            })
          });

          const result = await response.json();

          if (result.success) {
            alert('Пропуски успешно заполнены');
            loadSchedule();
          } else {
            alert('Ошибка: ' + result.message);
          }
        } catch (error) {
          alert('Ошибка сети: ' + error.message);
        }
      }
    }

    // Показать модальное окно добавления
    function showAddModal() {
      // Сбрасываем форму
      document.getElementById('addForm').reset();
      document.getElementById('addMessage').innerHTML = '';
      document.getElementById('zeroLessonWarning').style.display = 'none';
      document.getElementById('availabilityInfo').style.display = 'none';

      // Заполняем день недели
      const daySelect = document.getElementById('addDay');
      daySelect.innerHTML = '<option value="">Выберите день</option>';
      ['Понедельник', 'Вторник', 'Среда', 'Четверг', 'Пятница', 'Суббота'].forEach(day => {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = day;
        option.selected = (day === currentDay);
        daySelect.appendChild(option);
      });

      // Обновляем доступные пары
      updateAddPairOptions();

      // Показываем модальное окно
      const modal = new bootstrap.Modal(document.getElementById('addModal'));
      modal.show();
    }

    // Обновление опций пар в форме добавления
    function updateAddPairOptions() {
      const day = document.getElementById('addDay').value || currentDay;
      const pairSelect = document.getElementById('addPair');

      pairSelect.innerHTML = '<option value="">Выберите пару</option>';

      const availablePairs = PAIR_CONFIG[day]?.pairs || [];

      availablePairs.forEach(pairNum => {
        const option = document.createElement('option');
        option.value = pairNum;
        option.textContent = PAIR_TIMES[pairNum]?.name || `Пара ${pairNum}`;
        pairSelect.appendChild(option);
      });

      // Сбрасываем уроки
      document.getElementById('addLesson').innerHTML = '<option value="">Выберите урок</option>';
    }

    // Обновление опций уроков
    function updateLessonOptions() {
      const pairNum = parseInt(document.getElementById('addPair').value);
      const lessonSelect = document.getElementById('addLesson');

      lessonSelect.innerHTML = '<option value="">Выберите урок</option>';

      if (isNaN(pairNum)) return;

      const lessons = PAIR_TIMES[pairNum]?.lessons || [];

      lessons.forEach(lessonNum => {
        const option = document.createElement('option');
        option.value = lessonNum;
        option.textContent = `Урок ${lessonNum}`;
        lessonSelect.appendChild(option);
      });

      // Проверяем нулевой урок и доступность
      checkZeroLesson();
      checkAvailability();
    }

    // Проверка нулевого урока
    function checkZeroLesson() {
      const day = document.getElementById('addDay').value || currentDay;
      const lessonNum = parseInt(document.getElementById('addLesson').value);
      const subject = document.getElementById('addSubject').value;
      const warning = document.getElementById('zeroLessonWarning');

      if ((day === 'Понедельник' || day === 'Четверг') && lessonNum === 0 && subject !== 'Разговоры о важном') {
        warning.style.display = 'block';

        // Автоматически выбираем "Разговоры о важном"
        const subjectSelect = document.getElementById('addSubject');
        for (let i = 0; i < subjectSelect.options.length; i++) {
          if (subjectSelect.options[i].value === 'Разговоры о важном') {
            subjectSelect.selectedIndex = i;
            break;
          }
        }
      } else {
        warning.style.display = 'none';
      }
    }

    // Проверка доступности
    async function checkAvailability() {
      const day = document.getElementById('addDay').value || currentDay;
      const lessonNum = parseInt(document.getElementById('addLesson').value);

      if (!day || isNaN(lessonNum)) return;

      try {
        const response = await fetch(
          `/api/schedule/check_availability?day=${encodeURIComponent(day)}&lesson_number=${lessonNum}&week=${currentWeek}&semester=${currentSemester}`
        );

        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            const info = document.getElementById('availabilityInfo');
            const message = document.getElementById('availabilityMessage');

            info.style.display = 'block';
            message.innerHTML = `
              Свободных аудиторий: ${data.free_rooms.length}<br>
              Свободных преподавателей: ${data.free_teachers.length}
            `;
          }
        }
      } catch (error) {
        console.error('Ошибка проверки доступности:', error);
      }
    }

    // Добавление занятия
    async function addLesson() {
      const group = document.getElementById('addGroup').value;
      const subject = document.getElementById('addSubject').value;
      const teacher = document.getElementById('addTeacher').value;
      const room = document.getElementById('addRoom').value;
      const day = document.getElementById('addDay').value;
      const pairNum = parseInt(document.getElementById('addPair').value);
      const lessonNum = parseInt(document.getElementById('addLesson').value);
      const isCombined = document.getElementById('addIsCombined').checked;
      const isPractice = document.getElementById('addIsPractice').checked;

      // Валидация
      if (!group || !subject || !teacher || !room || !day || isNaN(pairNum) || isNaN(lessonNum)) {
        showMessage('addMessage', 'Заполните все обязательные поля', 'danger');
        return;
      }

      // Проверка нулевого урока
      if ((day === 'Понедельник' || day === 'Четверг') && lessonNum === 0 && subject !== 'Разговоры о важном') {
        showMessage('addMessage', 'На 0 урок можно поставить только "Разговоры о важном"', 'danger');
        return;
      }

      try {
        const response = await fetch('/api/schedule/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            is_main: false,
            group: group,
            subject: subject,
            teacher: teacher,
            room: room,
            day: day,
            lesson_number: lessonNum,
            week: currentWeek,
            semester: currentSemester,
            is_combined: isCombined,
            is_practice: isPractice
          })
        });

        const result = await response.json();

        if (result.success) {
          showMessage('addMessage', 'Занятие успешно добавлено', 'success');

          // Закрываем модальное окно через 1.5 секунды
          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            loadSchedule();
          }, 1500);
        } else {
          showMessage('addMessage', result.message || 'Ошибка добавления', 'danger');
        }

      } catch (error) {
        showMessage('addMessage', `Ошибка сети: ${error.message}`, 'danger');
      }
    }

    // Показать модальное окно автозаполнения
    function showAutoFillModal() {
      const modal = new bootstrap.Modal(document.getElementById('autoFillModal'));
      modal.show();
    }

    // Запуск автозаполнения
    async function startAutoFill() {
      const fillType = document.getElementById('fillType').value;
      const allGroupsChecked = document.getElementById('allGroups').checked;

      let groupIds = [];
      if (!allGroupsChecked) {
        const selectedGroups = document.querySelectorAll('.group-checkbox:checked');
        groupIds = Array.from(selectedGroups).map(cb => parseInt(cb.value));
      }

      if (groupIds.length === 0 && !allGroupsChecked) {
        alert('Выберите хотя бы одну группу');
        return;
      }

      if (confirm(`Запустить автозаполнение расписания (тип: ${fillType})?`)) {
        try {
          const response = await fetch('/api/schedule/auto_fill', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              week: currentWeek,
              semester: currentSemester,
              group_ids: groupIds,
              type: fillType
            })
          });

          const result = await response.json();

          if (result.success) {
            alert('Автозаполнение завершено успешно');
            bootstrap.Modal.getInstance(document.getElementById('autoFillModal')).hide();
            loadSchedule();
          } else {
            alert('Ошибка: ' + result.message);
          }
        } catch (error) {
          alert('Ошибка сети: ' + error.message);
        }
      }
    }

    // Показать модальное окно редактирования
    async function showEditModal(lessonId) {
      try {
        // Находим занятие в текущем расписании
        const lesson = currentSchedule.find(l => l.id === lessonId);

        if (!lesson) {
          alert('Занятие не найдено');
          return;
        }

        // Заполняем форму
        document.getElementById('editLessonId').value = lessonId;
        document.getElementById('editSubject').value = lesson.subject;
        document.getElementById('editTeacher').value = lesson.teacher;
        document.getElementById('editRoom').value = lesson.room;
        document.getElementById('editIsCombined').checked = lesson.is_combined || false;
        document.getElementById('editMessage').innerHTML = '';

        // Показываем модальное окно
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();

      } catch (error) {
        alert(`Ошибка загрузки данных: ${error.message}`);
      }
    }

    // Сохранение изменений
    async function saveEdit() {
      const lessonId = document.getElementById('editLessonId').value;
      const subject = document.getElementById('editSubject').value;
      const teacher = document.getElementById('editTeacher').value;
      const room = document.getElementById('editRoom').value;
      const isCombined = document.getElementById('editIsCombined').checked;

      if (!subject || !teacher || !room) {
        showMessage('editMessage', 'Заполните все поля', 'danger');
        return;
      }

      try {
        const response = await fetch(`/api/schedule/update/${lessonId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            subject: subject,
            teacher: teacher,
            room: room,
            is_combined: isCombined
          })
        });

        const result = await response.json();

        if (result.success) {
          showMessage('editMessage', 'Изменения сохранены', 'success');

          // Обновляем локальные данные
          const lessonIndex = currentSchedule.findIndex(l => l.id === parseInt(lessonId));
          if (lessonIndex !== -1) {
            currentSchedule[lessonIndex].subject = subject;
            currentSchedule[lessonIndex].teacher = teacher;
            currentSchedule[lessonIndex].room = room;
            currentSchedule[lessonIndex].is_combined = isCombined;
            currentSchedule[lessonIndex].is_changed = true;
          }

          // Перерисовываем таблицу
          renderSchedule();

          // Закрываем модальное окно через 1.5 секунды
          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
          }, 1500);
        } else {
          showMessage('editMessage', result.message || 'Ошибка сохранения', 'danger');
        }

      } catch (error) {
        showMessage('editMessage', `Ошибка сети: ${error.message}`, 'danger');
      }
    }

    // Удаление занятия
    async function deleteLesson(lessonId) {
      if (!confirm('Вы уверены, что хотите удалить это занятие?')) {
        return;
      }

      try {
        const response = await fetch(`/api/schedule/delete/${lessonId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          alert('Занятие удалено');
          loadSchedule();
        } else {
          alert('Ошибка: ' + result.message);
        }
      } catch (error) {
        alert('Ошибка сети: ' + error.message);
      }
    }

    // Очистка дня
    async function clearDay() {
      if (!confirm(`Очистить все занятия на ${currentDay}?`)) {
        return;
      }

      // Находим все занятия на текущий день
      const dayLessons = currentSchedule.filter(lesson => lesson.day === currentDay);

      if (dayLessons.length === 0) {
        alert('Нет занятий для очистки');
        return;
      }

      try {
        // Удаляем каждое занятие
        let deletedCount = 0;

        for (const lesson of dayLessons) {
          const response = await fetch(`/api/schedule/delete/${lesson.id}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            deletedCount++;
          }
        }

        alert(`Удалено ${deletedCount} занятий`);
        loadSchedule();

      } catch (error) {
        alert('Ошибка: ' + error.message);
      }
    }

    // Вспомогательная функция для отображения сообщений
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
    }

    // Добавляем обработчики событий
    document.getElementById('addDay').addEventListener('change', function () {
      updateAddPairOptions();
      updateLessonOptions();
    });

    document.getElementById('addPair').addEventListener('change', updateLessonOptions);
    document.getElementById('addLesson').addEventListener('change', function () {
      checkZeroLesson();
      checkAvailability();
    });
    document.getElementById('addSubject').addEventListener('change', checkZeroLesson);
  </script>
</body>

</html>

group_load_management - пустой файл

group_management.html -  <!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Управление группами</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .group-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .group-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .modal-lg-custom {
      max-width: 900px;
    }

    .hours-input {
      width: 80px;
    }

    .practice-badge {
      background-color: #17a2b8;
    }

    .autofill-btn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
    }

    .conflict-badge {
      background-color: #dc3545;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }

      100% {
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">
        <i class="bi bi-arrow-left"></i> Управление группами
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="userInfo">
          <i class="bi bi-person-circle"></i> Загрузка...
        </span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- Заголовок и кнопки -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-people"></i> Управление группами и предметами</h2>
      <div>
        <button class="btn btn-primary" onclick="showAddGroupModal()">
          <i class="bi bi-plus-circle"></i> Добавить группу
        </button>
        <button class="btn autofill-btn ms-2" onclick="showAutofillModal()">
          <i class="bi bi-magic"></i> Автозаполнение
        </button>
        <button class="btn btn-warning ms-2" onclick="checkConflicts()">
          <i class="bi bi-exclamation-triangle"></i> Проверить конфликты
        </button>
      </div>
    </div>

    <!-- Статистика автозаполнения -->
    <div class="card mb-4" id="autofillStats" style="display: none;">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Статистика автозаполнения</h5>
      </div>
      <div class="card-body">
        <div class="row" id="autofillStatsContent">
          <!-- Статистика будет загружена здесь -->
        </div>
      </div>
    </div>

    <!-- Список групп -->
    <div id="groupsContainer">
      <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Загрузка...</span>
        </div>
        <p class="mt-3">Загрузка списка групп...</p>
      </div>
    </div>
  </div>

  <!-- Модальное окно добавления группы -->
  <div class="modal fade" id="addGroupModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Добавить новую группу</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addGroupForm">
            <div class="mb-3">
              <label class="form-label">Название группы *</label>
              <input type="text" class="form-control" id="groupName" required placeholder="Например: 1А, 2Б и т.д.">
            </div>
            <div class="mb-3">
              <label class="form-label">Курс *</label>
              <select class="form-select" id="groupCourse" required>
                <option value="">Выберите курс</option>
                <option value="1">1 курс</option>
                <option value="2">2 курс</option>
                <option value="3">3 курс</option>
                <option value="4">4 курс</option>
              </select>
            </div>
          </form>
          <div id="addGroupMessage" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="addGroup()">Добавить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно управления предметами группы -->
  <div class="modal fade" id="manageSubjectsModal" tabindex="-1">
    <div class="modal-dialog modal-lg-custom">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="manageSubjectsTitle">Управление предметами группы</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="currentGroupId">

          <!-- Информация о группе -->
          <div class="card mb-3">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h6 id="groupInfo">Группа: </h6>
                </div>
                <div class="col-md-6 text-end">
                  <button class="btn btn-sm btn-outline-info" onclick="managePractice()">
                    <i class="bi bi-calendar-week"></i> Управление практикой
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Форма добавления предмета -->
          <div class="card mb-4">
            <div class="card-body">
              <h6>Добавить предмет группе</h6>
              <form id="addSubjectForm" class="row g-3">
                <div class="col-md-4">
                  <select class="form-select" id="subjectSelect" required>
                    <option value="">Выберите предмет</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <select class="form-select" id="teacherSelect">
                    <option value="">Выберите преподавателя</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <input type="number" class="form-control" id="hoursPerWeek" placeholder="Час/нед" min="0" max="40"
                    value="0" required>
                </div>
                <div class="col-md-3">
                  <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-plus"></i> Добавить
                  </button>
                </div>
                <div class="col-md-6 mt-2">
                  <label class="form-label small">Часы за 1 семестр:</label>
                  <input type="number" class="form-control" id="totalHoursSemester1" placeholder="Всего часов" min="0">
                </div>
                <div class="col-md-6 mt-2">
                  <label class="form-label small">Часы за 2 семестр:</label>
                  <input type="number" class="form-control" id="totalHoursSemester2" placeholder="Всего часов" min="0">
                </div>
              </form>
            </div>
          </div>

          <!-- Список предметов группы -->
          <div class="card">
            <div class="card-body">
              <h6>Предметы группы
                <span id="totalGroupHoursBadge" class="badge bg-success ms-2">0 ч/нед</span>
                <span id="practiceBadge" class="badge practice-badge ms-2" style="display: none;">
                  <i class="bi bi-calendar-week"></i> Практика
                </span>
              </h6>
              <div id="groupSubjectsList">
                <div class="text-center p-3">
                  <div class="spinner-border spinner-border-sm" role="status"></div>
                  <span class="ms-2">Загрузка предметов...</span>
                </div>
              </div>
            </div>
          </div>

          <div id="manageSubjectsMessage" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно управления практикой -->
  <div class="modal fade" id="practiceModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Управление практикой</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="practiceGroupId">

          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Практика назначается для 2-4 курсов.
            Она ставится на весь день в указанный день недели КАЖДУЮ неделю.
          </div>

          <form id="practiceForm">
            <div class="mb-3">
              <label class="form-label">День недели для практики *</label>
              <select class="form-select" id="practiceDay" required>
                <option value="">Выберите день</option>
                <option value="Понедельник">Понедельник</option>
                <option value="Вторник">Вторник</option>
                <option value="Среда">Среда</option>
                <option value="Четверг">Четверг</option>
                <option value="Пятница">Пятница</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Предмет практики *</label>
              <select class="form-select" id="practiceSubject" required>
                <option value="">Выберите предмет</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Преподаватель</label>
              <select class="form-select" id="practiceTeacher">
                <option value="">Выберите преподавателя</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Аудитория</label>
              <select class="form-select" id="practiceRoom">
                <option value="">Выберите аудиторию</option>
              </select>
            </div>
          </form>
          <div id="practiceMessage" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-danger" onclick="deletePractice()" id="deletePracticeBtn"
            style="display: none;">
            Удалить практику
          </button>
          <button type="button" class="btn btn-primary" onclick="savePractice()">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно автозаполнения -->
  <div class="modal fade" id="autofillModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-magic"></i> Автоматическое заполнение расписания</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Внимание:</strong> Автозаполнение создаст расписание на основе данных о нагрузке групп.
            Убедитесь, что все группы имеют назначенные предметы и часы.
          </div>

          <form id="autofillForm">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Тип расписания *</label>
                <select class="form-select" id="fillType" required>
                  <option value="both">Текущее и основное</option>
                  <option value="current">Только текущее</option>
                  <option value="main">Только основное</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Неделя</label>
                <input type="number" class="form-control" id="fillWeek" min="1" max="52" value="1">
              </div>
              <div class="col-md-4">
                <label class="form-label">Семестр</label>
                <select class="form-select" id="fillSemester">
                  <option value="1">1 семестр</option>
                  <option value="2">2 семестр</option>
                </select>
              </div>
            </div>

            <div class="alert alert-info mt-3">
              <h6><i class="bi bi-info-circle"></i> Особенности автозаполнения:</h6>
              <ul class="mb-0">
                <li>Не будет дырок в расписании (если есть 1 и 2 пара, то и 3 будет)</li>
                <li>Один преподаватель не ведет одновременно в 2х группах</li>
                <li>Практика ставится КАЖДУЮ неделю на весь день для 2-4 курсов</li>
                <li>На 0 урок (понедельник, четверг) только "Разговоры о важном"</li>
                <li>Совмещенные занятия выделяются красным</li>
                <li>Максимум 4 пары в день (пн-пт), 2 пары (сб-вс)</li>
              </ul>
            </div>
          </form>

          <div id="autofillProgress" class="mt-3" style="display: none;">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">
              </div>
            </div>
            <div class="text-center mt-2">
              <span id="progressText">Подготовка к автозаполнению...</span>
            </div>
          </div>

          <div id="autofillResult" class="mt-3"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="startAutofill()" id="startAutofillBtn">
            <i class="bi bi-magic"></i> Начать автозаполнение
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно конфликтов -->
  <div class="modal fade" id="conflictsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Конфликты в расписании</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="conflictsContent">
            <div class="text-center p-5">
              <div class="spinner-border text-warning" role="status"></div>
              <p class="mt-3">Проверка конфликтов...</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Глобальные переменные
    let allGroups = [];
    let allSubjects = [];
    let allTeachers = [];
    let allRooms = [];
    let currentGroupSubjects = [];
    let currentGroupPractice = null;

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await checkAuth();
      await loadUserInfo();
      await loadInitialData();
      await loadGroups();
      await loadAutofillStats();
    });

    // Проверка авторизации
    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (!data.authenticated || data.role !== 'admin') {
          window.location.href = '/login';
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login';
        return false;
      }
    }

    // Загрузка информации о пользователе
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userInfo').innerHTML = `
            <i class="bi bi-person-circle"></i> ${data.username}
          `;
        }
      } catch (error) {
        console.error('Ошибка загрузки информации о пользователе:', error);
      }
    }

    // Загрузка начальных данных
    async function loadInitialData() {
      try {
        // Загружаем предметы
        const subjectsResponse = await fetch('/api/data/subjects');
        if (subjectsResponse.ok) {
          allSubjects = await subjectsResponse.json();
        }

        // Загружаем преподавателей
        const teachersResponse = await fetch('/api/data/teachers');
        if (teachersResponse.ok) {
          allTeachers = await teachersResponse.json();
        }

        // Загружаем аудитории
        const roomsResponse = await fetch('/api/data/rooms');
        if (roomsResponse.ok) {
          allRooms = await roomsResponse.json();
        }

      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
        showMessage('groupsContainer', 'Ошибка загрузки данных', 'danger');
      }
    }

    // Загрузка списка групп
    async function loadGroups() {
      try {
        const response = await fetch('/api/data/groups');
        if (!response.ok) {
          throw new Error('Ошибка загрузки групп');
        }

        allGroups = await response.json();
        renderGroups();

      } catch (error) {
        console.error('Ошибка:', error);
        document.getElementById('groupsContainer').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки групп: ${error.message}
          </div>
        `;
      }
    }

    // Отображение групп
    function renderGroups() {
      if (allGroups.length === 0) {
        document.getElementById('groupsContainer').innerHTML = `
          <div class="text-center p-5">
            <i class="bi bi-people" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3">Нет групп</h4>
            <p class="text-muted">Добавьте первую группу, нажав на кнопку "Добавить группу"</p>
            <button class="btn btn-primary mt-3" onclick="showAddGroupModal()">
              <i class="bi bi-plus-circle"></i> Добавить первую группу
            </button>
          </div>
        `;
        return;
      }

      // Группируем по курсам
      const groupsByCourse = {};
      allGroups.forEach(group => {
        if (!groupsByCourse[group.course]) {
          groupsByCourse[group.course] = [];
        }
        groupsByCourse[group.course].push(group);
      });

      let html = '';

      // Для каждого курса
      Object.keys(groupsByCourse).sort().forEach(course => {
        html += `
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">${course} курс</h5>
            </div>
            <div class="card-body">
              <div class="row">
        `;

        groupsByCourse[course].forEach(group => {
          html += `
            <div class="col-md-6 col-lg-4 mb-3">
              <div class="group-card">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <div>
                    <h5 class="mb-0">${group.name}</h5>
                    <small class="text-muted">${group.course} курс</small>
                  </div>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="manageGroupSubjects(${group.id})" title="Управление предметами">
                      <i class="bi bi-book"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="managePracticeForGroup(${group.id})" title="Практика">
                      <i class="bi bi-calendar-week"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteGroup(${group.id})" title="Удалить группу">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </div>
                
                <div class="mb-2">
                  <small class="text-muted">ID: ${group.id}</small>
                </div>
                
                <div class="d-grid">
                  <button class="btn btn-outline-success" onclick="manageGroupSubjects(${group.id})">
                    <i class="bi bi-gear"></i> Управление предметами и часами
                  </button>
                </div>
              </div>
            </div>
          `;
        });

        html += `
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('groupsContainer').innerHTML = html;
    }

    // Показать модальное окно добавления группы
    function showAddGroupModal() {
      document.getElementById('addGroupForm').reset();
      document.getElementById('addGroupMessage').innerHTML = '';

      const modal = new bootstrap.Modal(document.getElementById('addGroupModal'));
      modal.show();
    }

    // Добавить группу
    async function addGroup() {
      const name = document.getElementById('groupName').value.trim();
      const course = document.getElementById('groupCourse').value;

      if (!name || !course) {
        showMessage('addGroupMessage', 'Заполните все поля', 'danger');
        return;
      }

      try {
        const response = await fetch('/api/data/groups', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: name,
            course: parseInt(course)
          })
        });

        const result = await response.json();

        if (result.success || result.id) {
          showMessage('addGroupMessage', 'Группа успешно добавлена', 'success');

          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('addGroupModal')).hide();
            loadGroups();
          }, 1500);
        } else {
          showMessage('addGroupMessage', result.message || 'Ошибка добавления группы', 'danger');
        }

      } catch (error) {
        showMessage('addGroupMessage', `Ошибка сети: ${error.message}`, 'danger');
      }
    }

    // Удалить группу
    async function deleteGroup(groupId) {
      if (!confirm('Вы уверены, что хотите удалить эту группу? Все связанные данные будут удалены.')) {
        return;
      }

      try {
        const response = await fetch(`/api/group/delete/${groupId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          alert('Группа удалена');
          loadGroups();
        } else {
          alert('Ошибка: ' + result.message);
        }
      } catch (error) {
        alert('Ошибка сети: ' + error.message);
      }
    }

    // Управление предметами группы
    async function manageGroupSubjects(groupId) {
      const group = allGroups.find(g => g.id === groupId);
      if (!group) return;

      document.getElementById('currentGroupId').value = groupId;
      document.getElementById('manageSubjectsTitle').textContent = `Управление предметами группы ${group.name}`;
      document.getElementById('groupInfo').textContent = `Группа: ${group.name} (${group.course} курс)`;
      document.getElementById('manageSubjectsMessage').innerHTML = '';

      // Заполняем выпадающие списки
      updateSubjectSelect();
      updateTeacherSelect();

      // Загружаем предметы группы и практику
      await loadGroupSubjects(groupId);
      await loadGroupPractice(groupId);

      // Показываем модальное окно
      const modal = new bootstrap.Modal(document.getElementById('manageSubjectsModal'));
      modal.show();
    }

    // Обновление выпадающего списка предметов
    function updateSubjectSelect() {
      const select = document.getElementById('subjectSelect');
      const practiceSelect = document.getElementById('practiceSubject');

      select.innerHTML = '<option value="">Выберите предмет</option>';
      practiceSelect.innerHTML = '<option value="">Выберите предмет</option>';

      allSubjects.sort((a, b) => a.name.localeCompare(b.name)).forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        select.appendChild(option);

        const option2 = document.createElement('option');
        option2.value = subject.id;
        option2.textContent = subject.name;
        practiceSelect.appendChild(option2);
      });
    }

    // Обновление выпадающего списка преподавателей
    function updateTeacherSelect() {
      const select = document.getElementById('teacherSelect');
      const practiceSelect = document.getElementById('practiceTeacher');

      select.innerHTML = '<option value="">Выберите преподавателя</option>';
      practiceSelect.innerHTML = '<option value="">Выберите преподавателя</option>';

      allTeachers.sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.name;
        select.appendChild(option);

        const option2 = document.createElement('option');
        option2.value = teacher.id;
        option2.textContent = teacher.name;
        practiceSelect.appendChild(option2);
      });
    }

    // Обновление выпадающего списка аудиторий
    function updateRoomSelect() {
      const select = document.getElementById('practiceRoom');
      select.innerHTML = '<option value="">Выберите аудиторию</option>';

      allRooms.sort((a, b) => a.name.localeCompare(b.name)).forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = room.name;
        select.appendChild(option);
      });
    }

    // Загрузка предметов группы
    async function loadGroupSubjects(groupId) {
      try {
        const response = await fetch(`/api/group/${groupId}/subjects`);
        if (!response.ok) {
          throw new Error('Ошибка загрузки предметов группы');
        }

        const data = await response.json();
        currentGroupSubjects = data.subjects || [];
        currentGroupPractice = data.practice;

        renderGroupSubjects();
        updateTotalHoursBadge();
        updatePracticeBadge();

      } catch (error) {
        console.error('Ошибка загрузки предметов группы:', error);
        document.getElementById('groupSubjectsList').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки предметов: ${error.message}
          </div>
        `;
      }
    }

    // Загрузка практики группы
    async function loadGroupPractice(groupId) {
      try {
        const response = await fetch(`/api/group/${groupId}/subjects`);
        if (response.ok) {
          const data = await response.json();
          currentGroupPractice = data.practice;
          updatePracticeBadge();
        }
      } catch (error) {
        console.error('Ошибка загрузки практики:', error);
      }
    }

    // Обновление бейджа с общим количеством часов
    function updateTotalHoursBadge() {
      const totalHours = currentGroupSubjects.reduce((sum, subject) => sum + (subject.hours_per_week || 0), 0);
      document.getElementById('totalGroupHoursBadge').textContent = `${totalHours} ч/нед`;
    }

    // Обновление бейджа практики
    function updatePracticeBadge() {
      const practiceBadge = document.getElementById('practiceBadge');
      if (currentGroupPractice && currentGroupPractice.has_practice) {
        practiceBadge.style.display = 'inline-block';
        practiceBadge.title = `Практика: ${currentGroupPractice.practice_day}, ${currentGroupPractice.practice_subject}`;
      } else {
        practiceBadge.style.display = 'none';
      }
    }

    // Отображение предметов группы
    function renderGroupSubjects() {
      if (currentGroupSubjects.length === 0) {
        document.getElementById('groupSubjectsList').innerHTML = `
          <div class="text-center p-3 text-muted">
            <i class="bi bi-book" style="font-size: 2rem;"></i>
            <p class="mt-2">Нет предметов</p>
            <small>Добавьте предметы используя форму выше</small>
          </div>
        `;
        return;
      }

      let html = '<div class="table-responsive"><table class="table table-sm table-hover">';
      html += `
        <thead class="table-light">
          <tr>
            <th>Предмет</th>
            <th>Преподаватель</th>
            <th class="text-center">Час/нед</th>
            <th class="text-center">1 семестр</th>
            <th class="text-center">2 семестр</th>
            <th>Действия</th>
          </tr>
        </thead>
        <tbody>
      `;

      currentGroupSubjects.forEach(subject => {
        html += `
          <tr id="subject-row-${subject.id}">
            <td>
              <div class="fw-bold">${subject.subject_name}</div>
            </td>
            <td>
              <select class="form-select form-select-sm teacher-select" data-subject-id="${subject.id}" style="width: 200px;">
                <option value="">Не назначен</option>
                ${allTeachers.map(teacher => `
                  <option value="${teacher.id}" ${subject.teacher_id == teacher.id ? 'selected' : ''}>
                    ${teacher.name}
                  </option>
                `).join('')}
              </select>
            </td>
            <td class="text-center">
              <div class="input-group input-group-sm" style="width: 100px; margin: 0 auto;">
                <input type="number" class="form-control hours-input" data-subject-id="${subject.id}" 
                       data-field="hours_per_week" value="${subject.hours_per_week || 0}" min="0" max="40">
              </div>
            </td>
            <td class="text-center">
              <div class="input-group input-group-sm" style="width: 120px; margin: 0 auto;">
                <input type="number" class="form-control hours-input" data-subject-id="${subject.id}" 
                       data-field="total_hours_semester1" value="${subject.total_hours_semester1 || 0}" min="0">
              </div>
            </td>
            <td class="text-center">
              <div class="input-group input-group-sm" style="width: 120px; margin: 0 auto;">
                <input type="number" class="form-control hours-input" data-subject-id="${subject.id}" 
                       data-field="total_hours_semester2" value="${subject.total_hours_semester2 || 0}" min="0">
              </div>
            </td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteGroupSubject(${subject.id})">
                <i class="bi bi-trash"></i> Удалить
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';
      document.getElementById('groupSubjectsList').innerHTML = html;

      // Добавляем обработчики событий для изменения данных
      document.querySelectorAll('.teacher-select').forEach(select => {
        select.addEventListener('change', function () {
          const subjectId = this.getAttribute('data-subject-id');
          const teacherId = this.value;
          updateGroupSubject(subjectId, { teacher_id: teacherId });
        });
      });

      document.querySelectorAll('.hours-input').forEach(input => {
        input.addEventListener('change', function () {
          const subjectId = this.getAttribute('data-subject-id');
          const field = this.getAttribute('data-field');
          const value = this.value;
          updateGroupSubjectField(subjectId, field, value);
        });
      });
    }

    // Обновление предмета группы
    async function updateGroupSubject(subjectId, data) {
      try {
        const groupId = document.getElementById('currentGroupId').value;
        const subject = currentGroupSubjects.find(s => s.id == subjectId);

        if (!subject) return;

        const updateData = {
          group_id: groupId,
          subject_id: subject.subject_id,
          teacher_id: data.teacher_id !== undefined ? data.teacher_id : subject.teacher_id,
          hours_per_week: subject.hours_per_week || 0,
          total_hours_semester1: subject.total_hours_semester1 || 0,
          total_hours_semester2: subject.total_hours_semester2 || 0
        };

        const response = await fetch('/api/group/subject/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updateData)
        });

        const result = await response.json();

        if (result.success) {
          const index = currentGroupSubjects.findIndex(s => s.id == subjectId);
          if (index !== -1) {
            if (data.teacher_id !== undefined) {
              currentGroupSubjects[index].teacher_id = data.teacher_id;
              currentGroupSubjects[index].teacher_name = allTeachers.find(t => t.id == data.teacher_id)?.name || null;
            }
          }
          showMessage('manageSubjectsMessage', 'Изменения сохранены', 'success');
        } else {
          showMessage('manageSubjectsMessage', 'Ошибка сохранения: ' + result.message, 'danger');
        }
      } catch (error) {
        showMessage('manageSubjectsMessage', 'Ошибка сети: ' + error.message, 'danger');
      }
    }

    // Обновление поля предмета группы
    async function updateGroupSubjectField(subjectId, field, value) {
      try {
        const response = await fetch(`/api/group/subject/update_hours/${subjectId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ [field]: value })
        });

        const result = await response.json();

        if (result.success) {
          const index = currentGroupSubjects.findIndex(s => s.id == subjectId);
          if (index !== -1) {
            currentGroupSubjects[index][field] = parseInt(value) || 0;
          }

          if (field === 'hours_per_week') {
            updateTotalHoursBadge();
          }

          showMessage('manageSubjectsMessage', 'Изменения сохранены', 'success');
        } else {
          showMessage('manageSubjectsMessage', 'Ошибка обновления: ' + result.message, 'danger');
        }
      } catch (error) {
        showMessage('manageSubjectsMessage', 'Ошибка сети: ' + error.message, 'danger');
      }
    }

    // Добавить предмет группе
    document.getElementById('addSubjectForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const groupId = document.getElementById('currentGroupId').value;
      const subjectId = document.getElementById('subjectSelect').value;
      const teacherId = document.getElementById('teacherSelect').value || null;
      const hoursPerWeek = document.getElementById('hoursPerWeek').value;
      const totalHoursSemester1 = document.getElementById('totalHoursSemester1').value || 0;
      const totalHoursSemester2 = document.getElementById('totalHoursSemester2').value || 0;

      if (!subjectId) {
        showMessage('manageSubjectsMessage', 'Выберите предмет', 'danger');
        return;
      }

      try {
        const response = await fetch('/api/group/subject/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            group_id: groupId,
            subject_id: subjectId,
            teacher_id: teacherId,
            hours_per_week: hoursPerWeek,
            total_hours_semester1: totalHoursSemester1,
            total_hours_semester2: totalHoursSemester2
          })
        });

        const result = await response.json();

        if (result.success) {
          showMessage('manageSubjectsMessage', 'Предмет добавлен группе', 'success');

          // Сбрасываем форму и обновляем список
          document.getElementById('subjectSelect').value = '';
          document.getElementById('teacherSelect').value = '';
          document.getElementById('hoursPerWeek').value = 0;
          document.getElementById('totalHoursSemester1').value = 0;
          document.getElementById('totalHoursSemester2').value = 0;
          await loadGroupSubjects(groupId);
        } else {
          showMessage('manageSubjectsMessage', result.message || 'Ошибка добавления предмета', 'danger');
        }

      } catch (error) {
        showMessage('manageSubjectsMessage', `Ошибка сети: ${error.message}`, 'danger');
      }
    });

    // Удалить предмет из группы
    async function deleteGroupSubject(subjectId) {
      if (!confirm('Удалить этот предмет из группы?')) {
        return;
      }

      try {
        const response = await fetch(`/api/group/subject/delete/${subjectId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          currentGroupSubjects = currentGroupSubjects.filter(s => s.id !== subjectId);
          renderGroupSubjects();
          updateTotalHoursBadge();
          showMessage('manageSubjectsMessage', 'Предмет удален', 'success');
        } else {
          showMessage('manageSubjectsMessage', 'Ошибка удаления: ' + result.message, 'danger');
        }
      } catch (error) {
        showMessage('manageSubjectsMessage', 'Ошибка сети: ' + error.message, 'danger');
      }
    }

    // Управление практикой
    function managePractice() {
      const groupId = document.getElementById('currentGroupId').value;
      const group = allGroups.find(g => g.id == groupId);

      if (!group) return;

      // Закрываем текущее модальное окно
      bootstrap.Modal.getInstance(document.getElementById('manageSubjectsModal')).hide();

      // Открываем модальное окно практики
      managePracticeForGroup(groupId);
    }

    // Управление практикой для группы
    async function managePracticeForGroup(groupId) {
      const group = allGroups.find(g => g.id == groupId);
      if (!group) return;

      document.getElementById('practiceGroupId').value = groupId;

      // Заполняем выпадающие списки
      updateSubjectSelect();
      updateTeacherSelect();
      updateRoomSelect();

      // Загружаем текущую практику
      await loadGroupPracticeForModal(groupId);

      // Показываем модальное окно
      const modal = new bootstrap.Modal(document.getElementById('practiceModal'));
      modal.show();
    }

    // Загрузка практики для модального окна
    async function loadGroupPracticeForModal(groupId) {
      try {
        const response = await fetch(`/api/group/${groupId}/subjects`);
        if (response.ok) {
          const data = await response.json();
          const practice = data.practice;

          if (practice && practice.has_practice) {
            document.getElementById('practiceDay').value = practice.practice_day;
            document.getElementById('practiceSubject').value = practice.practice_subject_id || '';
            document.getElementById('practiceTeacher').value = practice.practice_teacher_id || '';
            document.getElementById('practiceRoom').value = practice.practice_room_id || '';
            document.getElementById('deletePracticeBtn').style.display = 'block';
          } else {
            document.getElementById('practiceForm').reset();
            document.getElementById('deletePracticeBtn').style.display = 'none';
          }
        }
      } catch (error) {
        console.error('Ошибка загрузки практики:', error);
      }
    }

    // Сохранение практики
    async function savePractice() {
      const groupId = document.getElementById('practiceGroupId').value;
      const day = document.getElementById('practiceDay').value;
      const subjectId = document.getElementById('practiceSubject').value;
      const teacherId = document.getElementById('practiceTeacher').value || null;
      const roomId = document.getElementById('practiceRoom').value || null;

      if (!day || !subjectId) {
        showMessage('practiceMessage', 'Заполните обязательные поля (день и предмет)', 'danger');
        return;
      }

      try {
        const response = await fetch('/api/group/practice', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            group_id: groupId,
            day: day,
            subject_id: subjectId,
            teacher_id: teacherId,
            room_id: roomId
          })
        });

        const result = await response.json();

        if (result.success) {
          showMessage('practiceMessage', 'Практика сохранена', 'success');

          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('practiceModal')).hide();
            // Обновляем бейдж практики
            loadGroupPractice(groupId);
          }, 1500);
        } else {
          showMessage('practiceMessage', 'Ошибка: ' + result.message, 'danger');
        }

      } catch (error) {
        showMessage('practiceMessage', 'Ошибка сети: ' + error.message, 'danger');
      }
    }

    // Удаление практики
    async function deletePractice() {
      const groupId = document.getElementById('practiceGroupId').value;

      if (!confirm('Удалить практику для этой группы?')) {
        return;
      }

      try {
        const response = await fetch(`/api/group/practice/delete/${groupId}`, {
          method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
          showMessage('practiceMessage', 'Практика удалена', 'success');

          setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('practiceModal')).hide();
            // Обновляем бейдж практики
            loadGroupPractice(groupId);
          }, 1500);
        } else {
          showMessage('practiceMessage', 'Ошибка: ' + result.message, 'danger');
        }
      } catch (error) {
        showMessage('practiceMessage', 'Ошибка сети: ' + error.message, 'danger');
      }
    }

    // Показать модальное окно автозаполнения
    function showAutofillModal() {
      document.getElementById('autofillForm').reset();
      document.getElementById('autofillResult').innerHTML = '';
      document.getElementById('autofillProgress').style.display = 'none';
      document.getElementById('startAutofillBtn').disabled = false;

      // Устанавливаем текущие настройки
      fetch('/api/settings/current')
        .then(response => response.json())
        .then(data => {
          document.getElementById('fillWeek').value = data.week || 1;
          document.getElementById('fillSemester').value = data.semester || 1;
        });

      const modal = new bootstrap.Modal(document.getElementById('autofillModal'));
      modal.show();
    }

    // Начать автозаполнение
    async function startAutofill() {
      const fillType = document.getElementById('fillType').value;
      const week = document.getElementById('fillWeek').value;
      const semester = document.getElementById('fillSemester').value;

      if (!fillType || !week || !semester) {
        showMessage('autofillResult', 'Заполните все поля', 'danger');
        return;
      }

      // Блокируем кнопку
      document.getElementById('startAutofillBtn').disabled = true;

      // Показываем прогресс
      document.getElementById('autofillProgress').style.display = 'block';
      const progressBar = document.querySelector('.progress-bar');
      const progressText = document.getElementById('progressText');

      // Анимация прогресса
      let progress = 0;
      const interval = setInterval(() => {
        progress += 5;
        if (progress > 90) progress = 90;
        progressBar.style.width = `${progress}%`;
        progressText.textContent = `Автозаполнение... ${progress}%`;
      }, 500);

      try {
        const response = await fetch('/api/schedule/autofill', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: fillType,
            week: parseInt(week),
            semester: parseInt(semester)
          })
        });

        clearInterval(interval);
        progressBar.style.width = '100%';
        progressText.textContent = 'Завершено!';

        const result = await response.json();

        if (result.success) {
          document.getElementById('autofillResult').innerHTML = `
            <div class="alert alert-success">
              <h6><i class="bi bi-check-circle"></i> Автозаполнение завершено успешно!</h6>
              <p>Добавлено занятий: <strong>${result.details.entries_added}</strong></p>
              <p>Конфликтов: <strong>${result.details.conflicts}</strong></p>
              <p>Ошибок: <strong>${result.details.errors}</strong></p>
              ${result.details.has_conflicts ?
              '<div class="alert alert-warning mt-2"><i class="bi bi-exclamation-triangle"></i> Обнаружены конфликты в расписании!</div>' :
              ''}
            </div>
          `;

          // Обновляем статистику
          loadAutofillStats();

          // Предлагаем проверить конфликты если есть
          if (result.details.has_conflicts) {
            setTimeout(() => {
              checkConflicts();
            }, 2000);
          }

        } else {
          document.getElementById('autofillResult').innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle"></i> Ошибка: ${result.message}
            </div>
          `;
        }

      } catch (error) {
        clearInterval(interval);
        document.getElementById('autofillResult').innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle"></i> Ошибка сети: ${error.message}
          </div>
        `;
      } finally {
        setTimeout(() => {
          document.getElementById('autofillProgress').style.display = 'none';
          document.getElementById('startAutofillBtn').disabled = false;
        }, 2000);
      }
    }

    // Загрузка статистики автозаполнения
    async function loadAutofillStats() {
      try {
        const response = await fetch('/api/autofill/logs');
        if (response.ok) {
          const data = await response.json();

          if (data.success && data.logs.length > 0) {
            const latestLog = data.logs[0];

            document.getElementById('autofillStats').style.display = 'block';
            document.getElementById('autofillStatsContent').innerHTML = `
              <div class="col-md-4">
                <div class="text-center">
                  <h3>${latestLog.entries_added}</h3>
                  <small class="text-muted">Добавлено занятий</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h3 class="${latestLog.conflicts > 0 ? 'text-warning' : 'text-success'}">
                    ${latestLog.conflicts}
                  </h3>
                  <small class="text-muted">Конфликтов</small>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-center">
                  <h3>${latestLog.created_at}</h3>
                  <small class="text-muted">Последнее обновление</small>
                </div>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
      }
    }

    // Проверка конфликтов
    async function checkConflicts() {
      try {
        // Получаем текущие настройки
        const settingsResponse = await fetch('/api/settings/current');
        const settings = await settingsResponse.json();

        const response = await fetch(`/api/schedule/check_conflicts?week=${settings.week}&semester=${settings.semester}`);
        const data = await response.json();

        if (data.success) {
          let html = '';

          if (data.has_conflicts) {
            html = `
              <div class="alert alert-danger">
                <h6><i class="bi bi-exclamation-triangle"></i> Обнаружено ${data.conflicts.length} конфликт(ов):</h6>
              </div>
            `;

            data.conflicts.forEach((conflict, index) => {
              html += `
                <div class="card mb-2 ${conflict.type === 'teacher_conflict' ? 'border-danger' :
                  conflict.type === 'group_conflict' ? 'border-warning' : 'border-info'}">
                  <div class="card-body">
                    <h6 class="card-title">
                      ${conflict.type === 'teacher_conflict' ? 'Конфликт преподавателя' :
                  conflict.type === 'group_conflict' ? 'Конфликт группы' : 'Конфликт аудитории'}
                    </h6>
                    <p class="card-text">${conflict.message}</p>
                    <small class="text-muted">${conflict.day}, урок ${conflict.lesson_number}</small>
                  </div>
                </div>
              `;
            });
          } else {
            html = `
              <div class="alert alert-success">
                <h6><i class="bi bi-check-circle"></i> Конфликтов не обнаружено!</h6>
                <p class="mb-0">Расписание корректно составлено.</p>
              </div>
            `;
          }

          document.getElementById('conflictsContent').innerHTML = html;
          const modal = new bootstrap.Modal(document.getElementById('conflictsModal'));
          modal.show();

        } else {
          alert('Ошибка проверки конфликтов: ' + data.message);
        }

      } catch (error) {
        alert('Ошибка сети: ' + error.message);
      }
    }

    // Вспомогательная функция для отображения сообщений
    function showMessage(elementId, message, type) {
      const element = document.getElementById(elementId);
      element.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
    }
  </script>
</body>

</html>

group_statistics.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Нагрузка групп по предметам</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .table th {
      background-color: #f8f9fa;
    }

    .form-container {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .load-item {
      border-left: 4px solid #007bff;
      padding: 10px;
      margin-bottom: 10px;
      background-color: white;
      border-radius: 4px;
    }

    .no-teacher {
      color: #dc3545;
      font-style: italic;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">📚 Расписание Колледжа</a>
    </div>
  </nav>

  <div class="container mt-4">
    <h2>👥 Нагрузка групп по предметам</h2>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">➕ Добавить нагрузку для группы</h5>
      </div>
      <div class="card-body">
        <div class="form-container">
          <form id="addLoadForm">
            <div class="row g-3">
              <div class="col-md-3">
                <label class="form-label">Группа:</label>
                <select class="form-select" id="group_id" required>
                  <option value="">Выберите группу</option>
                  {% for group in groups %}
                  <option value="{{ group.id }}">{{ group.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Предмет:</label>
                <select class="form-select" id="subject_id" required>
                  <option value="">Выберите предмет</option>
                  {% for subject in subjects %}
                  <option value="{{ subject.id }}">{{ subject.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Преподаватель:</label>
                <select class="form-select" id="teacher_id">
                  <option value="">Не назначен</option>
                  {% for teacher in teachers %}
                  <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label">Часов в неделю:</label>
                <input type="number" class="form-control" id="hours_per_week" min="0" max="40" required>
              </div>
              <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-success w-100">➕</button>
              </div>
            </div>
          </form>
        </div>
        <div id="formMessage" class="mt-3"></div>
      </div>
    </div>

    <!-- Нагрузка по группам -->
    {% if group_loads_dict %}
    {% for group_name, loads in group_loads_dict.items() %}
    <div class="card mb-3">
      <div class="card-header">
        <h5 class="mb-0">Группа: {{ group_name }}</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Предмет</th>
                <th>Преподаватель</th>
                <th>Часов в неделю</th>
                <th>Действия</th>
              </tr>
            </thead>
            <tbody>
              {% for load in loads %}
              <tr id="load-row-{{ load.id }}">
                <td>{{ load.subject }}</td>
                <td>
                  {% if load.teacher %}
                  {{ load.teacher }}
                  {% else %}
                  <span class="no-teacher">Не назначен</span>
                  {% endif %}
                </td>
                <td>
                  <input type="number" class="form-control form-control-sm hours-input"
                    value="{{ load.hours_per_week }}" data-load-id="{{ load.id }}"
                    style="width: 80px; display: inline-block;">
                  <span class="ms-1">ч/нед</span>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary edit-teacher-btn" data-load-id="{{ load.id }}"
                      data-teacher-id="{{ load.teacher_id or '' }}">
                      ✏️ Преподаватель
                    </button>
                    <button class="btn btn-outline-danger delete-load-btn" data-load-id="{{ load.id }}">
                      🗑️ Удалить
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
              <tr>
                <td colspan="2"><strong>Итого:</strong></td>
                <td><strong>{{ loads|sum(attribute='hours_per_week') }} ч/нед</strong></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info">
      Нагрузка групп еще не назначена. Добавьте нагрузку используя форму выше.
    </div>
    {% endif %}
  </div>

  <!-- Модальное окно для редактирования преподавателя -->
  <div class="modal fade" id="editTeacherModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Назначить преподавателя</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editLoadId">
          <div class="mb-3">
            <label class="form-label">Преподаватель:</label>
            <select class="form-select" id="editTeacherId">
              <option value="">Не назначен</option>
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" id="saveTeacherBtn">Сохранить</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Добавление нагрузки
    document.getElementById('addLoadForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const data = {
        group_id: document.getElementById('group_id').value,
        subject_id: document.getElementById('subject_id').value,
        teacher_id: document.getElementById('teacher_id').value,
        hours_per_week: document.getElementById('hours_per_week').value
      };

      fetch('/api/group_subject_load', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(result => {
          const messageDiv = document.getElementById('formMessage');
          if (result.success) {
            messageDiv.innerHTML = `<div class="alert alert-success">✅ ${result.message}</div>`;
            setTimeout(() => location.reload(), 1000);
          } else {
            messageDiv.innerHTML = `<div class="alert alert-danger">❌ ${result.message}</div>`;
          }
        })
        .catch(error => {
          document.getElementById('formMessage').innerHTML =
            `<div class="alert alert-danger">❌ Ошибка сети: ${error}</div>`;
        });
    });

    // Редактирование количества часов
    document.addEventListener('change', function (e) {
      if (e.target.classList.contains('hours-input')) {
        const loadId = e.target.getAttribute('data-load-id');
        const hours = e.target.value;

        fetch(`/api/group_subject_load/${loadId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hours_per_week: hours })
        })
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              // Обновляем итоговую сумму
              location.reload();
            } else {
              alert('Ошибка: ' + result.message);
              e.target.value = e.target.defaultValue;
            }
          })
          .catch(error => {
            alert('Ошибка сети: ' + error);
            e.target.value = e.target.defaultValue;
          });
      }
    });

    // Удаление нагрузки
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('delete-load-btn')) {
        const loadId = e.target.getAttribute('data-load-id');

        if (confirm('Удалить эту нагрузку?')) {
          fetch(`/api/group_subject_load/${loadId}`, {
            method: 'DELETE'
          })
            .then(response => response.json())
            .then(result => {
              if (result.success) {
                document.getElementById(`load-row-${loadId}`).remove();
                // Обновляем страницу для пересчета итогов
                setTimeout(() => location.reload(), 500);
              } else {
                alert('Ошибка: ' + result.message);
              }
            })
            .catch(error => {
              alert('Ошибка сети: ' + error);
            });
        }
      }

      // Редактирование преподавателя
      if (e.target.classList.contains('edit-teacher-btn')) {
        const loadId = e.target.getAttribute('data-load-id');
        const teacherId = e.target.getAttribute('data-teacher-id');

        document.getElementById('editLoadId').value = loadId;
        document.getElementById('editTeacherId').value = teacherId;

        const modal = new bootstrap.Modal(document.getElementById('editTeacherModal'));
        modal.show();
      }
    });

    // Сохранение преподавателя
    document.getElementById('saveTeacherBtn').addEventListener('click', function () {
      const loadId = document.getElementById('editLoadId').value;
      const teacherId = document.getElementById('editTeacherId').value;

      fetch(`/api/group_subject_load/${loadId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ teacher_id: teacherId })
      })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('editTeacherModal'));
            modal.hide();
            location.reload();
          } else {
            alert('Ошибка: ' + result.message);
          }
        })
        .catch(error => {
          alert('Ошибка сети: ' + error);
        });
    });
  </script>
</body>

</html>

index.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Система расписания колледжа</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }

    .welcome-card {
      background: white;
      border-radius: 15px;
      padding: 40px;
      margin-top: 50px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .feature-icon {
      font-size: 2.5rem;
      color: #667eea;
      margin-bottom: 15px;
    }

    .btn-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 25px;
      font-weight: 600;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10">
        <div class="text-center text-white py-5">
          <h1 class="display-4 mb-3">
            <i class="bi bi-calendar-week"></i>
            Система расписания колледжа
          </h1>
          <p class="lead">Управление учебным расписанием</p>
        </div>

        <div class="welcome-card">
          <div class="row text-center">
            <div class="col-md-4 mb-4">
              <div class="feature-icon">
                <i class="bi bi-calendar-check"></i>
              </div>
              <h5>Просмотр расписания</h5>
              <p>Просматривайте расписание по дням, группам и преподавателям</p>
              <a href="/schedule" class="btn btn-outline-primary">Перейти</a>
            </div>
            <div class="col-md-4 mb-4">
              <div class="feature-icon">
                <i class="bi bi-gear"></i>
              </div>
              <h5>Управление</h5>
              <p>Администраторам доступно управление расписанием</p>
              <a href="/login" class="btn btn-outline-primary">Войти</a>
            </div>
            <div class="col-md-4 mb-4">
              <div class="feature-icon">
                <i class="bi bi-bar-chart"></i>
              </div>
              <h5>Статистика</h5>
              <p>Анализ нагрузки преподавателей и групп</p>
              <button onclick="checkLogin('/statistics')" class="btn btn-outline-primary">Перейти</button>
            </div>
          </div>

          <div class="row text-center mt-4">
            <div class="col-md-6 mb-4">
              <div class="feature-icon">
                <i class="bi bi-calendar-event"></i>
              </div>
              <h5>Текущее расписание</h5>
              <p>Редактирование и управление текущим расписанием</p>
              <button onclick="checkLogin('/current_schedule')" class="btn btn-outline-info">Перейти</button>
            </div>
            <div class="col-md-6 mb-4">
              <div class="feature-icon">
                <i class="bi bi-people"></i>
              </div>
              <h5>Управление группами</h5>
              <p>Настройка предметов и преподавателей для групп</p>
              <button onclick="checkLogin('/group_management')" class="btn btn-outline-info">Перейти</button>
            </div>
          </div>
        </div>

        <div class="text-center text-white mt-4">
          <p class="small">
            Для доступа к административным функциям используйте:<br>
            Логин: <strong>admin</strong> | Пароль: <strong>admin123</strong>
          </p>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function checkLogin(url) {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          window.location.href = url;
        } else {
          window.location.href = '/login';
        }
      } catch (error) {
        window.location.href = '/login';
      }
    }

    async function checkUserStatus() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          document.querySelectorAll('.btn-outline-primary[href="/login"]').forEach(btn => {
            btn.textContent = 'Админ-панель';
            btn.href = '/admin';
          });
        }
      } catch (error) {
        console.error('Ошибка проверки статуса:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', checkUserStatus);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>

login.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Вход в систему</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
    }

    .login-container {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      max-width: 400px;
      width: 100%;
      margin: 0 auto;
    }

    .login-icon {
      font-size: 3rem;
      color: #667eea;
      margin-bottom: 15px;
    }

    .btn-login {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 25px;
      font-weight: 600;
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="login-container">
          <div class="text-center mb-4">
            <div class="login-icon">
              <i class="bi bi-person-circle"></i>
            </div>
            <h2>Вход в систему</h2>
            <p class="text-muted">Введите данные для доступа</p>
          </div>

          <form id="loginForm">
            <div class="mb-3">
              <label for="username" class="form-label">Имя пользователя</label>
              <input type="text" class="form-control" id="username" required>
            </div>

            <div class="mb-4">
              <label for="password" class="form-label">Пароль</label>
              <input type="password" class="form-control" id="password" required>
            </div>

            <div class="d-grid mb-3">
              <button type="submit" class="btn-login">
                <i class="bi bi-box-arrow-in-right"></i> Войти
              </button>
            </div>

            <div class="text-center">
              <a href="/" class="text-decoration-none">
                <i class="bi bi-arrow-left"></i> Вернуться на главную
              </a>
            </div>
          </form>

          <div id="message" class="mt-3"></div>

          <div class="alert alert-info mt-4">
            <i class="bi bi-info-circle"></i>
            <strong>Демо доступ:</strong><br>
            Логин: <code>admin</code><br>
            Пароль: <code>admin123</code>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById('loginForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const messageDiv = document.getElementById('message');

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Вход...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });

        const data = await response.json();

        if (data.success) {
          messageDiv.innerHTML = `
                        <div class="alert alert-success alert-dismissible fade show">
                            <i class="bi bi-check-circle"></i> Успешный вход!
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;

          setTimeout(() => {
            window.location.href = '/admin';
          }, 1000);
        } else {
          messageDiv.innerHTML = `
                        <div class="alert alert-danger alert-dismissible fade show">
                            <i class="bi bi-exclamation-triangle"></i> ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    `;
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }

      } catch (error) {
        messageDiv.innerHTML = `
                    <div class="alert alert-danger alert-dismissible fade show">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка сети: ${error.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          window.location.href = '/admin';
        }
      } catch (error) {
        console.error('Ошибка проверки авторизации:', error);
      }
    }

    document.addEventListener('DOMContentLoaded', checkAuth);
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>

schedule.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Просмотр расписания</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .schedule-table {
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }

    .pair-header {
      background-color: #f8f9fa;
      font-weight: bold;
      text-align: center;
      vertical-align: middle !important;
    }

    .group-header {
      background-color: #e9ecef;
      font-weight: bold;
      text-align: center;
      vertical-align: middle !important;
    }

    .lesson-cell {
      min-height: 100px;
      vertical-align: top;
      border-right: 1px solid #dee2e6;
      border-bottom: 1px solid #dee2e6;
    }

    .lesson-entry {
      padding: 8px;
      margin: 2px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .main-lesson {
      background-color: #d1ecf1;
      border-left: 4px solid #17a2b8;
    }

    .changed-lesson {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .badge-even {
      background-color: #28a745;
    }

    .badge-odd {
      background-color: #dc3545;
    }

    .time-cell {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
    }

    .empty-cell {
      color: #adb5bd;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand" href="/">
        <i class="bi bi-calendar-week"></i> Расписание колледжа
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="/admin"><i class="bi bi-gear"></i> Админ-панель</a>
      </div>
    </div>
  </nav>

  <div class="container mt-4">
    <h2 class="mb-4">
      <i class="bi bi-calendar-check"></i> Просмотр расписания
      <small class="text-muted fs-6" id="currentInfo">Загрузка...</small>
    </h2>

    <!-- Фильтры -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">День недели:</label>
            <select class="form-select" id="daySelect" onchange="loadSchedule()">
              <option value="Понедельник">Понедельник</option>
              <option value="Вторник">Вторник</option>
              <option value="Среда">Среда</option>
              <option value="Четверг">Четверг</option>
              <option value="Пятница">Пятница</option>
              <option value="Суббота">Суббота</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Тип расписания:</label>
            <select class="form-select" id="typeSelect" onchange="loadSchedule()">
              <option value="current">Текущее расписание</option>
              <option value="main">Основное расписание</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Неделя:</label>
            <input type="number" class="form-control" id="weekInput" min="1" max="52" value="1"
              onchange="loadSchedule()">
          </div>
          <div class="col-md-2">
            <label class="form-label">Семестр:</label>
            <select class="form-select" id="semesterSelect" onchange="loadSchedule()">
              <option value="1">1 семестр</option>
              <option value="2">2 семестр</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="loadSchedule()">
              <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-12">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="showChanged" checked onchange="renderSchedule()">
              <label class="form-check-label" for="showChanged">Показывать изменения</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="showMain" checked onchange="renderSchedule()">
              <label class="form-check-label" for="showMain">Показывать основное</label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Расписание -->
    <div class="schedule-table">
      <div id="scheduleContainer">
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
          <p class="mt-3">Загрузка расписания...</p>
        </div>
      </div>
    </div>

    <!-- Легенда -->
    <div class="card mt-4">
      <div class="card-body">
        <h6><i class="bi bi-info-circle"></i> Легенда:</h6>
        <div class="row">
          <div class="col-md-4">
            <div class="d-flex align-items-center mb-2">
              <div class="lesson-entry main-lesson me-2" style="width: 20px; height: 20px;"></div>
              <span>Основное расписание</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center mb-2">
              <div class="lesson-entry changed-lesson me-2" style="width: 20px; height: 20px;"></div>
              <span>Измененное расписание</span>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center mb-2">
              <span class="badge badge-even me-2">Ч</span>
              <span>Четная неделя</span>
            </div>
            <div class="d-flex align-items-center">
              <span class="badge badge-odd me-2">Н</span>
              <span>Нечетная неделя</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentSchedule = [];
    let currentDay = 'Понедельник';
    let currentWeek = 1;
    let currentSemester = 1;
    let scheduleType = 'current';
    let showChanged = true;
    let showMain = true;

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await loadSettings();
      await loadSchedule();
    });

    // Загрузка настроек
    async function loadSettings() {
      try {
        const response = await fetch('/api/settings/current');
        if (response.ok) {
          const settings = await response.json();
          currentWeek = settings.week || 1;
          currentSemester = settings.semester || 1;

          document.getElementById('weekInput').value = currentWeek;
          document.getElementById('semesterSelect').value = currentSemester;

          updateCurrentInfo();
        }
      } catch (error) {
        console.error('Ошибка загрузки настроек:', error);
      }
    }

    // Обновление информации в заголовке
    function updateCurrentInfo() {
      const weekType = currentWeek % 2 === 0 ? 'четная' : 'нечетная';
      document.getElementById('currentInfo').innerHTML = ` | Неделя: ${currentWeek} (${weekType}), Семестр: ${currentSemester}`;
    }

    // Загрузка расписания
    async function loadSchedule() {
      currentDay = document.getElementById('daySelect').value;
      currentWeek = parseInt(document.getElementById('weekInput').value) || 1;
      currentSemester = parseInt(document.getElementById('semesterSelect').value) || 1;
      scheduleType = document.getElementById('typeSelect').value;
      showChanged = document.getElementById('showChanged').checked;
      showMain = document.getElementById('showMain').checked;

      updateCurrentInfo();

      // Показываем загрузку
      document.getElementById('scheduleContainer').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-3">Загрузка расписания...</p>
                </div>
            `;

      try {
        let url;
        if (scheduleType === 'main') {
          url = `/api/schedule/main?day=${encodeURIComponent(currentDay)}&semester=${currentSemester}`;
        } else {
          url = `/api/schedule/current?day=${encodeURIComponent(currentDay)}&week=${currentWeek}&semester=${currentSemester}`;
        }

        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Ошибка загрузки расписания');
        }

        currentSchedule = await response.json();
        renderSchedule();

      } catch (error) {
        console.error('Ошибка:', error);
        document.getElementById('scheduleContainer').innerHTML = `
                    <div class="alert alert-danger m-4">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки расписания: ${error.message}
                    </div>
                `;
      }
    }

    // Отображение расписания
    function renderSchedule() {
      showChanged = document.getElementById('showChanged').checked;
      showMain = document.getElementById('showMain').checked;

      // Фильтруем расписание по настройкам отображения
      let filteredSchedule = currentSchedule.filter(lesson => {
        if (scheduleType === 'current') {
          if (lesson.is_changed && !showChanged) return false;
          if (!lesson.is_changed && !showMain) return false;
        }
        return true;
      });

      // Группируем по группам
      const groups = [...new Set(filteredSchedule.map(lesson => lesson.group))].sort();

      // Получаем все пары для текущего дня
      const allPairs = getAvailablePairsForDay(currentDay);

      if (groups.length === 0 || filteredSchedule.length === 0) {
        document.getElementById('scheduleContainer').innerHTML = `
                    <div class="empty-cell">
                        <i class="bi bi-calendar-x" style="font-size: 3rem;"></i>
                        <h4 class="mt-3">Нет занятий</h4>
                        <p class="text-muted">На ${currentDay} нет занятий</p>
                    </div>
                `;
        return;
      }

      // Создаем таблицу
      let html = `
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th class="pair-header" style="width: 100px;">Пара</th>
                                <th class="pair-header" style="width: 120px;">Время</th>
            `;

      // Заголовки групп
      groups.forEach(group => {
        html += `<th class="group-header">${group}</th>`;
      });

      html += `</tr></thead><tbody>`;

      // Для каждой пары
      allPairs.forEach(pairNum => {
        const pairTime = getPairTime(currentDay, pairNum);

        html += `
                    <tr>
                        <td class="pair-header text-center">
                            <strong>${pairNum}</strong>
                        </td>
                        <td class="time-cell">
                            ${pairTime}
                        </td>
                `;

        // Для каждой группы
        groups.forEach(group => {
          // Находим занятия для этой группы и этой пары
          const lessons = filteredSchedule.filter(lesson =>
            lesson.group === group && lesson.pair === pairNum
          );

          html += `<td class="lesson-cell p-2">`;

          if (lessons.length === 0) {
            html += `<div class="text-center text-muted py-3">-</div>`;
          } else {
            lessons.forEach(lesson => {
              const lessonClass = lesson.is_changed ? 'changed-lesson' : 'main-lesson';
              const weekBadge = scheduleType === 'main' && lesson.week_parity !== 'both' ?
                `<span class="badge ${lesson.week_parity === 'even' ? 'badge-even' : 'badge-odd'}">${lesson.week_parity === 'even' ? 'Ч' : 'Н'}</span>` : '';

              html += `
                                <div class="lesson-entry ${lessonClass}">
                                    ${weekBadge}
                                    <div class="fw-bold">${lesson.subject}</div>
                                    <div class="small">${lesson.teacher}</div>
                                    <div class="small text-muted">ауд. ${lesson.room}</div>
                                    <div class="small">урок ${lesson.lesson_number}</div>
                                    ${lesson.is_changed ? '<span class="badge bg-warning badge-sm">изм</span>' : ''}
                                </div>
                            `;
            });
          }

          html += `</td>`;
        });

        html += `</tr>`;
      });

      html += `</tbody></table></div>`;

      document.getElementById('scheduleContainer').innerHTML = html;
    }

    // Вспомогательные функции для работы с парами
    function getAvailablePairsForDay(day) {
      if (day === "Суббота") {
        return [1, 2, 3, 4];
      } else if (day in ["Понедельник", "Четверг"]) {
        return [0, 1, 2, 3, 4, 5, 6];
      } else {
        return [1, 2, 3, 4, 5, 6];
      }
    }

    function getPairTime(day, pair) {
      if (pair === 0) return "8:30-9:10";
      if (pair === 1) {
        if (day === "Суббота") return "8:00-9:25";
        if (day in ["Понедельник", "Четверг"]) return "9:15-10:40";
        return "8:30-9:55";
      }
      if (pair === 2) {
        if (day === "Суббота") return "9:30-10:55";
        if (day in ["Понедельник", "Четверг"]) return "11:20-12:45";
        return "10:35-12:00";
      }
      if (pair === 3) {
        if (day === "Суббота") return "11:00-12:25";
        if (day in ["Понедельник", "Четверг"]) return "13:25-14:50";
        return "12:40-14:05";
      }
      if (pair === 4) {
        if (day === "Суббота") return "12:30-13:55";
        if (day in ["Понедельник", "Четверг"]) return "15:00-16:25";
        return "14:15-15:40";
      }
      if (pair === 5) {
        if (day in ["Понедельник", "Четверг"]) return "16:30-17:55";
        return "15:45-17:10";
      }
      if (pair === 6) {
        if (day in ["Понедельник", "Четверг"]) return "18:00-19:25";
        return "17:15-18:40";
      }
      return "";
    }

    // Обработчики чекбоксов
    document.getElementById('showChanged').addEventListener('change', renderSchedule);
    document.getElementById('showMain').addEventListener('change', renderSchedule);
  </script>
</body>

</html>

semester_management.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Управление семестрами</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .btn-week {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 2px;
    }
  </style>
</head>

<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">
        <i class="bi bi-arrow-left"></i> Управление семестрами
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="userInfo">Загрузка...</span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- Текущий статус -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="stat-card">
          <h5><i class="bi bi-calendar-week"></i> Текущая неделя</h5>
          <div class="d-flex align-items-center mt-3">
            <h1 class="display-1 me-4" id="currentWeek">1</h1>
            <div>
              <div class="mb-2">
                <span class="badge bg-primary" id="weekParityBadge">Нечетная</span>
              </div>
              <button class="btn btn-outline-primary btn-sm" onclick="showWeekSelector()">
                Изменить неделю
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="stat-card">
          <h5><i class="bi bi-calendar-month"></i> Текущий семестр</h5>
          <div class="d-flex align-items-center mt-3">
            <h1 class="display-1 me-4" id="currentSemester">1</h1>
            <div>
              <div class="mb-2">
                <span class="badge bg-success">Активен</span>
              </div>
              <button class="btn btn-outline-success btn-sm" onclick="changeSemester()">
                Сменить семестр
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Управление неделями -->
    <div class="stat-card">
      <h5><i class="bi bi-calendar-range"></i> Управление неделями</h5>
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="mb-3">
            <label class="form-label">Быстрый переход к неделе:</label>
            <div class="input-group">
              <input type="number" class="form-control" id="quickWeekInput" min="1" max="52" value="1">
              <button class="btn btn-primary" type="button" onclick="setQuickWeek()">
                Перейти
              </button>
            </div>
          </div>
          <div class="d-flex flex-wrap mb-3" id="weekButtons">
            <!-- Кнопки недель будут созданы здесь -->
          </div>
        </div>
        <div class="col-md-6">
          <div class="alert alert-info">
            <h6><i class="bi bi-info-circle"></i> Информация</h6>
            <p class="mb-1">• В семестре 52 учебные недели</p>
            <p class="mb-1">• Неделя считается четной, если ее номер делится на 2</p>
            <p class="mb-1">• Основное расписание может зависеть от четности недели</p>
            <p class="mb-0">• При переходе на новую неделю расписание копируется из основного</p>
          </div>
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="nextWeek()">
              <i class="bi bi-arrow-right-circle"></i> Перейти на следующую неделю
            </button>
            <button class="btn btn-outline-warning" onclick="updateFromMain()">
              <i class="bi bi-arrow-clockwise"></i> Обновить из основного расписания
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Статистика -->
    <div class="stat-card">
      <h5><i class="bi bi-bar-chart"></i> Статистика</h5>
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-body">
              <h6>Занятий на текущей неделе</h6>
              <div class="d-flex justify-content-between">
                <div>
                  <h3 id="totalLessons">0</h3>
                  <small class="text-muted">Всего занятий</small>
                </div>
                <div>
                  <h3 id="changedLessons">0</h3>
                  <small class="text-muted">Изменено</small>
                </div>
                <div>
                  <h3 id="mainLessons">0</h3>
                  <small class="text-muted">Основных</small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card bg-light">
            <div class="card-body">
              <h6>Основное расписание</h6>
              <div class="d-flex justify-content-between">
                <div>
                  <h3 id="totalMainLessons">0</h3>
                  <small class="text-muted">Всего занятий</small>
                </div>
                <div>
                  <h3 id="evenLessons">0</h3>
                  <small class="text-muted">Четные недели</small>
                </div>
                <div>
                  <h3 id="oddLessons">0</h3>
                  <small class="text-muted">Нечетные недели</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Модальное окно выбора недели -->
  <div class="modal fade" id="weekModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Выбор недели</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Номер недели (1-52):</label>
            <input type="number" class="form-control" id="weekSelectInput" min="1" max="52" value="1">
          </div>
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            При изменении недели текущее расписание будет обновлено из основного
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="button" class="btn btn-primary" onclick="setSelectedWeek()">Установить</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentSettings = {};

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await checkAuth();
      await loadUserInfo();
      await loadCurrentSettings();
      await loadStatistics();
      generateWeekButtons();
    });

    // Проверка авторизации
    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (!data.authenticated || data.role !== 'admin') {
          window.location.href = '/login';
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login';
        return false;
      }
    }

    // Загрузка информации о пользователе
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userInfo').innerHTML = `
                        <i class="bi bi-person-circle"></i> ${data.username}
                    `;
        }
      } catch (error) {
        console.error('Ошибка загрузки информации о пользователе:', error);
      }
    }

    // Загрузка текущих настроек
    async function loadCurrentSettings() {
      try {
        const response = await fetch('/api/settings/current');
        if (response.ok) {
          currentSettings = await response.json();
          updateDisplay();
        }
      } catch (error) {
        console.error('Ошибка загрузки настроек:', error);
      }
    }

    // Обновление отображения
    function updateDisplay() {
      document.getElementById('currentWeek').textContent = currentSettings.week || 1;
      document.getElementById('currentSemester').textContent = currentSettings.semester || 1;

      const week = currentSettings.week || 1;
      const isEven = week % 2 === 0;
      document.getElementById('weekParityBadge').textContent = isEven ? 'Четная' : 'Нечетная';
      document.getElementById('weekParityBadge').className = isEven ? 'badge bg-success' : 'badge bg-primary';

      document.getElementById('quickWeekInput').value = week;
    }

    // Генерация кнопок недель
    function generateWeekButtons() {
      const container = document.getElementById('weekButtons');
      container.innerHTML = '';

      for (let week = 1; week <= 52; week++) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'btn btn-week btn-outline-secondary';
        if (week === (currentSettings.week || 1)) {
          button.className = 'btn btn-week btn-primary';
        }
        button.textContent = week;
        button.title = `Неделя ${week}`;
        button.addEventListener('click', () => setWeek(week));
        container.appendChild(button);
      }
    }

    // Показать модальное окно выбора недели
    function showWeekSelector() {
      document.getElementById('weekSelectInput').value = currentSettings.week || 1;
      const modal = new bootstrap.Modal(document.getElementById('weekModal'));
      modal.show();
    }

    // Установить выбранную неделю
    async function setSelectedWeek() {
      const week = parseInt(document.getElementById('weekSelectInput').value);
      await setWeek(week);
      const modal = bootstrap.Modal.getInstance(document.getElementById('weekModal'));
      modal.hide();
    }

    // Установить неделю
    async function setWeek(week) {
      try {
        const response = await fetch('/api/settings/set_week', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ week: week })
        });

        const data = await response.json();

        if (data.success) {
          currentSettings.week = week;
          updateDisplay();
          generateWeekButtons();
          await loadStatistics();
          alert(`Установлена неделя ${week}`);
        } else {
          alert('Ошибка: ' + data.message);
        }
      } catch (error) {
        alert('Ошибка сети: ' + error.message);
      }
    }

    // Быстрый переход к неделе
    async function setQuickWeek() {
      const week = parseInt(document.getElementById('quickWeekInput').value);
      if (week < 1 || week > 52) {
        alert('Неделя должна быть от 1 до 52');
        return;
      }
      await setWeek(week);
    }

    // Следующая неделя
    async function nextWeek() {
      const currentWeek = currentSettings.week || 1;
      const nextWeek = currentWeek < 52 ? currentWeek + 1 : 1;

      if (confirm(`Перейти с недели ${currentWeek} на неделю ${nextWeek}?`)) {
        await setWeek(nextWeek);
      }
    }

    // Смена семестра
    async function changeSemester() {
      const currentSemester = currentSettings.semester || 1;
      const newSemester = currentSemester === 1 ? 2 : 1;

      if (confirm(`Перейти с ${currentSemester} семестра на ${newSemester} семестр?\n\nВНИМАНИЕ: Все данные текущего семестра будут сохранены.`)) {
        try {
          const response = await fetch('/api/settings/set_semester', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ semester: newSemester })
          });

          const data = await response.json();

          if (data.success) {
            currentSettings.semester = newSemester;
            updateDisplay();
            await loadStatistics();
            alert(`Установлен ${newSemester} семестр`);
          } else {
            alert('Ошибка: ' + data.message);
          }
        } catch (error) {
          alert('Ошибка сети: ' + error.message);
        }
      }
    }

    // Обновить из основного расписания
    async function updateFromMain() {
      if (!confirm('Обновить текущее расписание из основного?\n\nВсе изменения в текущем расписании будут потеряны.')) {
        return;
      }

      // Здесь должна быть реализация обновления из основного расписания
      alert('Функция обновления из основного расписания будет реализована позже');
    }

    // Загрузка статистики
    async function loadStatistics() {
      try {
        // Статистика текущего расписания
        const currentResponse = await fetch(`/api/schedule/current?week=${currentSettings.week || 1}&semester=${currentSettings.semester || 1}`);
        if (currentResponse.ok) {
          const currentSchedule = await currentResponse.json();

          const totalLessons = currentSchedule.length;
          const changedLessons = currentSchedule.filter(l => l.is_changed).length;
          const mainLessons = totalLessons - changedLessons;

          document.getElementById('totalLessons').textContent = totalLessons;
          document.getElementById('changedLessons').textContent = changedLessons;
          document.getElementById('mainLessons').textContent = mainLessons;
        }

        // Статистика основного расписания
        const mainResponse = await fetch(`/api/schedule/main?semester=${currentSettings.semester || 1}`);
        if (mainResponse.ok) {
          const mainSchedule = await mainResponse.json();

          const totalMainLessons = mainSchedule.length;
          const evenLessons = mainSchedule.filter(l => l.week_parity === 'even').length;
          const oddLessons = mainSchedule.filter(l => l.week_parity === 'odd').length;

          document.getElementById('totalMainLessons').textContent = totalMainLessons;
          document.getElementById('evenLessons').textContent = evenLessons;
          document.getElementById('oddLessons').textContent = oddLessons;
        }
      } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
      }
    }
  </script>
</body>

</html>

statistics.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Статистика</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .chart-container {
      height: 300px;
      position: relative;
    }

    .progress-container {
      margin-top: 10px;
    }

    .progress-label {
      font-size: 0.85rem;
      margin-bottom: 5px;
    }

    .hours-badge {
      background-color: #28a745;
      font-size: 0.8rem;
      padding: 3px 8px;
      border-radius: 10px;
    }

    .conflict-indicator {
      color: #dc3545;
      animation: blink 1s infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }
  </style>
</head>

<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">
        <i class="bi bi-arrow-left"></i> Статистика
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="userInfo">Загрузка...</span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- Фильтры -->
    <div class="stat-card">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Неделя:</label>
          <input type="number" class="form-control" id="weekInput" min="1" max="52" value="1"
            onchange="loadStatistics()">
        </div>
        <div class="col-md-3">
          <label class="form-label">Семестр:</label>
          <select class="form-select" id="semesterSelect" onchange="loadStatistics()">
            <option value="1">1 семестр</option>
            <option value="2">2 семестр</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Тип статистики:</label>
          <select class="form-select" id="statType" onchange="loadStatistics()">
            <option value="full">Полная статистика</option>
            <option value="hours">По часам (проведено/осталось)</option>
            <option value="conflicts">Конфликты</option>
            <option value="autofill">Статистика автозаполнения</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="loadStatistics()">
            <i class="bi bi-arrow-clockwise"></i> Обновить
          </button>
        </div>
      </div>
    </div>

    <!-- Основная статистика -->
    <div class="row mb-4" id="mainStats">
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="totalLessons">0</h3>
          <p class="text-muted mb-0">Всего занятий</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="completedHours">0</h3>
          <p class="text-muted mb-0">Часов проведено</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="remainingHours">0</h3>
          <p class="text-muted mb-0">Часов осталось</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="conflictCount">0</h3>
          <p class="text-muted mb-0">Конфликтов</p>
        </div>
      </div>
    </div>

    <!-- Прогресс выполнения -->
    <div class="stat-card" id="progressCard" style="display: none;">
      <h5 class="mb-3"><i class="bi bi-speedometer2"></i> Прогресс выполнения учебного плана</h5>
      <div id="progressContent">
        <!-- Прогресс будет загружен здесь -->
      </div>
    </div>

    <!-- Таблица статистики -->
    <div class="stat-card" id="tableCard">
      <h5 class="mb-3" id="tableTitle">Полная статистика</h5>
      <div class="table-responsive">
        <table class="table table-hover" id="statsTable">
          <thead>
            <tr id="tableHeaders">
              <!-- Заголовки будут загружены динамически -->
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Данные будут загружены динамически -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Диаграмма -->
    <div class="stat-card" id="chartCard">
      <h5 class="mb-3">Визуализация данных</h5>
      <div class="chart-container">
        <canvas id="statsChart"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let statsChart = null;
    let currentSettings = {};

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await checkAuth();
      await loadUserInfo();
      await loadCurrentSettings();
      await loadStatistics();
    });

    // Проверка авторизации
    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (!data.authenticated || data.role !== 'admin') {
          window.location.href = '/login';
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login';
        return false;
      }
    }

    // Загрузка информации о пользователе
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userInfo').innerHTML = `
            <i class="bi bi-person-circle"></i> ${data.username}
          `;
        }
      } catch (error) {
        console.error('Ошибка загрузки информации о пользователе:', error);
      }
    }

    // Загрузка текущих настроек
    async function loadCurrentSettings() {
      try {
        const response = await fetch('/api/settings/current');
        if (response.ok) {
          currentSettings = await response.json();
          document.getElementById('weekInput').value = currentSettings.week || 1;
          document.getElementById('semesterSelect').value = currentSettings.semester || 1;
        }
      } catch (error) {
        console.error('Ошибка загрузки настроек:', error);
      }
    }

    // Загрузка статистики
    async function loadStatistics() {
      const week = document.getElementById('weekInput').value;
      const semester = document.getElementById('semesterSelect').value;
      const statType = document.getElementById('statType').value;

      // Показываем индикатор загрузки
      document.getElementById('tableBody').innerHTML = `
        <tr>
          <td colspan="6" class="text-center">
            <div class="spinner-border spinner-border-sm" role="status"></div>
            <span class="ms-2">Загрузка данных...</span>
          </td>
        </tr>
      `;

      try {
        if (statType === 'full' || statType === 'hours') {
          await loadFullStatistics(week, semester, statType);
        } else if (statType === 'conflicts') {
          await loadConflictsStatistics(week, semester);
        } else if (statType === 'autofill') {
          await loadAutofillStatistics();
        }

      } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
        document.getElementById('tableBody').innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-danger">
              <i class="bi bi-exclamation-triangle"></i> ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // Загрузка полной статистики
    async function loadFullStatistics(week, semester, statType) {
      try {
        const response = await fetch(`/api/statistics/full?week=${week}&semester=${semester}`);
        if (!response.ok) {
          throw new Error(`Ошибка сервера: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
          displayFullStatistics(data, statType);

          // Проверяем конфликты
          await checkForConflicts(week, semester);
        } else {
          throw new Error(data.message || 'Ошибка загрузки данных');
        }

      } catch (error) {
        console.error('Ошибка загрузки статистики:', error);
        throw error;
      }
    }

    // Отображение полной статистики
    function displayFullStatistics(data, statType) {
      // Обновляем основные показатели
      document.getElementById('totalLessons').textContent = data.total_completed_hours / 2;
      document.getElementById('completedHours').textContent = data.total_completed_hours;
      document.getElementById('remainingHours').textContent = data.total_remaining_hours;

      // Показываем прогресс
      showProgress(data.group_stats);

      if (statType === 'full') {
        displayGroupStatsFull(data.group_stats);
      } else if (statType === 'hours') {
        displayHoursStats(data.group_stats);
      }
    }

    // Показать прогресс выполнения
    function showProgress(groupStats) {
      const progressCard = document.getElementById('progressCard');
      const progressContent = document.getElementById('progressContent');

      if (groupStats.length > 0) {
        progressCard.style.display = 'block';

        let html = '<div class="row">';

        groupStats.forEach(group => {
          const progressPercent = group.progress || 0;
          const progressColor = progressPercent >= 100 ? 'bg-success' :
            progressPercent >= 75 ? 'bg-info' :
              progressPercent >= 50 ? 'bg-warning' : 'bg-danger';

          html += `
            <div class="col-md-6 mb-3">
              <div class="progress-label">
                <strong>${group.group_name}</strong> (${group.course} курс)
                <span class="float-end">${progressPercent}%</span>
              </div>
              <div class="progress">
                <div class="progress-bar ${progressColor}" 
                     role="progressbar" 
                     style="width: ${Math.min(progressPercent, 100)}%">
                </div>
              </div>
              <div class="small text-muted">
                ${group.completed_hours} ч проведено / ${group.total_hours} ч всего
                ${group.remaining_hours > 0 ? `(${group.remaining_hours} ч осталось)` : '(завершено)'}
              </div>
            </div>
          `;
        });

        html += '</div>';
        progressContent.innerHTML = html;
      } else {
        progressCard.style.display = 'none';
      }
    }

    // Отображение статистики по группам (полная)
    function displayGroupStatsFull(groupStats) {
      const headers = document.getElementById('tableHeaders');
      const body = document.getElementById('tableBody');
      const tableTitle = document.getElementById('tableTitle');

      tableTitle.textContent = 'Статистика по группам';

      headers.innerHTML = `
        <th>Группа</th>
        <th class="text-center">Курс</th>
        <th class="text-center">Всего часов</th>
        <th class="text-center">Проведено</th>
        <th class="text-center">Осталось</th>
        <th class="text-center">Прогресс</th>
        <th class="text-center">Занятий</th>
        <th class="text-center">Предметов</th>
      `;

      // Сортировка по курсу и названию группы
      groupStats.sort((a, b) => {
        if (a.course !== b.course) return a.course - b.course;
        return a.group_name.localeCompare(b.group_name);
      });

      body.innerHTML = '';

      if (groupStats.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-muted">
              <i class="bi bi-info-circle"></i> Нет данных для отображения
            </td>
          </tr>
        `;
        return;
      }

      groupStats.forEach(group => {
        const progressPercent = group.progress || 0;
        const progressColor = progressPercent >= 100 ? 'success' :
          progressPercent >= 75 ? 'info' :
            progressPercent >= 50 ? 'warning' : 'danger';

        const subjectsCount = group.subjects ? group.subjects.length : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>
            <strong>${group.group_name}</strong>
            ${subjectsCount > 0 ? `<br><small class="text-muted">${subjectsCount} предметов</small>` : ''}
          </td>
          <td class="text-center">
            <span class="badge bg-secondary">${group.course}</span>
          </td>
          <td class="text-center">
            <span class="badge bg-primary">${group.total_hours}</span>
          </td>
          <td class="text-center">
            <span class="badge bg-success">${group.completed_hours}</span>
          </td>
          <td class="text-center">
            <span class="badge ${group.remaining_hours > 0 ? 'bg-warning' : 'bg-secondary'}">
              ${group.remaining_hours}
            </span>
          </td>
          <td class="text-center">
            <span class="badge bg-${progressColor}">${progressPercent}%</span>
          </td>
          <td class="text-center">
            ${group.total_lessons}
            ${group.changed_lessons > 0 ?
            `<br><small class="text-warning">(${group.changed_lessons} изменено)</small>` : ''}
          </td>
          <td class="text-center">${subjectsCount}</td>
        `;
        body.appendChild(row);
      });

      // Создаем диаграмму с прогрессом
      createProgressChart(groupStats);
    }

    // Отображение статистики по часам
    function displayHoursStats(groupStats) {
      const headers = document.getElementById('tableHeaders');
      const body = document.getElementById('tableBody');
      const tableTitle = document.getElementById('tableTitle');

      tableTitle.textContent = 'Статистика по часам (проведено/осталось)';

      headers.innerHTML = `
        <th>Группа</th>
        <th class="text-center">Курс</th>
        <th>Предметы и часы</th>
        <th class="text-center">Проведено</th>
        <th class="text-center">Осталось</th>
        <th class="text-center">% выполнения</th>
      `;

      // Сортировка по курсу и названию группы
      groupStats.sort((a, b) => {
        if (a.course !== b.course) return a.course - b.course;
        return a.group_name.localeCompare(b.group_name);
      });

      body.innerHTML = '';

      if (groupStats.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="6" class="text-center text-muted">
              <i class="bi bi-info-circle"></i> Нет данных для отображения
            </td>
          </tr>
        `;
        return;
      }

      groupStats.forEach(group => {
        const progressPercent = group.progress || 0;
        const progressColor = progressPercent >= 100 ? 'success' :
          progressPercent >= 75 ? 'info' :
            progressPercent >= 50 ? 'warning' : 'danger';

        let subjectsHtml = '';
        if (group.subjects && group.subjects.length > 0) {
          group.subjects.forEach(subject => {
            const semesterHours = currentSettings.semester == 1 ?
              subject.total_hours_semester1 : subject.total_hours_semester2;

            subjectsHtml += `
              <div class="mb-1">
                <small>${subject.subject_name}: ${subject.hours_per_week} ч/нед</small>
                ${semesterHours > 0 ?
                `<br><small class="text-muted">Всего за семестр: ${semesterHours} ч</small>` : ''}
              </div>
            `;
          });
        } else {
          subjectsHtml = '<small class="text-muted">Нет предметов</small>';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td><strong>${group.group_name}</strong></td>
          <td class="text-center">${group.course}</td>
          <td>${subjectsHtml}</td>
          <td class="text-center">
            <div class="hours-badge">${group.completed_hours} ч</div>
            <div class="small text-muted">${group.total_lessons} занятий</div>
          </td>
          <td class="text-center">
            <div class="badge ${group.remaining_hours > 0 ? 'bg-warning' : 'bg-secondary'}">
              ${group.remaining_hours} ч
            </div>
          </td>
          <td class="text-center">
            <div class="progress" style="height: 20px; width: 100px; margin: 0 auto;">
              <div class="progress-bar bg-${progressColor}" 
                   style="width: ${Math.min(progressPercent, 100)}%">
                ${progressPercent}%
              </div>
            </div>
          </td>
        `;
        body.appendChild(row);
      });

      // Создаем диаграмму с часами
      createHoursChart(groupStats);
    }

    // Проверка конфликтов
    async function checkForConflicts(week, semester) {
      try {
        const response = await fetch(`/api/schedule/check_conflicts?week=${week}&semester=${semester}`);
        const data = await response.json();

        if (data.success) {
          document.getElementById('conflictCount').textContent = data.conflicts.length;

          if (data.conflicts.length > 0) {
            document.getElementById('conflictCount').className = 'conflict-indicator';
            document.getElementById('conflictCount').title = 'Есть конфликты в расписании';
          } else {
            document.getElementById('conflictCount').className = '';
            document.getElementById('conflictCount').title = 'Конфликтов нет';
          }
        }
      } catch (error) {
        console.error('Ошибка проверки конфликтов:', error);
      }
    }

    // Загрузка статистики конфликтов
    async function loadConflictsStatistics(week, semester) {
      try {
        const response = await fetch(`/api/schedule/check_conflicts?week=${week}&semester=${semester}`);
        const data = await response.json();

        if (data.success) {
          displayConflictsStatistics(data);
        } else {
          throw new Error(data.message || 'Ошибка загрузки конфликтов');
        }
      } catch (error) {
        console.error('Ошибка загрузки конфликтов:', error);
        throw error;
      }
    }

    // Отображение статистики конфликтов
    function displayConflictsStatistics(data) {
      const headers = document.getElementById('tableHeaders');
      const body = document.getElementById('tableBody');
      const tableTitle = document.getElementById('tableTitle');
      const chartCard = document.getElementById('chartCard');
      const progressCard = document.getElementById('progressCard');

      tableTitle.textContent = 'Конфликты в расписании';
      chartCard.style.display = 'none';
      progressCard.style.display = 'none';

      headers.innerHTML = `
        <th>Тип конфликта</th>
        <th>Детали</th>
        <th>День</th>
        <th>Урок</th>
        <th>Группы/Преподаватели</th>
      `;

      body.innerHTML = '';

      if (!data.has_conflicts || data.conflicts.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="5" class="text-center text-success">
              <i class="bi bi-check-circle"></i> Конфликтов не обнаружено!
            </td>
          </tr>
        `;
        return;
      }

      data.conflicts.forEach(conflict => {
        let typeText = '';
        let details = '';

        switch (conflict.type) {
          case 'teacher_conflict':
            typeText = '<span class="badge bg-danger">Конфликт преподавателя</span>';
            details = `Преподаватель ведет одновременно в ${conflict.groups.length} группах`;
            break;
          case 'group_conflict':
            typeText = '<span class="badge bg-warning">Конфликт группы</span>';
            details = `Группа имеет ${conflict.subjects.length} занятия одновременно`;
            break;
          case 'room_conflict':
            typeText = '<span class="badge bg-info">Конфликт аудитории</span>';
            details = `Аудитория занята ${conflict.groups.length} группами одновременно`;
            break;
        }

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${typeText}</td>
          <td>${conflict.message}</td>
          <td>${conflict.day}</td>
          <td class="text-center">${conflict.lesson_number}</td>
          <td>
            ${conflict.groups ? conflict.groups.join(', ') : ''}
            ${conflict.teacher ? `<br><small>Преподаватель: ${conflict.teacher}</small>` : ''}
            ${conflict.room ? `<br><small>Аудитория: ${conflict.room}</small>` : ''}
          </td>
        `;
        body.appendChild(row);
      });

      // Создаем диаграмму с типами конфликтов
      createConflictsChart(data.conflicts);
    }

    // Загрузка статистики автозаполнения
    async function loadAutofillStatistics() {
      try {
        const response = await fetch('/api/autofill/logs');
        const data = await response.json();

        if (data.success) {
          displayAutofillStatistics(data);
        } else {
          throw new Error(data.message || 'Ошибка загрузки статистики автозаполнения');
        }
      } catch (error) {
        console.error('Ошибка загрузки статистики автозаполнения:', error);
        throw error;
      }
    }

    // Отображение статистики автозаполнения
    function displayAutofillStatistics(data) {
      const headers = document.getElementById('tableHeaders');
      const body = document.getElementById('tableBody');
      const tableTitle = document.getElementById('tableTitle');
      const chartCard = document.getElementById('chartCard');
      const progressCard = document.getElementById('progressCard');

      tableTitle.textContent = 'Статистика автозаполнения';
      chartCard.style.display = 'block';
      progressCard.style.display = 'none';

      headers.innerHTML = `
        <th>Дата и время</th>
        <th class="text-center">Неделя</th>
        <th class="text-center">Семестр</th>
        <th class="text-center">Тип</th>
        <th class="text-center">Добавлено</th>
        <th class="text-center">Конфликтов</th>
        <th class="text-center">Ошибок</th>
        <th>Статус</th>
      `;

      body.innerHTML = '';

      if (!data.logs || data.logs.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="8" class="text-center text-muted">
              <i class="bi bi-info-circle"></i> Нет данных об автозаполнении
            </td>
          </tr>
        `;
        return;
      }

      data.logs.forEach(log => {
        let typeText = '';
        switch (log.type) {
          case 'both': typeText = 'Текущее и основное'; break;
          case 'current': typeText = 'Только текущее'; break;
          case 'main': typeText = 'Только основное'; break;
        }

        const status = log.conflicts > 0 ?
          '<span class="badge bg-warning">Есть конфликты</span>' :
          '<span class="badge bg-success">Успешно</span>';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${log.created_at}</td>
          <td class="text-center">${log.week}</td>
          <td class="text-center">${log.semester}</td>
          <td class="text-center"><small>${typeText}</small></td>
          <td class="text-center">
            <span class="badge bg-primary">${log.entries_added}</span>
          </td>
          <td class="text-center">
            <span class="badge ${log.conflicts > 0 ? 'bg-warning' : 'bg-secondary'}">
              ${log.conflicts}
            </span>
          </td>
          <td class="text-center">
            <span class="badge ${log.errors > 0 ? 'bg-danger' : 'bg-secondary'}">
              ${log.errors}
            </span>
          </td>
          <td>${status}</td>
        `;
        body.appendChild(row);
      });

      // Создаем диаграмму со статистикой автозаполнения
      createAutofillChart(data.logs);
    }

    // Создание диаграммы прогресса
    function createProgressChart(groupStats) {
      const ctx = document.getElementById('statsChart').getContext('2d');

      if (statsChart) {
        statsChart.destroy();
      }

      const labels = groupStats.map(g => g.group_name);
      const data = groupStats.map(g => g.progress || 0);
      const colors = data.map(value => {
        if (value >= 100) return 'rgba(40, 167, 69, 0.7)';
        if (value >= 75) return 'rgba(23, 162, 184, 0.7)';
        if (value >= 50) return 'rgba(255, 193, 7, 0.7)';
        return 'rgba(220, 53, 69, 0.7)';
      });

      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Прогресс выполнения (%)',
            data: data,
            backgroundColor: colors,
            borderColor: colors.map(color => color.replace('0.7', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  const group = groupStats[context.dataIndex];
                  return [
                    `Прогресс: ${context.parsed.y}%`,
                    `Проведено: ${group.completed_hours} ч`,
                    `Осталось: ${group.remaining_hours} ч`,
                    `Всего: ${group.total_hours} ч`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Прогресс (%)'
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    // Создание диаграммы часов
    function createHoursChart(groupStats) {
      const ctx = document.getElementById('statsChart').getContext('2d');

      if (statsChart) {
        statsChart.destroy();
      }

      const labels = groupStats.map(g => g.group_name);
      const completedData = groupStats.map(g => g.completed_hours);
      const remainingData = groupStats.map(g => g.remaining_hours);

      statsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Проведено часов',
              data: completedData,
              backgroundColor: 'rgba(40, 167, 69, 0.7)',
              borderColor: 'rgba(40, 167, 69, 1)',
              borderWidth: 1
            },
            {
              label: 'Осталось часов',
              data: remainingData,
              backgroundColor: 'rgba(255, 193, 7, 0.7)',
              borderColor: 'rgba(255, 193, 7, 1)',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  const group = groupStats[context.dataIndex];
                  return [
                    `${context.dataset.label}: ${context.parsed.y} ч`,
                    `Всего часов: ${group.total_hours} ч`,
                    `Прогресс: ${group.progress || 0}%`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Количество часов'
              },
              ticks: {
                callback: function (value) {
                  return value + ' ч';
                }
              }
            },
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
    }

    // Создание диаграммы конфликтов
    function createConflictsChart(conflicts) {
      const ctx = document.getElementById('statsChart').getContext('2d');

      if (statsChart) {
        statsChart.destroy();
      }

      // Группируем конфликты по типам
      const conflictTypes = {};
      conflicts.forEach(conflict => {
        if (!conflictTypes[conflict.type]) {
          conflictTypes[conflict.type] = 0;
        }
        conflictTypes[conflict.type]++;
      });

      const labels = Object.keys(conflictTypes).map(type => {
        switch (type) {
          case 'teacher_conflict': return 'Конфликт преподавателя';
          case 'group_conflict': return 'Конфликт группы';
          case 'room_conflict': return 'Конфликт аудитории';
          default: return type;
        }
      });

      const data = Object.values(conflictTypes);
      const colors = ['rgba(220, 53, 69, 0.7)', 'rgba(255, 193, 7, 0.7)', 'rgba(23, 162, 184, 0.7)'];

      statsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: colors.map(color => color.replace('0.7', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `${context.label}: ${context.parsed} конфликт(ов)`;
                }
              }
            }
          }
        }
      });
    }

    // Создание диаграммы автозаполнения
    function createAutofillChart(logs) {
      const ctx = document.getElementById('statsChart').getContext('2d');

      if (statsChart) {
        statsChart.destroy();
      }

      // Берем последние 10 записей
      const recentLogs = logs.slice(0, 10).reverse();
      const labels = recentLogs.map(log => log.created_at.split(' ')[0]);
      const addedData = recentLogs.map(log => log.entries_added);
      const conflictData = recentLogs.map(log => log.conflicts);

      statsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Добавлено занятий',
              data: addedData,
              borderColor: 'rgba(40, 167, 69, 1)',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              tension: 0.1,
              fill: true
            },
            {
              label: 'Конфликтов',
              data: conflictData,
              borderColor: 'rgba(255, 193, 7, 1)',
              backgroundColor: 'rgba(255, 193, 7, 0.1)',
              tension: 0.1,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                label: function (context) {
                  const log = recentLogs[context.dataIndex];
                  return [
                    `${context.dataset.label}: ${context.parsed.y}`,
                    `Тип: ${log.type === 'both' ? 'Текущее и основное' :
                      log.type === 'current' ? 'Только текущее' : 'Только основное'}`,
                    `Ошибок: ${log.errors}`
                  ];
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Количество'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Дата'
              }
            }
          }
        }
      });
    }
  </script>
</body>

</html>

teacher_detailed_statistics.html
{% extends "base.html" %}

{% block title %}Детальная статистика преподавателей{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <h2>👨‍🏫 Детальная статистика преподавателей по группам</h2>

    {% if teacher_stats %}
    {% for teacher_name, groups in teacher_stats.items()|sort %}
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0">{{ teacher_name }}</h5>
      </div>
      <div class="card-body">
        {% for group_name, subjects in groups.items()|sort %}
        <div class="card mb-3">
          <div class="card-header bg-light">
            <h6 class="mb-0">Группа: {{ group_name }}</h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Предмет</th>
                    <th>Часов</th>
                    <th>Пар</th>
                    <th>Процент от общей нагрузки</th>
                  </tr>
                </thead>
                <tbody>
                  {% set teacher_total_hours = 0 %}
                  {% for group_subjects in groups.values() %}
                  {% for hours in group_subjects.values() %}
                  {% set teacher_total_hours = teacher_total_hours + hours %}
                  {% endfor %}
                  {% endfor %}

                  {% for subject_name, hours in subjects.items()|sort %}
                  <tr>
                    <td>{{ subject_name }}</td>
                    <td>{{ hours }}</td>
                    <td>{{ hours // 2 }}</td>
                    <td>
                      {% if teacher_total_hours > 0 %}
                      {{ "%.1f"|format((hours / teacher_total_hours * 100)) }}%
                      {% else %}
                      0%
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                  <tr class="table-primary">
                    <td><strong>Итого по группе {{ group_name }}:</strong></td>
                    <td><strong>{{ subjects.values()|sum }}</strong></td>
                    <td><strong>{{ subjects.values()|sum // 2 }}</strong></td>
                    <td><strong>
                        {% if teacher_total_hours > 0 %}
                        {{ "%.1f"|format((subjects.values()|sum / teacher_total_hours * 100)) }}%
                        {% else %}
                        0%
                        {% endif %}
                      </strong></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        {% endfor %}

        <!-- Общая статистика преподавателя -->
        <div class="card bg-success text-white">
          <div class="card-body">
            <h6 class="mb-0">Общая статистика преподавателя {{ teacher_name }}</h6>
            <div class="row mt-2">
              <div class="col-md-3">
                <strong>Всего часов:</strong> {{ teacher_total_hours }}
              </div>
              <div class="col-md-3">
                <strong>Всего пар:</strong> {{ teacher_total_hours // 2 }}
              </div>
              <div class="col-md-3">
                <strong>Групп:</strong> {{ groups.keys()|length }}
              </div>
              <div class="col-md-3">
                <strong>Предметов:</strong>
                {% set total_subjects = 0 %}
                {% for group_subjects in groups.values() %}
                {% set total_subjects = total_subjects + group_subjects.keys()|length %}
                {% endfor %}
                {{ total_subjects }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="alert alert-info">
      Нет данных для отображения детальной статистики преподавателей.
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

teacher_load.html
<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Нагрузка преподавателей</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .navbar-custom {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .teacher-card {
      border-left: 4px solid #007bff;
      padding: 15px;
      margin-bottom: 15px;
      background-color: white;
      border-radius: 4px;
    }

    .subject-badge {
      font-size: 0.8rem;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .progress {
      height: 10px;
    }
  </style>
</head>

<body>
  <!-- Навигация -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/admin">
        <i class="bi bi-arrow-left"></i> Нагрузка преподавателей
      </a>
      <div class="navbar-nav ms-auto">
        <span class="navbar-text me-3" id="userInfo">Загрузка...</span>
      </div>
    </div>
  </nav>

  <div class="container-fluid py-3">
    <!-- Общая статистика -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="totalTeachers">0</h3>
          <p class="text-muted mb-0">Преподавателей</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="totalSubjects">0</h3>
          <p class="text-muted mb-0">Предметов</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="totalLessons">0</h3>
          <p class="text-muted mb-0">Всего занятий</p>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card text-center">
          <h3 id="avgLoad">0</h3>
          <p class="text-muted mb-0">Средняя нагрузка</p>
        </div>
      </div>
    </div>

    <!-- Фильтры -->
    <div class="stat-card">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Фильтр по преподавателю:</label>
          <select class="form-select" id="teacherFilter" onchange="filterTeachers()">
            <option value="">Все преподаватели</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Фильтр по предмету:</label>
          <select class="form-select" id="subjectFilter" onchange="filterTeachers()">
            <option value="">Все предметы</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Сортировка:</label>
          <select class="form-select" id="sortBy" onchange="sortTeachers()">
            <option value="name">По имени</option>
            <option value="load_desc">По нагрузке (убыв.)</option>
            <option value="load_asc">По нагрузке (возр.)</option>
            <option value="subjects_desc">По предметам (убыв.)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Список преподавателей -->
    <div class="stat-card">
      <h5 class="mb-3"><i class="bi bi-people"></i> Нагрузка преподавателей</h5>
      <div id="teachersContainer">
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
          <p class="mt-3">Загрузка данных о нагрузке...</p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allTeachers = [];
    let allSubjects = [];
    let teacherLoadData = [];
    let filteredTeachers = [];

    // Загрузка при старте
    document.addEventListener('DOMContentLoaded', async function () {
      await checkAuth();
      await loadUserInfo();
      await loadInitialData();
      await loadTeacherLoad();
    });

    // Проверка авторизации
    async function checkAuth() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (!data.authenticated || data.role !== 'admin') {
          window.location.href = '/login';
          return false;
        }
        return true;
      } catch (error) {
        window.location.href = '/login';
        return false;
      }
    }

    // Загрузка информации о пользователе
    async function loadUserInfo() {
      try {
        const response = await fetch('/api/user_info');
        const data = await response.json();

        if (data.authenticated) {
          document.getElementById('userInfo').innerHTML = `
                        <i class="bi bi-person-circle"></i> ${data.username}
                    `;
        }
      } catch (error) {
        console.error('Ошибка загрузки информации о пользователе:', error);
      }
    }

    // Загрузка начальных данных
    async function loadInitialData() {
      try {
        // Загружаем преподавателей
        const teachersResponse = await fetch('/api/data/teachers');
        if (teachersResponse.ok) {
          allTeachers = await teachersResponse.json();
          updateTeacherFilter();
        }

        // Загружаем предметы
        const subjectsResponse = await fetch('/api/data/subjects');
        if (subjectsResponse.ok) {
          allSubjects = await subjectsResponse.json();
          updateSubjectFilter();
        }

      } catch (error) {
        console.error('Ошибка загрузки данных:', error);
      }
    }

    // Обновление фильтра преподавателей
    function updateTeacherFilter() {
      const teacherFilter = document.getElementById('teacherFilter');
      teacherFilter.innerHTML = '<option value="">Все преподаватели</option>';

      allTeachers.sort((a, b) => a.name.localeCompare(b.name)).forEach(teacher => {
        const option = document.createElement('option');
        option.value = teacher.id;
        option.textContent = teacher.name;
        teacherFilter.appendChild(option);
      });
    }

    // Обновление фильтра предметов
    function updateSubjectFilter() {
      const subjectFilter = document.getElementById('subjectFilter');
      subjectFilter.innerHTML = '<option value="">Все предметы</option>';

      allSubjects.sort((a, b) => a.name.localeCompare(b.name)).forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        subjectFilter.appendChild(option);
      });
    }

    // Загрузка данных о нагрузке
    async function loadTeacherLoad() {
      try {
        // Загружаем текущее расписание для подсчета нагрузки
        const response = await fetch('/api/schedule/current?week=1&semester=1');
        if (!response.ok) {
          throw new Error('Ошибка загрузки расписания');
        }

        const schedule = await response.json();
        processTeacherLoad(schedule);

      } catch (error) {
        console.error('Ошибка:', error);
        document.getElementById('teachersContainer').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка загрузки данных: ${error.message}
                    </div>
                `;
      }
    }

    // Обработка данных о нагрузке
    function processTeacherLoad(schedule) {
      // Группируем занятия по преподавателям
      const teacherMap = new Map();

      schedule.forEach(lesson => {
        if (!teacherMap.has(lesson.teacher)) {
          teacherMap.set(lesson.teacher, {
            name: lesson.teacher,
            lessons: [],
            subjects: new Set(),
            groups: new Set()
          });
        }

        const teacherData = teacherMap.get(lesson.teacher);
        teacherData.lessons.push(lesson);
        teacherData.subjects.add(lesson.subject);
        teacherData.groups.add(lesson.group);
      });

      // Преобразуем в массив
      teacherLoadData = Array.from(teacherMap.values()).map(teacher => ({
        name: teacher.name,
        totalLessons: teacher.lessons.length,
        totalSubjects: teacher.subjects.size,
        totalGroups: teacher.groups.size,
        subjects: Array.from(teacher.subjects),
        groups: Array.from(teacher.groups)
      }));

      // Обновляем общую статистику
      updateTotalStats(teacherLoadData);

      // Отображаем преподавателей
      filteredTeachers = [...teacherLoadData];
      renderTeachers();
    }

    // Обновление общей статистики
    function updateTotalStats(teachers) {
      document.getElementById('totalTeachers').textContent = teachers.length;

      const allSubjectsSet = new Set();
      teachers.forEach(teacher => {
        teacher.subjects.forEach(subject => allSubjectsSet.add(subject));
      });
      document.getElementById('totalSubjects').textContent = allSubjectsSet.size;

      const totalLessons = teachers.reduce((sum, teacher) => sum + teacher.totalLessons, 0);
      document.getElementById('totalLessons').textContent = totalLessons;

      const avgLoad = teachers.length > 0 ? Math.round(totalLessons / teachers.length) : 0;
      document.getElementById('avgLoad').textContent = avgLoad;
    }

    // Отображение преподавателей
    function renderTeachers() {
      const container = document.getElementById('teachersContainer');

      if (filteredTeachers.length === 0) {
        container.innerHTML = `
                    <div class="alert alert-info">
                        Нет данных для отображения
                    </div>
                `;
        return;
      }

      let html = '';
      filteredTeachers.forEach(teacher => {
        // Определяем цвет карточки в зависимости от нагрузки
        let borderColor = '#007bff'; // По умолчанию синий
        if (teacher.totalLessons > 20) {
          borderColor = '#dc3545'; // Красный для высокой нагрузки
        } else if (teacher.totalLessons > 15) {
          borderColor = '#ffc107'; // Желтый для средней нагрузки
        }

        html += `
                    <div class="teacher-card" style="border-left-color: ${borderColor}">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="mb-2">
                                    <strong>${teacher.name}</strong>
                                    <span class="badge bg-primary ms-2">${teacher.totalLessons} занятий</span>
                                </h6>
                                <div class="mb-2">
                                    <small class="text-muted">
                                        <i class="bi bi-book"></i> ${teacher.totalSubjects} предметов | 
                                        <i class="bi bi-people"></i> ${teacher.totalGroups} групп
                                    </small>
                                </div>
                                <div class="mb-2">
                                    ${teacher.subjects.map(subject => `
                                        <span class="badge subject-badge bg-info">${subject}</span>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-end">
                                    <div class="mb-2">
                                        <small class="text-muted">Нагрузка:</small>
                                        <div class="progress">
                                            <div class="progress-bar ${teacher.totalLessons > 20 ? 'bg-danger' : teacher.totalLessons > 15 ? 'bg-warning' : 'bg-success'}" 
                                                 role="progressbar" 
                                                 style="width: ${Math.min(teacher.totalLessons * 5, 100)}%">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-muted small">
                                        ${teacher.totalLessons} занятий в неделю
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
      });

      container.innerHTML = html;
    }

    // Фильтрация преподавателей
    function filterTeachers() {
      const teacherId = document.getElementById('teacherFilter').value;
      const subjectId = document.getElementById('subjectFilter').value;
      const subjectName = subjectId ? allSubjects.find(s => s.id == subjectId)?.name : '';

      if (!teacherId && !subjectId) {
        filteredTeachers = [...teacherLoadData];
      } else {
        filteredTeachers = teacherLoadData.filter(teacher => {
          const matchesTeacher = !teacherId || teacher.name.includes(
            allTeachers.find(t => t.id == teacherId)?.name || ''
          );
          const matchesSubject = !subjectId || teacher.subjects.includes(subjectName);
          return matchesTeacher && matchesSubject;
        });
      }

      sortTeachers();
    }

    // Сортировка преподавателей
    function sortTeachers() {
      const sortBy = document.getElementById('sortBy').value;

      filteredTeachers.sort((a, b) => {
        switch (sortBy) {
          case 'name':
            return a.name.localeCompare(b.name);
          case 'load_desc':
            return b.totalLessons - a.totalLessons;
          case 'load_asc':
            return a.totalLessons - b.totalLessons;
          case 'subjects_desc':
            return b.totalSubjects - a.totalSubjects;
          default:
            return 0;
        }
      });

      renderTeachers();
    }
  </script>
</body>

</html>

template_schedule.html 
{% extends "base.html" %}

{% block title %}Основное расписание{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-md-12">
    <h2><i class="bi bi-calendar-event"></i> Основное (шаблонное) расписание</h2>
    <p class="text-muted">Семестр: {{ current_semester }}</p>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Фильтры</h5>
      </div>
      <div class="card-body">
        <form method="get" class="row g-3">
          <div class="col-md-3">
            <label class="form-label">День недели:</label>
            <select name="day" class="form-select" onchange="this.form.submit()">
              {% for day in days %}
              <option value="{{ day }}" {% if day==selected_day %}selected{% endif %}>{{ day }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Тип недели:</label>
            <select name="week_type" class="form-select" onchange="this.form.submit()">
              {% for wt in week_types %}
              <option value="{{ wt }}" {% if wt==week_type %}selected{% endif %}>
                {{ wt == 'all' and 'Все недели' or (wt == 'odd' and 'Нечетные' or 'Четные') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Семестр:</label>
            <select name="semester" class="form-select" onchange="this.form.submit()">
              <option value="1" {% if current_semester==1 %}selected{% endif %}>1 семестр</option>
              <option value="2" {% if current_semester==2 %}selected{% endif %}>2 семестр</option>
            </select>
          </div>
          <div class="col-md-3">
            <div class="d-flex align-items-end h-100">
              <a href="{{ url_for('export_schedule', type='template', semester=current_semester) }}"
                class="btn btn-outline-success w-100">
                <i class="bi bi-download"></i> Экспорт
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if schedule_data %}
{% set courses = {} %}
{% for group_name in groups %}
{% set course = group_name[0] %}
{% if course not in courses %}
{% set _ = courses.update({course: []}) %}
{% endif %}
{% set _ = courses[course].append(group_name) %}
{% endfor %}

{% for course_num, course_groups in courses.items()|sort %}
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">{{ course_num }} курс</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th style="width: 80px;">Пара</th>
            <th style="width: 120px;">Время</th>
            {% for group_name in course_groups|sort %}
            <th>{{ group_name }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% set max_lesson = 12 %}
          {% if selected_day in ['Понедельник', 'Четверг'] %}
          {% set max_lesson = 13 %}
          {% elif selected_day == 'Суббота' %}
          {% set max_lesson = 8 %}
          {% endif %}

          {% for lesson_num in range(0, max_lesson) %}
          {% if selected_day in ['Понедельник', 'Четверг'] or lesson_num != 0 %}
          <tr>
            <td class="text-center fw-bold">
              {{ lesson_num }}
            </td>
            <td class="text-center small">
              {{ lesson_num|lesson_time(selected_day) }}
              {% if lesson_num|break_time(selected_day) %}
              <br><span class="text-muted">({{ lesson_num|break_time(selected_day) }})</span>
              {% endif %}
            </td>
            {% for group_name in course_groups|sort %}
            <td
              class="{% if schedule_data.get(group_name, {}).get(lesson_num, {}).get('week_type') != 'all' %}template{% endif %}">
              {% if group_name in schedule_data and lesson_num in schedule_data[group_name] %}
              <div class="lesson-entry">
                <div class="fw-bold text-primary">
                  {{ schedule_data[group_name][lesson_num].subject }}
                  {% if schedule_data[group_name][lesson_num].week_type != 'all' %}
                  <span class="badge badge-template badge-sm">
                    {{ schedule_data[group_name][lesson_num].week_type == 'odd' and 'неч' or 'чет' }}
                  </span>
                  {% endif %}
                </div>
                <div class="small">{{ schedule_data[group_name][lesson_num].teacher }}</div>
                <div class="small text-muted">ауд. {{ schedule_data[group_name][lesson_num].room }}</div>
              </div>
              {% endif %}
            </td>
            {% endfor %}
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endfor %}
{% else %}
<div class="alert alert-info">
  На {{ selected_day }} занятий не найдено в шаблонном расписании.
</div>
{% endif %}

<div class="row mt-3">
  <div class="col-md-12">
    <div class="alert alert-secondary">
      <h6><i class="bi bi-info-circle"></i> Легенда:</h6>
      <div class="row">
        <div class="col-md-4">
          <span class="badge badge-template">неч</span> - только для нечетных недель
        </div>
        <div class="col-md-4">
          <span class="badge badge-template">чет</span> - только для четных недель
        </div>
        <div class="col-md-4">
          * Голубым цветом выделены занятия для определенных недель
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}