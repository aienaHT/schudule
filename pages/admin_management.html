{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ —Å–∏—Å—Ç–µ–º—ã</h2>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-3">
            <a href="#subjects" class="btn btn-outline-primary w-100">üìö –ü—Ä–µ–¥–º–µ—Ç—ã</a>
          </div>
          <div class="col-md-3">
            <a href="#groups" class="btn btn-outline-info w-100">üë• –ì—Ä—É–ø–ø—ã</a>
          </div>
          <div class="col-md-3">
            <a href="#teacher-rooms" class="btn btn-outline-success w-100">üè´ –ö–∞–±–∏–Ω–µ—Ç—ã</a>
          </div>
          <div class="col-md-3">
            <a href="#group-subjects" class="btn btn-outline-warning w-100">üìä –ù–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø</a>
          </div>
        </div>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ -->
    <div id="subjects" class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">üìö –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏</h5>
      </div>
      <div class="card-body">
        <form id="addSubjectForm" class="row g-3 mb-4">
          <div class="col-md-8">
            <input type="text" class="form-control" id="subjectName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞" required>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="subjectsTable">
              {% for subject in subjects %}
              <tr id="subject-{{ subject.id }}">
                <td>{{ subject.id }}</td>
                <td>{{ subject.name }}</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-subject" data-id="{{ subject.id }}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ -->
    <div id="groups" class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏</h5>
      </div>
      <div class="card-body">
        <form id="addGroupForm" class="row g-3 mb-4">
          <div class="col-md-6">
            <input type="text" class="form-control" id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1–ê)"
              required>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="groupCourse" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
              <option value="1">1 –∫—É—Ä—Å</option>
              <option value="2">2 –∫—É—Ä—Å</option>
              <option value="3">3 –∫—É—Ä—Å</option>
              <option value="4">4 –∫—É—Ä—Å</option>
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-success w-100">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
                <th>–ö—É—Ä—Å</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="groupsTable">
              {% for group in groups %}
              <tr id="group-{{ group.id }}">
                <td>{{ group.id }}</td>
                <td>{{ group.name }}</td>
                <td>{{ group.course }} –∫—É—Ä—Å</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-group" data-id="{{ group.id }}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∑–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏ -->
    <div id="teacher-rooms" class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">üè´ –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤</h5>
      </div>
      <div class="card-body">
        <form id="assignRoomForm" class="row g-3 mb-4">
          <div class="col-md-4">
            <select class="form-select" id="teacherSelect" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è</option>
              {% for teacher in teachers %}
              <option value="{{ teacher.id }}">{{ teacher.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <select class="form-select" id="roomSelect" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–±–∏–Ω–µ—Ç</option>
              {% for room in rooms %}
              <option value="{{ room.id }}">{{ room.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-success w-100">üîó –ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</th>
                <th>–ö–∞–±–∏–Ω–µ—Ç</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="teacherRoomsTable">
              {% for assignment in teacher_rooms %}
              <tr id="assignment-{{ assignment.id }}">
                <td>{{ assignment.teacher.name }}</td>
                <td>{{ assignment.room.name }}</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-assignment" data-id="{{ assignment.id }}">üóëÔ∏è
                    –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –ù–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º -->
    <div id="group-subjects" class="card">
      <div class="card-header">
        <h5 class="mb-0">üìä –ù–∞–≥—Ä—É–∑–∫–∞ –≥—Ä—É–ø–ø –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h5>
      </div>
      <div class="card-body">
        <form id="assignGroupSubjectForm" class="row g-3 mb-4">
          <div class="col-md-3">
            <select class="form-select" id="groupSelect" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
              {% for group in groups %}
              <option value="{{ group.id }}">{{ group.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <select class="form-select" id="subjectSelectLoad" required>
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
              {% for subject in subjects %}
              <option value="{{ subject.id }}">{{ subject.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <input type="number" class="form-control" id="hoursPerWeek" placeholder="–ß–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é" min="0" max="20"
              required>
          </div>
          <div class="col-md-3">
            <button type="submit" class="btn btn-success w-100">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>–ì—Ä—É–ø–ø–∞</th>
                <th>–ü—Ä–µ–¥–º–µ—Ç</th>
                <th>–ß–∞—Å–æ–≤ –≤ –Ω–µ–¥–µ–ª—é</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="groupSubjectsTable">
              {% for load in group_subject_loads %}
              <tr id="load-{{ load.id }}">
                <td>{{ load.group.name }}</td>
                <td>{{ load.subject.name }}</td>
                <td>{{ load.hours_per_week }}</td>
                <td>
                  <button class="btn btn-sm btn-danger delete-load" data-id="{{ load.id }}">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
  document.getElementById('addSubjectForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const name = document.getElementById('subjectName').value;

    fetch('/api/add_subject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      });
  });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
  document.getElementById('addGroupForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const name = document.getElementById('groupName').value;
    const course = document.getElementById('groupCourse').value;

    fetch('/api/add_group', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name, course: course })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      });
  });

  // –ó–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–∞
  document.getElementById('assignRoomForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const teacher_id = document.getElementById('teacherSelect').value;
    const room_id = document.getElementById('roomSelect').value;

    fetch('/api/assign_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ teacher_id: teacher_id, room_id: room_id })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      });
  });

  // –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø–µ
  document.getElementById('assignGroupSubjectForm').addEventListener('submit', function (e) {
    e.preventDefault();
    const group_id = document.getElementById('groupSelect').value;
    const subject_id = document.getElementById('subjectSelectLoad').value;
    const hours_per_week = document.getElementById('hoursPerWeek').value;

    fetch('/api/assign_group_subject', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        group_id: group_id,
        subject_id: subject_id,
        hours_per_week: hours_per_week
      })
    })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        } else {
          alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
      });
  });

  // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  document.addEventListener('click', function (e) {
    if (e.target.classList.contains('delete-subject')) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_subject/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('–û—à–∏–±–∫–∞: ' + data.message);
          });
      }
    }

    if (e.target.classList.contains('delete-group')) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_group/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('–û—à–∏–±–∫–∞: ' + data.message);
          });
      }
    }

    if (e.target.classList.contains('delete-assignment')) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_room_assignment/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('–û—à–∏–±–∫–∞: ' + data.message);
          });
      }
    }

    if (e.target.classList.contains('delete-load')) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É?')) {
        const id = e.target.getAttribute('data-id');
        fetch(`/api/delete_group_subject/${id}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) location.reload();
            else alert('–û—à–∏–±–∫–∞: ' + data.message);
          });
      }
    }
  });
</script>
{% endblock %}